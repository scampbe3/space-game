import{M as ga,C as ls,F as $o,G as Un,B as bn,V as n,a as Vs,S as no,b as cn,A as _s,c as tn,d as xe,e as Mn,Q as Rt,f as ss,g as oa,h as Xn,i as Rr,j as To,O as so,W as ya,k as Yi,l as Ls,m as zi,D as ms,P as Cr,n as zr,o as Vn,I as yl,R as Io,p as Li,q as wl,r as bl,s as Dl,T as Po,t as wa,u as Ka,v as $a,w as Lr,x as ba,y as kr,z as Ir,E as zo,H as Ro,J as Ja,L as Br,K as er,N as mi,U as Ns,X as vl,Y as xl,Z as tr,_ as nr,$ as Ml,a0 as _l,a1 as Sl,a2 as sr,a3 as El,a4 as Pl,a5 as Al,a6 as Tl,a7 as Rl,a8 as Cl,a9 as zl}from"./three-780719bb.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))l(a);new MutationObserver(a=>{for(const y of a)if(y.type==="childList")for(const i of y.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&l(i)}).observe(document,{childList:!0,subtree:!0});function o(a){const y={};return a.integrity&&(y.integrity=a.integrity),a.referrerPolicy&&(y.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?y.credentials="include":a.crossOrigin==="anonymous"?y.credentials="omit":y.credentials="same-origin",y}function l(a){if(a.ep)return;a.ep=!0;const y=o(a);fetch(a.href,y)}})();const Or=typeof document>"u"||typeof window>"u"||globalThis.__IS_RENDER_WORKER;let hs=10,Gs=0,to=0,Cn={fraction:1,active:!1,recharging:!1,mode:"boost"},Bo=null,Oo=null;const ia=Or&&typeof(self==null?void 0:self.postMessage)=="function"?()=>self.postMessage({type:"hud",state:{score:Gs,hearts:hs,bombs:to,meter:Cn,boss:Bo,bossAlt:Oo}}):null,Ll=1e3/20,Wr=.002;let kn=null,aa=0,oo=()=>{},ki=()=>{},Jo=()=>{};if(Or)oo=()=>{},ki=()=>{},Jo=()=>{};else{const e=document.getElementById("hud"),t=typeof window<"u"&&(window.__EDITOR__||new URLSearchParams(window.location.search).has("editor"));if(!e||t)e&&(e.style.display="none");else{e.style.display="flex",e.style.flexDirection="column",e.style.gap="4px",e.innerHTML="";let o="",l="",a=null,y="",i=null;const u={lastFraction:null,lastVisible:null},S={lastFraction:null,lastVisible:null},w=document.createElement("div");w.style.font="14px monospace",w.style.color="#0f0",e.appendChild(w);const Z=document.createElement("div");Object.assign(Z.style,{display:"flex",alignItems:"center",gap:"12px"});const d=document.createElement("div");Object.assign(d.style,{display:"flex",alignItems:"center",gap:"6px"});const E=document.createElement("div");Object.assign(E.style,{width:"20px",height:"20px",borderRadius:"50%",background:"#081a33",border:"2px solid #d01f1f",color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",font:"12px monospace",lineHeight:"1"}),E.textContent="B";const f=document.createElement("div");Object.assign(f.style,{font:"12px monospace",color:"#0f0",letterSpacing:"0.04em"}),d.appendChild(E),d.appendChild(f);const D=document.createElement("div");Object.assign(D.style,{position:"relative",width:"140px",height:"10px",background:"rgba(0,0,0,0.35)",border:"1px solid #0f0",borderRadius:"2px",overflow:"hidden",opacity:"0",transition:"opacity 0.25s ease"});const W=document.createElement("div");Object.assign(W.style,{position:"absolute",left:0,top:0,bottom:0,width:"100%",background:"#00a9ff",transformOrigin:"left center",transform:"scaleX(1)",willChange:"transform",transition:"transform 0.05s linear, background 0.1s ease"}),D.appendChild(W),Z.appendChild(d),Z.appendChild(D),e.appendChild(Z);const L=()=>{const M=document.createElement("div");Object.assign(M.style,{position:"fixed",top:"8px",left:"50%",transform:"translateX(-50%)",width:"60vw",maxWidth:"640px",height:"12px",background:"rgba(0,0,0,0.35)",border:"1px solid #0f0",borderRadius:"2px",overflow:"hidden",opacity:"0",transition:"opacity 0.2s ease",pointerEvents:"none",zIndex:9999});const ie=document.createElement("div");return Object.assign(ie.style,{position:"absolute",left:0,top:0,bottom:0,width:"100%",background:"#0f0",transformOrigin:"left center",transform:"scaleX(1)",willChange:"transform",transition:"transform 0.05s linear"}),M.appendChild(ie),document.body.appendChild(M),{bossWrap:M,bossFill:ie}},x=L(),N=L();oo=()=>{const M=`SCORE ${Gs}  ${"â™¥".repeat(hs)}`,ie=`x ${to}`;M!==o&&(o=M,w.textContent=M),ie!==l&&(l=ie,f.textContent=ie)},ki=()=>{const M=Math.max(0,Math.min(1,Cn.fraction)),ie=Cn.recharging?"#00ff99":Cn.mode==="brake"?"#f8a300":"#00a9ff";(a===null||Math.abs(M-a)>.001)&&(W.style.transform=`scaleX(${M})`,a=M),ie!==y&&(W.style.background=ie,y=ie);const P=Cn.active||Cn.recharging||M<.999;P!==i&&(D.style.opacity=P?"1":"0",i=P)};const $=(M,ie,P)=>{if(ie==null){P.lastVisible!==!1&&(M.bossWrap.style.opacity="0",P.lastVisible=!1),P.lastFraction=null;return}const V=Math.max(0,Math.min(1,ie));P.lastVisible!==!0&&(M.bossWrap.style.opacity="1",P.lastVisible=!0),(P.lastFraction===null||Math.abs(V-P.lastFraction)>.001)&&(M.bossFill.style.transform=`scaleX(${V})`,P.lastFraction=V)};Jo=()=>{$(x,Bo,u),$(N,Oo,S)}}}function vo(){if(!ia)return;const e=typeof Cn.fraction=="number"?Cn.fraction:0,t=!!Cn.active,o=!!Cn.recharging,l=Cn.mode??"boost",a=Bo,y=Oo,i=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now();if(!kn){kn={score:Gs,hearts:hs,bombs:to,boss:a,bossAlt:y,meterFraction:e,meterActive:t,meterRecharging:o,meterMode:l},aa=i,ia();return}const u=Gs!==kn.score,S=hs!==kn.hearts,w=to!==kn.bombs,Z=!Object.is(a,kn.boss),d=!Object.is(y,kn.bossAlt),E=Math.abs(e-kn.meterFraction)>Wr,f=t!==kn.meterActive,D=o!==kn.meterRecharging,W=l!==kn.meterMode;!u&&!S&&!w&&!Z&&!d&&(!(E||f||D||W)||i-aa<Ll)||(kn.score=Gs,kn.hearts=hs,kn.bombs=to,kn.boss=a,kn.bossAlt=y,kn.meterFraction=e,kn.meterActive=t,kn.meterRecharging=o,kn.meterMode=l,aa=i,ia())}oo();function Ao(e=10){Gs+=e,oo(),vo()}function kl(){return hs=Math.max(0,hs-1),oo(),vo(),hs}function Il(e=1){hs=Math.max(0,hs+e),oo(),vo()}function jo(){return Gs}function ra(e=0){to=Math.max(0,Math.floor(e)),oo(),vo()}function Bl(e=1,{active:t=!1,recharging:o=!1,mode:l="boost"}={}){Cn={fraction:Math.max(0,Math.min(1,e)),active:t,recharging:o,mode:l},ki(),vo()}function Ii(e=null){Bo=e==null?null:Math.max(0,Math.min(1,e)),Jo(),vo()}function qo(e=null){Oo=e==null?null:Math.max(0,Math.min(1,e)),Jo(),vo()}function Ol(e={}){let t=!1,o=!1,l=!1,a=!1,y=!1;if(typeof e.score=="number"&&e.score!==Gs&&(Gs=e.score,t=!0),typeof e.hearts=="number"&&e.hearts!==hs&&(hs=e.hearts,t=!0),typeof e.bombs=="number"&&e.bombs!==to&&(to=e.bombs,o=!0),e.meter){const i=Math.max(0,Math.min(1,e.meter.fraction??Cn.fraction)),u=!!(e.meter.active??Cn.active),S=!!(e.meter.recharging??Cn.recharging),w=e.meter.mode??Cn.mode,Z=typeof Cn.fraction=="number"?Cn.fraction:0,d=!!Cn.active,E=!!Cn.recharging,f=Cn.mode??"boost";l=Math.abs(i-Z)>Wr||u!==d||S!==E||w!==f,l&&(Cn={fraction:i,active:u,recharging:S,mode:w})}if(e.boss!==void 0){const i=e.boss===null||e.boss===void 0?null:Math.max(0,Math.min(1,e.boss));a=!Object.is(i,Bo),a&&(Bo=i)}if(e.bossAlt!==void 0){const i=e.bossAlt===null||e.bossAlt===void 0?null:Math.max(0,Math.min(1,e.bossAlt));y=!Object.is(i,Oo),y&&(Oo=i)}(t||o)&&oo(),l&&ki(),(a||y)&&Jo()}function cs(e){if(!e)return e;if(Array.isArray(e))return e.map(cs);const t=new ga({color:e.color?e.color.clone():new ls(16777215),map:e.map??null,emissive:e.emissive?e.emissive.clone():new ls(0),emissiveMap:e.emissiveMap??null,emissiveIntensity:e.emissiveIntensity??1,transparent:e.transparent??!1,opacity:e.opacity??1,alphaTest:e.alphaTest??0,side:e.side??$o,depthWrite:e.depthWrite??!0,depthTest:e.depthTest??!0,fog:e.fog??!0});return e.vertexColors!==void 0&&(t.vertexColors=e.vertexColors),e.skinning!==void 0&&(t.skinning=e.skinning),e.morphTargets!==void 0&&(t.morphTargets=e.morphTargets),e.morphNormals!==void 0&&(t.morphNormals=e.morphNormals),t}async function Wl(e,{modelPath:t,eyesPath:o="./models/boss_eyes.glb",rig:l,boltPool:a,playerObj:y,railSpeed:i=35,summonWave:u=()=>{},materialMode:S="standard"}={}){const w=r=>{r&&r.traverse(T=>{!T.isMesh||!T.geometry||(T.geometry.boundingBox||T.geometry.computeBoundingBox(),T.geometry.boundingSphere||T.geometry.computeBoundingSphere())})},Z=new Un,d=(await Z.loadAsync(t)).scene;d.scale.setScalar(14),d.visible=!1,l.add(d);const E=120;let f=E,D=0;const W=[],L=[];let x=null,N=-1,$=0;const M=[.07,-.05,.07,-.05],ie=new bn,P=new n,V=new n,k=new Vs,R=new no,g=S==="lambert";d.traverse(r=>{r.isMesh&&(r.material=g?cs(r.material):r.material.clone(),W.push(r))});function B(r,T,I,he){r.forEach(de=>de.material.emissive&&de.material.emissive.setRGB(T,I,he))}function me(){D=.15,B(W,1,0,0)}function U(r){L.length&&B(L,r?1:0,0,0)}function H(){x&&(N=0,$=Math.abs(M[0]),U(!0))}function C(r){if(N<0||($-=r,$>0))return;if(N+=1,N>=M.length){U(!1),N=-1;return}const T=M[N];U(T>0),$=Math.abs(T)}if(d.userData.enemy=!0,d.userData.enemyRoot=!0,d.userData.hp=E,d.userData.dead=!1,d.userData.blink=me,d.userData.meshes=W,d.userData.androssPart="head",d.userData.scoreValue=5e3,d.userData.largeExplosion=!0,d.userData.damageFn=(r=1)=>yt(r),d.userData.hitRadius=12,d.userData.blastRadius=14,d.userData.chargeRadius=14,w(d),o)try{x=(await Z.loadAsync(o)).scene}catch(r){console.warn("[boss-head] eyes load failed:",r)}if(x){x.traverse(T=>{T.isMesh&&(T.material=g?cs(T.material):T.material.clone(),L.push(T))}),d.add(x),w(x),d.updateWorldMatrix(!0,!0),x.updateWorldMatrix(!0,!0);let r=2;if(ie.setFromObject(x),!ie.isEmpty()){const T=ie.clone().applyMatrix4(k.copy(x.matrixWorld).invert());T.getCenter(V),T.getSize(P),T.expandByScalar(.11),T.getBoundingSphere(R),r=R.center.length()+R.radius+.19,x.userData.hitBoxes=[T]}x.userData.enemy=!0,x.userData.enemyRoot=!0,x.userData.androssPart="eyes",x.userData.androssOwner=d,x.userData.meshes=L,x.userData.blink=H,x.userData.scoreValue=d.userData.scoreValue,x.userData.largeExplosion=!0,x.userData.damageFn=(T=1)=>Ke(T),x.userData.hitRadius=r,x.userData.blastRadius=d.userData.blastRadius,x.userData.chargeRadius=r}let c=Math.random()*Math.PI*2,Y=3,q=!1,se=0,ne=!1;const fe=new n,De=new n,Me=new Rt,ge=new Rt,Ae=new n(0,0,1),ye=new n,pe=[],Ee=[];for(let r=0;r<24;r++)Ee.push({t:0,pos:new n});const X={t:0,pos:new n},et=new n,A=new n,ke=new n,Qe=new n,Oe=new n,Fe=new n(0,0,-1);let qt=0,Gt=0;const vt=[{maxRatio:.33,swayRadius:14.5,yAmp:7.5,yFreq:.65,baseYFlow:1.4,speedBase:5.4,speedRange:1.2,speedLerp:.3,changeMin:2,changeMax:3},{maxRatio:.66,swayRadius:10.875,yAmp:5.625,yFreq:.4875,baseYFlow:1.05,speedBase:4.05,speedRange:.9,speedLerp:.3,changeMin:2,changeMax:3},{maxRatio:1,swayRadius:7.25,yAmp:3.75,yFreq:.325,baseYFlow:.7,speedBase:2.7,speedRange:.6,speedLerp:.3,changeMin:2,changeMax:3}],_t=r=>vt.find(T=>r<=T.maxRatio)??vt[vt.length-1];let Ct=Math.PI/4,bt=.8,Kt=.8,Bt=0;const $t=new n(3,0,0),Zt=new n(-3,0,0),Ft=new n,Ue=new n;let wt=!1;const tt=new cn({color:65535,transparent:!0,opacity:.35,blending:_s,depthWrite:!1}),J=80,Ce=new tn(.8,.8,J);Ce.translate(0,0,J*.5);const ve=new xe(Ce,tt.clone()),_e=new xe(Ce,tt.clone());ve.visible=_e.visible=!1,e.add(ve,_e);function Ie(){q=!0,se=0,ve.visible=_e.visible=!0}function Ze(){q=!1,ve.visible=_e.visible=!1}function gt(r){if(!q)return;se+=r,d.updateMatrixWorld(!0);const T=d.getWorldPosition(et);Ft.copy($t).applyQuaternion(d.quaternion).add(T),Ue.copy(Zt).applyQuaternion(d.quaternion).add(T),A.set(ye.x,ye.y,Gt),ke.copy(A).sub(Ft);const I=ke.lengthSq()>1e-6?ke.normalize():Fe;Me.setFromUnitVectors(Ae,I),ve.position.copy(Ft),ve.quaternion.copy(Me),Qe.copy(A).sub(Ue);const he=Qe.lengthSq()>1e-6?Qe.normalize():Fe;Me.setFromUnitVectors(Ae,he),_e.position.copy(Ue),_e.quaternion.copy(Me),se>=3&&Ze()}function ct(r,T,I=!0,he=!1){if(!d.visible||d.userData.dead||he)return;if(D>0){D=Math.max(0,D-r);const p=D>0?1:0;B(W,p,0,0)}C(r),c+=r*.6;const de=Math.max(0,Math.min(1,f/E)),oe=_t(de),at=8+Math.sin(c)*oe.baseYFlow;Bt-=r,Bt<=0&&(Kt=oe.speedBase+Math.random()*oe.speedRange,Bt=oe.changeMin+Math.random()*(oe.changeMax-oe.changeMin)),bt+=(Kt-bt)*oe.speedLerp*r,Ct+=bt*r,d.position.x=Math.cos(Ct)*oe.swayRadius,d.position.y=at+Math.sin(Ct*oe.yFreq)*oe.yAmp,d.position.z=0;const nt=d.getWorldPosition(De),dt=y.getWorldPosition(fe);wt||(ye.set(dt.x,dt.y,0),wt=!0),qt+=r,Gt=dt.z;const ue=Ee.pop()??{t:0,pos:new n};ue.t=qt,ue.pos.set(dt.x,dt.y,0),pe.push(ue);const St=qt-.1;for(;pe.length&&pe[0].t<St-.1;){const p=pe.shift();p&&Ee.push(p)}let Et=pe[0]??X;Et===X&&(X.t=qt,X.pos.set(dt.x,dt.y,0));let Lt=pe[pe.length-1]??Et;for(let p=0;p<pe.length-1;p++){const h=pe[p],m=pe[p+1];if(h.t<=St&&m.t>=St){Et=h,Lt=m;break}}const te=Math.max(1e-5,Lt.t-Et.t),we=Mn.clamp((St-Et.t)/te,0,1);ye.copy(Et.pos).lerp(Lt.pos,we),ye.z=Gt,Oe.copy(ye).sub(nt),Oe.lengthSq()>1e-6&&(Oe.normalize(),ge.setFromUnitVectors(Ae,Oe),d.quaternion.slerp(ge,.25),d.updateMatrixWorld(!0)),!I&&q&&Ze(),I&&(Y-=r,Y<=0&&!q&&!ne&&(Ie(),Y=5+Math.random()*3)),I&&gt(r)}function yt(r=1,{full:T=!1,blinkHead:I=!0}={}){if(d.userData.dead)return!1;const he=T?r:r*.5;return f=Math.max(0,f-he),d.userData.hp=f,I&&me(),Ii(f/E),f===0?(d.userData.dead=!0,d.visible=!1,Ze(),U(!1),N=-1,Ii(null),!0):!1}function Ke(r=1){return H(),yt(r,{full:!0,blinkHead:!1})}return{update:ct,damage:yt,damageEyes:Ke,isAlive:()=>!d.userData.dead,getMesh:()=>d,getEyes:()=>x,getHP:()=>f,startEyeSweep:Ie,handleLaserHit:(r=1)=>yt(r),getActiveBeams:()=>[ve,_e],getHpRatio:()=>f/E}}async function or(e,{modelPath:t,palmPath:o=null,rig:l,side:a="left",boltPool:y,playerObj:i,railSpeed:u=35,headMesh:S=null,getHeadHpRatio:w=()=>1,materialMode:Z="standard"}={}){const d=de=>{de&&de.traverse(oe=>{!oe.isMesh||!oe.geometry||(oe.geometry.boundingBox||oe.geometry.computeBoundingBox(),oe.geometry.boundingSphere||oe.geometry.computeBoundingSphere())})},E=new Un,f=(await E.loadAsync(t)).scene;f.scale.setScalar(12),f.visible=!1,l.add(f);const D=40;let W=D,L=0,x=null;const N=[];let $=-1,M=0;const ie=[.07,-.05,.07,-.05],P=new bn,V=new n,k=new n,R=new Vs,g=new no;let B=!1;const me=Z==="lambert",U=[];f.traverse(de=>{de.isMesh&&(de.material=me?cs(de.material):de.material.clone(),U.push(de))});function H(de,oe,at,nt){de.forEach(dt=>dt.material.emissive&&dt.material.emissive.setRGB(oe,at,nt))}function C(){L=.15,H(U,1,0,0)}function c(de){N.length&&H(N,de?1:0,0,0)}function Y(){x&&($=0,M=Math.abs(ie[0]),c(!0))}function q(de){if($<0||(M-=de,M>0))return;if($+=1,$>=ie.length){c(!1),$=-1;return}const oe=ie[$];c(oe>0),M=Math.abs(oe)}if(f.userData.enemy=!0,f.userData.enemyRoot=!0,f.userData.hp=D,f.userData.dead=!1,f.userData.blink=C,f.userData.meshes=U,f.userData.androssPart=a==="left"?"handL":"handR",f.userData.scoreValue=500,f.userData.largeExplosion=!0,f.userData.damageFn=(de=1)=>Ke(de),f.userData.hitRadius=8,f.userData.blastRadius=10,f.userData.chargeRadius=10,d(f),o)try{x=(await E.loadAsync(o)).scene}catch(de){console.warn("[boss-hand] palm load failed:",de)}if(x){x.traverse(oe=>{oe.isMesh&&(oe.material=me?cs(oe.material):oe.material.clone(),N.push(oe))}),f.add(x),d(x),f.updateWorldMatrix(!0,!0),x.updateWorldMatrix(!0,!0);let de=2;if(P.setFromObject(x),!P.isEmpty()){const oe=P.clone().applyMatrix4(R.copy(x.matrixWorld).invert());oe.getCenter(k),oe.getSize(V),oe.expandByScalar(.3),oe.getBoundingSphere(g),de=g.center.length()+g.radius+.5,x.userData.hitBoxes=[oe]}x.userData.enemy=!0,x.userData.enemyRoot=!0,x.userData.androssPart=a==="left"?"palmL":"palmR",x.userData.androssOwner=f,x.userData.meshes=N,x.userData.blink=Y,x.userData.scoreValue=f.userData.scoreValue,x.userData.largeExplosion=!0,x.userData.damageFn=(oe=1)=>r(oe),x.userData.hitRadius=de,x.userData.blastRadius=f.userData.blastRadius,x.userData.chargeRadius=de}f.updateWorldMatrix(!0,!0);const se=new bn().setFromObject(f),ne=new Vs().copy(f.matrixWorld).invert(),fe=se.clone().applyMatrix4(ne),De=fe.getSize(new n),Me=fe.getCenter(new n),ge=new n(.42,.42,.32),Ae=De.multiply(ge).multiplyScalar(.4),ye=De.z*.12;Me.z+=ye,fe.min.copy(Me).sub(Ae),fe.max.copy(Me).add(Ae),f.userData.handCollider={box:fe};let pe=Math.random()*Math.PI*2;const Ee=[],X=[];for(let de=0;de<24;de++)X.push({t:0,pos:new n});const et={t:0,pos:new n};let A=0;const ke=new n,Qe=new n,Oe=new n,Fe=new n,qt=new n(a==="left"?-20:20,-3,3),Gt=a==="left"?-1:1,vt=de=>de<=.33?.0625:de<=.66?.1:.2;let _t=3+Math.random(),Ct=4+Math.random(),bt=0,Kt=0;const Bt=new n,$t=new n(0,1,0);let Zt=!1,Ft=0;const Ue=1.2,wt=9,tt=new n,J=new Rt,Ce=new n,ve=new n,_e=new n,Ie=new n,Ze=new n,gt=new n,ct=new n(0,0,1);function yt(de,oe,at=!0,nt=!1){var m,ae;if(!f.visible||f.userData.dead||nt)return;if(L>0){L=Math.max(0,L-de);const st=L>0?1:0;H(U,st,0,0)}q(de),pe+=de*.9;const dt=S?S.position:ke.set(0,0,0),ue=X.pop()??{t:0,pos:new n};ue.t=A,ue.pos.copy(dt),Ee.push(ue),A+=de;const Vt=(w==null?void 0:w())??1,St=vt(Vt),Et=Math.max(0,A-St);for(;Ee.length>1&&Ee[0].t<Et-.3;){const st=Ee.shift();st&&X.push(st)}let Lt=Ee[0]??et;Lt===et&&(et.t=Et,et.pos.copy(dt));let te=Ee[Ee.length-1]??Lt;for(let st=0;st<Ee.length-1;st++){const ot=Ee[st],Ne=Ee[st+1];if(ot.t<=Et&&Ne.t>=Et){Lt=ot,te=Ne;break}}const we=Math.max(1e-5,te.t-Lt.t),p=Mn.clamp((Et-Lt.t)/we,0,1);Qe.copy(Lt.pos).lerp(te.pos,p);const h=pe*1.1;if(Oe.copy(Qe).add(qt),Fe.set(Oe.x+Math.cos(h)*1+Math.sin(h*1.8)*.4,Oe.y+Math.sin(h)*.8+Math.sin(h*2.1)*.3,Oe.z+Math.sin(h*1.3)*.6),f.position.copy(Fe),i.getWorldPosition(ve),f.getWorldPosition(Ce),_e.copy(ve).sub(Ce),_e.lengthSq()>1e-6?_e.normalize():_e.copy(ct),f.quaternion.setFromUnitVectors(ct,_e),f.rotateY(a==="left"?Math.PI*.5:-Math.PI*.5),f.rotateX(Math.sin(h*1.9)*.08),!at){bt=0,Zt&&(Zt=!1,f.scale.setScalar(12));return}if(_t-=de,_t<=0&&bt<=0&&!B&&(bt=Ue,_t=4+Math.random()*2,i.getWorldPosition(tt),Ie.copy(tt),l.worldToLocal(Ie),Ze.copy(f.position),Bt.copy(Ie).sub(Ze).normalize(),Kt=Math.min(102,Ie.distanceTo(Ze))),bt>0){bt-=de;const st=1-bt/Ue,ot=Math.sin(st*Math.PI)*Kt;gt.copy(Bt).cross($t).setLength(8.5),gt.multiplyScalar(Math.sin(st*Math.PI)),f.position.copy(Fe).addScaledVector(Bt,ot).add(gt);const Ne=Math.sin(st*Math.PI)*(Math.PI*.5);f.rotateZ(Gt*-Ne),i.getWorldPosition(tt),f.getWorldPosition(Ce),tt.distanceToSquared(Ce)<wt&&((ae=(m=i.userData)==null?void 0:m.onHit)==null||ae.call(m,Ce))}else f.position.copy(Fe);if(Ct-=de,Ct<=0&&!Zt&&!B&&(Zt=!0,Ft=0),Zt){Ft+=de;const st=1+Math.sin(Ft*12)*.05;if(f.scale.setScalar(12*st),Ft>=1){if(y){const ot=y.alloc({big:!0,life:1.5,dir:1,bounced:!1,scale:2});ot&&(f.getWorldQuaternion(J),f.getWorldPosition(tt),i.getWorldPosition(ve),_e.copy(ve).sub(tt),_e.lengthSq()>1e-6?_e.normalize():_e.copy(ct),J.setFromUnitVectors(ct,_e),y.setTransform(ot,tt,J))}Zt=!1,f.scale.setScalar(12),Ct=4+Math.random()*2}}}function Ke(de=1,{full:oe=!1,blinkHand:at=!0}={}){if(f.userData.dead)return!1;const nt=oe?de:de*.5;return W=Math.max(0,W-nt),f.userData.hp=W,at&&C(),W===0?(f.userData.dead=!0,f.visible=!1,c(!1),$=-1,!0):!1}function r(de=1){return Y(),Ke(de,{full:!0,blinkHand:!1})}function T(de){B=de}function I(de=!0){f.userData.noScore=!!de}function he(){return f.userData.dead?!1:(f.userData.noScore=!0,f.userData.dead=!0,f.visible=!1,f.userData.lockRing&&(f.userData.lockRing.visible=!1),!0)}return{update:yt,damage:Ke,damagePalm:r,setDefense:T,setNoScore:I,forceRemove:he,isAlive:()=>!f.userData.dead,getMesh:()=>f,getPalm:()=>x,getHP:()=>W,handleLaserHit:(de=1)=>Ke(de)}}function Fl(e,{playerObj:t,explosionPool:o,headMesh:l,poolSize:a=12}={}){const y=new n(0,1,0),i=[],u=[],S=new n,w=new n,Z=new n,d=new n,E=[];let f=0;const D=.36;let W=!0;function L(){const g=new ss,B=new oa({color:8947848,transparent:!0,opacity:.7}),me=new oa({color:16755302,transparent:!0,opacity:.7}),U=new oa({color:16755302,transparent:!0,opacity:.7}),H=new cn({color:16720418,transparent:!0,opacity:.6,blending:_s,depthWrite:!1}),C=new xe(new Xn(.4,.4,3,6),B);C.position.y=1;const c=new xe(new Rr(.5,1.2,6),me);c.position.y=3;const Y=new xe(new tn(.1,1.2,1.8),U);Y.position.y=-.2,Y.rotation.y=Math.PI/2;const q=Y.clone();q.rotation.y=0;const se=new xe(new To(.4,6,6),H);return se.scale.set(.5,.3,1.5),se.position.y=-1.2,g.add(C,c,Y,q,se),g.visible=!1,g.userData={hp:1,blink:()=>{},dead:!1,enemy:!0,hitRadius:1.2,state:"idle",t:0,vel:new n},e.add(g),g.rotateX(-Math.PI*.5),g}for(let g=0;g<a;g++)i.push(L());function x(){if(!l||!W)return;l.updateWorldMatrix(!0,!0);const g=l.getWorldPosition(new n),B=[-9,-5,-2,2,5,9];B.forEach((me,U)=>{E.push({ox:me,dirSign:U<B.length/2?-1:1,origin:g.clone()})}),f=0}function N(g){if(!g)return;const B=i.find(c=>!c.visible);if(!B)return;const{ox:me,dirSign:U,origin:H}=g;B.visible=!0,B.userData.dead=!1,B.userData.hp=1,B.userData.noScore=!0,B.userData.state="launch",B.userData.t=0,B.userData.dirSign=U,B.userData.pastPlayer=!1;const C=H.clone().add(new n(me,-4,0));if(B.position.copy(C),B.userData.vel.set(0,-8,0),t){const Y=t.getWorldPosition(new n).sub(B.position).normalize();B.quaternion.setFromUnitVectors(y,Y)}else B.quaternion.setFromUnitVectors(new n(0,0,-1),y);u.push(B)}function $(g){g.visible=!1,g.userData.dead=!0,o==null||o.spawn(g.position)}function M(){E.length=0,u.forEach(g=>{g.visible=!1,g.userData.dead=!0}),u.length=0}function ie(g,B){var me,U;for(let H=u.length-1;H>=0;H--){const C=u[H];if(!C.visible){u.splice(H,1);continue}const c=C.userData;c.t+=g;const Y=B.getWorldPosition(S);if(c.state==="launch"&&c.t>.35?c.state="arc":c.state==="arc"&&c.t>.8&&(c.state="home"),c.state==="launch")C.userData.vel.set(0,-20,10);else if(!c.pastPlayer){w.subVectors(Y,C.position).normalize();const q=w.multiplyScalar(42);C.userData.vel.lerp(q,.65)}if(C.position.addScaledVector(C.userData.vel,g),w.subVectors(Y,C.position),w.lengthSq()>1e-6&&(w.normalize(),C.quaternion.setFromUnitVectors(y,w)),!c.pastPlayer&&C.position.z>=Y.z&&(c.pastPlayer=!0),C.position.distanceToSquared(Y)<(C.userData.hitRadius+1.2)**2){$(C),(U=(me=B.userData)==null?void 0:me.onHit)==null||U.call(me,C.position),u.splice(H,1);continue}C.position.z>Y.z+20&&(C.visible=!1,u.splice(H,1))}P(g)}function P(g){if(E.length)for(f-=g;E.length&&f<=0;){const B=E.shift();N(B),f+=D}}function V(){return u.filter(g=>g.visible&&!g.userData.dead)}function k(g){W=g,g||(E.length=0,M())}function R(g,B,{layer:me=null}={}){if(!g||!B||i.length===0)return;const U=i[0],H={visible:U.visible,position:U.position.clone(),quaternion:U.quaternion.clone(),layerMask:U.layers.mask},C=[];U.visible=!0,typeof me=="number"&&U.layers.set(me),B.getWorldPosition(Z),B.getWorldDirection(d),U.position.copy(Z).addScaledVector(d,25),U.quaternion.copy(B.quaternion),U.traverse(c=>{c.isMesh&&(C.push([c,c.frustumCulled]),c.frustumCulled=!1)}),g.render(e,B),C.forEach(([c,Y])=>{c.frustumCulled=Y}),U.visible=H.visible,U.position.copy(H.position),U.quaternion.copy(H.quaternion),U.layers.mask=H.layerMask}return{spawnBurst:x,update:ie,getActiveShips:V,setSpawning:k,clearAll:M,prewarm:R}}async function Hl(e,{playerObj:t,boltPool:o,railSpeed:l=35,summonWave:a=()=>{},spawnZ:y=-1200,explosionPool:i=null,canFire:u=null,onHeadDestroyed:S=null,handCleanupDelay:w=300,materialMode:Z="standard",onDialogue:d=null}={}){const E=new so;e.add(E);const f=await Wl(e,{modelPath:"./models/boss_head.glb",rig:E,boltPool:o,playerObj:t,railSpeed:l,summonWave:a,materialMode:Z}),D=()=>f.getHpRatio?f.getHpRatio():1,W=f.getMesh(),L=await or(e,{modelPath:"./models/boss_left_hand.glb",palmPath:"./models/boss_left_palm.glb",rig:E,side:"left",boltPool:o,playerObj:t,railSpeed:l,headMesh:W,getHeadHpRatio:D,materialMode:Z}),x=await or(e,{modelPath:"./models/boss_right_hand.glb",palmPath:"./models/boss_right_palm.glb",rig:E,side:"right",boltPool:o,playerObj:t,railSpeed:l,headMesh:W,getHeadHpRatio:D,materialMode:Z}),N=Fl(e,{playerObj:t,explosionPool:i,headMesh:W});let $=4,M=!1,ie=!1,P=!1,V=!1,k=!1;const R=ye=>{typeof d=="function"?d(ye):typeof(globalThis==null?void 0:globalThis.postMessage)=="function"&&globalThis.__IS_RENDER_WORKER&&globalThis.postMessage({type:"dialogue",payload:ye})};E.visible=!1,E.position.set(0,0,y);let g=!1,B=y,me=0,U=0;const H=2,C=8;function c(ye){me+=ye,U=H}function Y(ye=0){var pe,Ee,X;g=!0,B=y,E.visible=!0,[f,L,x].forEach(et=>et.getMesh().visible=!0),Ii(D()),(pe=L.setNoScore)==null||pe.call(L,!1),(Ee=x.setNoScore)==null||Ee.call(x,!1),ie=!1,P=!1,$=4,(X=N.setSpawning)==null||X.call(N,!0),M=!1,V=!1,k=!1}function q(){g=!1,E.visible=!1,[f,L,x].forEach(ye=>ye.getMesh().visible=!1),Ii(null)}function se(ye,pe,Ee=null,X=!1){var ke,Qe,Oe;if(!g)return;const et=typeof u=="function"?u():!0;if(Ee!==null?E.position.z=Ee-60:E.position.z=B,X)return;if(U>0&&(U-=ye,U<=0&&(me=0)),me>=C){const Fe=L.isAlive()?L:x,qt=x.isAlive()&&Fe===L?x:null;Fe==null||Fe.setDefense(!0),qt&&qt.setDefense(!1),me=0,U=0}else L.setDefense(!1),x.setDefense(!1);f.update(ye,pe,et,!1),L.update(ye,pe,et,!1),x.update(ye,pe,et,!1);const A=D();!V&&A<=.66&&(V=!0,R({id:"boss-phase-66",portraitSrc:"./textures/boss.png",textLines:["I will crush you like a bug."]})),!k&&A<=.33&&(k=!0,R({id:"boss-phase-33",portraitSrc:"./textures/boss.png",textLines:["To Oblivion, then."]})),f.isAlive()&&et?(M&&((ke=N.setSpawning)==null||ke.call(N,!0),M=!1),$-=ye,$<=0&&(N.spawnBurst(),$=6+Math.random()*3),N.update(ye,t)):M||((Qe=N.setSpawning)==null||Qe.call(N,!1),(Oe=N.clearAll)==null||Oe.call(N),M=!0)}function ne(ye,{critical:pe=!1}={}){var et,A,ke,Qe;const Ee=pe?ye:ye*.5,X=pe&&f.damageEyes?f.damageEyes(ye):f.damage(ye);if(X){if(!ie){if(ie=!0,L.setDefense(!1),x.setDefense(!1),(et=L.setNoScore)==null||et.call(L,!0),(A=x.setNoScore)==null||A.call(x,!0),(ke=N.setSpawning)==null||ke.call(N,!1),(Qe=N.clearAll)==null||Qe.call(N),g=!1,!P){P=!0;const Oe=()=>{var Fe,qt;(Fe=L.forceRemove)==null||Fe.call(L),(qt=x.forceRemove)==null||qt.call(x),q()};w<=0?Oe():setTimeout(Oe,w)}typeof S=="function"&&S()}}else c(Ee);return X}function fe(ye,pe,{critical:Ee=!1}={}){const X=ye==="left"?L:x;return Ee&&X.damagePalm?X.damagePalm(pe):X.damage(pe)}(()=>{var ke,Qe,Oe;const ye=f.getMesh(),pe=(ke=f.getEyes)==null?void 0:ke.call(f),Ee=L.getMesh(),X=(Qe=L.getPalm)==null?void 0:Qe.call(L),et=x.getMesh(),A=(Oe=x.getPalm)==null?void 0:Oe.call(x);ye!=null&&ye.userData&&(ye.userData.damageFn=(Fe=1)=>ne(Fe)),pe!=null&&pe.userData&&(pe.userData.damageFn=(Fe=1)=>ne(Fe,{critical:!0})),Ee!=null&&Ee.userData&&(Ee.userData.damageFn=(Fe=1)=>fe("left",Fe)),X!=null&&X.userData&&(X.userData.damageFn=(Fe=1)=>fe("left",Fe,{critical:!0})),et!=null&&et.userData&&(et.userData.damageFn=(Fe=1)=>fe("right",Fe)),A!=null&&A.userData&&(A.userData.damageFn=(Fe=1)=>fe("right",Fe,{critical:!0}))})();function Me(){var Ee,X,et,A;const ye=[];if(!g)return ye;if(f.isAlive()){const ke=(Ee=f.getEyes)==null?void 0:Ee.call(f);ke&&ye.push(ke),ye.push(f.getMesh())}if(L.isAlive()){const ke=(X=L.getPalm)==null?void 0:X.call(L);ke&&ye.push(ke),ye.push(L.getMesh())}if(x.isAlive()){const ke=(et=x.getPalm)==null?void 0:et.call(x);ke&&ye.push(ke),ye.push(x.getMesh())}const pe=(A=N.getActiveShips)==null?void 0:A.call(N);return pe!=null&&pe.length&&ye.push(...pe),ye}function ge(ye,pe=1){var Ee,X,et;return ye===f.getMesh()?ne(pe):ye===((Ee=f.getEyes)==null?void 0:Ee.call(f))?ne(pe,{critical:!0}):ye===L.getMesh()?fe("left",pe):ye===((X=L.getPalm)==null?void 0:X.call(L))?fe("left",pe,{critical:!0}):ye===x.getMesh()?fe("right",pe):ye===((et=x.getPalm)==null?void 0:et.call(x))?fe("right",pe,{critical:!0}):!1}function Ae(ye,pe){var Kt,Bt,$t,Zt,Ft;if(!ye||!pe)return;const Ee=2,X=ye.getRenderTarget(),et=pe.layers.mask,A=E.visible;E.visible=!0;const ke=[],Qe=[],Oe=[],Fe=[],qt=[];E.traverse(Ue=>{Fe.push([Ue,Ue.layers.mask]),Ue.layers.set(Ee),Ue.isMesh&&(ke.push([Ue,Ue.frustumCulled]),Ue.frustumCulled=!1)}),e.traverse(Ue=>{Ue.isLight&&(qt.push([Ue,Ue.layers.mask]),Ue.layers.enable(Ee))}),f.getMesh().visible=!0,L.getMesh().visible=!0,x.getMesh().visible=!0;const Gt=(Kt=f.getEyes)==null?void 0:Kt.call(f);Gt&&(Oe.push([Gt,Gt.visible]),Gt.visible=!0);const vt=(Bt=L.getPalm)==null?void 0:Bt.call(L);vt&&(Oe.push([vt,vt.visible]),vt.visible=!0);const _t=($t=x.getPalm)==null?void 0:$t.call(x);_t&&(Oe.push([_t,_t.visible]),_t.visible=!0);const Ct=((Zt=f.getActiveBeams)==null?void 0:Zt.call(f))??[];if(pe&&Ct.length){const Ue=new n,wt=new n;pe.getWorldPosition(Ue),pe.getWorldDirection(wt),Ct.forEach(tt=>{tt&&(Qe.push([tt,tt.visible,tt.position.clone(),tt.quaternion.clone(),tt.frustumCulled,tt.layers.mask]),tt.visible=!0,tt.frustumCulled=!1,tt.layers.set(Ee),tt.position.copy(Ue).addScaledVector(wt,30),tt.quaternion.copy(pe.quaternion))})}pe.layers.set(Ee);const bt=new ya(1,1);"outputColorSpace"in ye&&ye.outputColorSpace&&(bt.texture.colorSpace=ye.outputColorSpace),ye.setRenderTarget(bt),ye.render(e,pe),(Ft=N.prewarm)==null||Ft.call(N,ye,pe,{layer:Ee}),ye.setRenderTarget(X),bt.dispose(),E.visible=A,ke.forEach(([Ue,wt])=>{Ue.frustumCulled=wt}),Oe.forEach(([Ue,wt])=>{Ue.visible=wt}),Qe.forEach(([Ue,wt,tt,J,Ce,ve])=>{Ue.visible=wt,Ue.position.copy(tt),Ue.quaternion.copy(J),Ue.frustumCulled=Ce,Ue.layers.mask=ve}),Fe.forEach(([Ue,wt])=>{Ue.layers.mask=wt}),qt.forEach(([Ue,wt])=>{Ue.layers.mask=wt}),pe.layers.mask=et}return{update:se,damageHead:ne,damageHand:fe,getEnemyParts:Me,handleLaserHit:ge,activate:Y,deactivate:q,getRig:()=>E,getHead:()=>f,getHands:()=>[L,x],getMissiles:()=>N,prewarm:Ae}}const ir=[{name:"small",scale:1.4,spin:[.18,.22,.16],rot:[.3,.8,.1]},{name:"medium",scale:3,spin:[.14,.18,.12],rot:[.7,1.2,.4]},{name:"large",scale:4.6,spin:[.1,.14,.1],rot:[1.1,.2,.9]},{name:"flat",scale:2.2,spin:[.12,.2,.08],rot:[.5,.3,1]}];async function Nl(e,t,o="./models/asteroid.glb",{materialMode:l="standard"}={}){if(!Array.isArray(t)||t.length===0)return{update:()=>{}};const a=(await new Un().loadAsync(o)).scene;l==="lambert"?a.traverse(d=>{d.isMesh&&(d.material=cs(d.material))}):a.traverse(d=>{d.isMesh&&(d.material=d.material.clone())});const i=new ss;e.add(i);function u(d){if(d.type){const E=ir.find(f=>f.name===d.type);if(E)return E}return ir[1]}t.forEach(d=>{const E=a.clone(!0),f=u(d);E.scale.setScalar(f.scale),E.position.set(d.x,d.y,d.z),E.rotation.set(f.rot[0],f.rot[1],f.rot[2]),E.userData.asteroid=!0,E.userData.editorRef=d,E.userData.editorGroup="asteroid",E.userData.spin=new n(f.spin[0],f.spin[1],f.spin[2]),E.frustumCulled=!1,i.add(E)});const S=new n,w=200;function Z(d,E){E&&E.getWorldPosition(S);for(let f=i.children.length-1;f>=0;f--){const D=i.children[f];if(D.userData.dead){i.children.splice(f,1);continue}const W=D.userData.spin;D.rotation.x+=W.x*d,D.rotation.y+=W.y*d,D.rotation.z+=W.z*d,D.visible=D.position.distanceToSquared(S)<w*w,D.position.z>S.z+25&&(D.visible=!1,D.userData.dead=!0)}}return{group:i,update:Z}}async function ql(e,{path:t="./models/player_starfighter_body_only.glb",wingLeftPath:o="./models/player_starfighter_l_wing_only.glb",wingRightPath:l="./models/player_starfighter_r_wing_only.glb",fallbackColour:a=43775,scene:y=null,explosionPool:i=null,materialMode:u="standard"}={}){const S=new Un,w=new so;e.add(w);const Z=async G=>{if(!G)return null;try{return(await S.loadAsync(G)).scene}catch{return null}},d=()=>new xe(new tn(5,2,10),new Ls({color:a})),E=new bn,f=new Vs,D=new n,W=new n,L=G=>{const Se=new bn;if(!G)return Se;G.updateMatrixWorld(!0);const rt=f.copy(G.matrixWorld).invert();return G.traverse(ce=>{!ce.isMesh||!ce.geometry||(ce.geometry.boundingBox||ce.geometry.computeBoundingBox(),ce.geometry.boundingBox&&(E.copy(ce.geometry.boundingBox),E.applyMatrix4(ce.matrixWorld),E.applyMatrix4(rt),Se.union(E)))}),Se},x=(G,Se,rt)=>{if(!G||!Se||Se.isEmpty())return null;const ce=Se.getSize(W),ht=ce.x*.22,lt=ce.y*.22,Dt=[];G.updateMatrixWorld(!0);const kt=f.copy(G.matrixWorld).invert();if(G.traverse(pt=>{if(!pt.isMesh||!pt.geometry)return;const fn=pt.geometry.getAttribute("position");if(!fn)return;const pn=Math.max(1,Math.floor(fn.count/4e3));for(let Nt=0;Nt<fn.count;Nt+=pn)D.set(fn.getX(Nt),fn.getY(Nt),fn.getZ(Nt)),D.applyMatrix4(pt.matrixWorld),D.applyMatrix4(kt),!(Math.abs(D.x-rt.x)>ht)&&(Math.abs(D.y-rt.y)>lt||Dt.push(D.z))}),!Dt.length)return null;Dt.sort((pt,fn)=>fn-pt);const nn=Math.min(3,Math.floor(Dt.length*.005));return Dt[Math.min(nn,Dt.length-1)]},N=u==="lambert",$=G=>{if(!G)return null;const Se={model:G,meshList:[],bounds:new bn,boundsCenter:new n,chargeNoseOffsetZ:0};return G.traverse(rt=>{rt.isMesh&&(rt.material=N?cs(rt.material):rt.material.clone(),Se.meshList.push(rt))}),Se.bounds=L(G),Se.bounds.isEmpty()||(Se.bounds.getCenter(Se.boundsCenter),Se.chargeNoseOffsetZ=Se.bounds.max.z),Se},M=G=>{if(!G)return null;const Se={model:G,meshList:[],bounds:new bn,center:new n};return G.traverse(rt=>{rt.isMesh&&(rt.material=N?cs(rt.material):rt.material.clone(),Se.meshList.push(rt))}),Se.bounds=L(G),Se.bounds.isEmpty()||Se.bounds.getCenter(Se.center),Se},ie=await Z(t)??d(),P=$(ie);P!=null&&P.model&&w.add(P.model);const V=await Z(o),k=await Z(l),R=V?M(V):null,g=k?M(k):null;R!=null&&R.model&&(R.model.name="player-wing-left",w.add(R.model)),g!=null&&g.model&&(g.model.name="player-wing-right",w.add(g.model)),P!=null&&P.model&&(P.model.updateMatrix(),P.boundsCenterInPlayer=P.boundsCenter?P.boundsCenter.clone().applyMatrix4(P.model.matrix):new n),R!=null&&R.model&&(R!=null&&R.bounds)&&!R.bounds.isEmpty()&&(R.model.updateMatrix(),R.boundsInPlayer=R.bounds.clone().applyMatrix4(R.model.matrix),R.boundsInPlayer.expandByScalar(.05),R.centerInPlayer=R.boundsInPlayer.getCenter(new n)),g!=null&&g.model&&(g!=null&&g.bounds)&&!g.bounds.isEmpty()&&(g.model.updateMatrix(),g.boundsInPlayer=g.bounds.clone().applyMatrix4(g.model.matrix),g.boundsInPlayer.expandByScalar(.05),g.centerInPlayer=g.boundsInPlayer.getCenter(new n));const B=new no,me=new bn,U=(G,Se)=>{!G||G.isEmpty()||!Se||(Se.updateMatrix(),E.copy(G).applyMatrix4(Se.matrix),me.union(E))};U(P==null?void 0:P.bounds,P==null?void 0:P.model),U(R==null?void 0:R.bounds,R==null?void 0:R.model),U(g==null?void 0:g.bounds,g==null?void 0:g.model),me.isEmpty()&&(w.updateMatrixWorld(!0),me.setFromObject(w)),me.getBoundingSphere(B);const H=B.radius;if(P!=null&&P.bounds&&(P!=null&&P.model)){P.model.updateMatrixWorld(!0);const G=x(P.model,P.bounds,P.boundsCenter);if(typeof G=="number"){const Se=new n(P.boundsCenter.x,P.boundsCenter.y,G);Se.applyMatrix4(P.model.matrix),w.userData.chargeNosePoint=Se,w.userData.chargeNoseOffsetZ=Se.z}else E.copy(P.bounds).applyMatrix4(P.model.matrix),w.userData.chargeNoseOffsetZ=E.max.z}else w.userData.chargeNoseOffsetZ=me.max.z;let C=[...(P==null?void 0:P.meshList)??[],...(R==null?void 0:R.meshList)??[],...(g==null?void 0:g.meshList)??[]];w.userData.meshes=C;const c=.3,Y=.2,q=.2,se=6,ne=.6;let fe=0,De=0;const Me=Math.PI*.5;let ge=0;const Ae=new Yi(.2,20);Ae.scale(1.4,.85,1);const ye=(G,Se,rt=.35)=>new zi({transparent:!0,blending:_s,depthWrite:!1,side:ms,uniforms:{color:{value:new ls(G)},opacity:{value:Se},softness:{value:rt}},vertexShader:`
      varying vec2 vUv;
      void main(){
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,fragmentShader:`
      uniform vec3  color;
      uniform float opacity;
      uniform float softness;
      varying vec2  vUv;
      void main(){
        vec2 p = (vUv - 0.5) * 2.0;
        float d = length(p);
        float mask = 1.0 - smoothstep(1.0 - softness, 1.0, d);
        gl_FragColor = vec4(color, opacity * mask);
      }
    `}),pe=new xe(Ae,ye(52479,.45,.45));pe.position.set(0,0,-1),pe.frustumCulled=!1,w.add(pe);const Ee=new xe(Ae,ye(30664,.55,.35));Ee.scale.set(.6,.6,.6),Ee.position.set(0,0,-1.01),Ee.frustumCulled=!1,w.add(Ee);const X=pe.scale.clone(),et=Ee.scale.clone(),A=pe.position.clone(),ke=12,Qe=.6,Oe=6,Fe=3.2,qt=.35,Gt=1.15,vt=.35,_t=.65,Ct=()=>new zi({transparent:!0,blending:_s,depthWrite:!1,side:ms,uniforms:{innerColor:{value:new ls(30664)},outerColor:{value:new ls(52479)},opacity:{value:_t},softness:{value:.6}},vertexShader:`
      varying vec2 vUv;
      void main(){
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,fragmentShader:`
      uniform vec3 innerColor;
      uniform vec3 outerColor;
      uniform float opacity;
      uniform float softness;
      varying vec2 vUv;
      void main(){
        vec2 p = (vUv - 0.5) * 2.0;
        float d = length(p);
        float t = smoothstep(0.0, 1.0, d);
        vec3 color = mix(innerColor, outerColor, t);
        float mask = 1.0 - smoothstep(1.0 - softness, 1.0, d);
        gl_FragColor = vec4(color, opacity * mask);
      }
    `}),bt=[],Kt=Array.from({length:ke},()=>new n),Bt=Array.from({length:ke},()=>new Rt),$t=new n,Zt=new Rt,Ft=new n;let Ue=0,wt=0,tt=0,J=!1,Ce=1;if(y)for(let G=0;G<ke;G++){const Se=new xe(Ae,Ct());Se.visible=!1,Se.frustumCulled=!1,y.add(Se),bt.push(Se)}const ve=3;let _e=ve,Ie=ve;const Ze={left:(R==null?void 0:R.meshList)??[],right:(g==null?void 0:g.meshList)??[]},gt=new n,ct=new n,yt=new n,Ke=new n,r=new n,T=new n,I=.25,he=new ls(4891647),de=1.6,oe=8;let at=0,nt=0,dt=!1,ue=!1,Vt=!1;function St(){w.userData.wingHpLeft=_e,w.userData.wingHpRight=Ie}function Et(){let G="full";_e<=0&&Ie<=0?G="noW":_e<=0?G="noL":Ie<=0&&(G="noR"),w.userData.wingVariant=G}function Lt(G,Se){G!=null&&G.model&&(G.model.visible=Se,Se||m(G.meshList,0))}function te(G){!(i!=null&&i.spawn)||!(G!=null&&G.center)||!(G!=null&&G.model)||(ct.copy(G.center),G.model.localToWorld(ct),i.spawn(ct))}function we(G,Se,rt){if(!rt||Se.lengthSq()<1e-6)return!1;let ce=0,ht=1;const lt=G.x,Dt=G.y,kt=G.z,nn=Se.x,pt=Se.y,fn=Se.z,pn=rt.min,Nt=rt.max,hn=1e-6;if(Math.abs(nn)<hn){if(lt<pn.x||lt>Nt.x)return!1}else{const En=1/nn;let ln=(pn.x-lt)*En,mn=(Nt.x-lt)*En;if(ln>mn&&([ln,mn]=[mn,ln]),ce=Math.max(ce,ln),ht=Math.min(ht,mn),ce>ht)return!1}if(Math.abs(pt)<hn){if(Dt<pn.y||Dt>Nt.y)return!1}else{const En=1/pt;let ln=(pn.y-Dt)*En,mn=(Nt.y-Dt)*En;if(ln>mn&&([ln,mn]=[mn,ln]),ce=Math.max(ce,ln),ht=Math.min(ht,mn),ce>ht)return!1}if(Math.abs(fn)<hn){if(kt<pn.z||kt>Nt.z)return!1}else{const En=1/fn;let ln=(pn.z-kt)*En,mn=(Nt.z-kt)*En;if(ln>mn&&([ln,mn]=[mn,ln]),ce=Math.max(ce,ln),ht=Math.min(ht,mn),ce>ht)return!1}return ht>=0&&ce<=1}function p(G,Se,rt=null){if(!(G!=null&&G.model)||!G.bounds||G.bounds.isEmpty()||G.model.visible===!1)return!1;const ce=rt??T.copy(Se);return rt===null&&(w.updateMatrixWorld(!0),w.worldToLocal(ce)),G.boundsInPlayer&&(G.boundsInPlayer.containsPoint(ce)||G.boundsInPlayer.distanceToPoint(ce)<=I)||P!=null&&P.boundsCenterInPlayer&&(r.copy(P.boundsCenterInPlayer),yt.copy(ce).sub(r),G.boundsInPlayer&&!G.boundsInPlayer.containsPoint(r)&&we(r,yt,G.boundsInPlayer))||(G.model.updateMatrixWorld(!0),gt.copy(Se),G.model.worldToLocal(gt),G.bounds.containsPoint(gt)||G.bounds.distanceToPoint(gt)<=I)?!0:!(P!=null&&P.model)||!(P!=null&&P.boundsCenter)?!1:(P.model.updateMatrixWorld(!0),Ke.copy(P.boundsCenter),P.model.localToWorld(Ke),r.copy(Ke),G.model.worldToLocal(r),yt.copy(gt).sub(r),G.bounds.containsPoint(r)?!1:we(r,yt,G.bounds))}function h(G){if(!G)return null;if(!(R!=null&&R.model)&&!(g!=null&&g.model))return Vt||(Vt=!0,console.warn("[player] wing models not found; check player_starfighter_l_wing_only/player_starfighter_r_wing_only GLBs.")),null;w.updateMatrixWorld(!0),T.copy(G),w.worldToLocal(T);const Se=(R==null?void 0:R.model)&&_e>0&&p(R,G,T),rt=(g==null?void 0:g.model)&&Ie>0&&p(g,G,T);if(!Se&&!rt)return null;let ce=Se?"left":"right";if(Se&&rt){const ht=R!=null&&R.centerInPlayer?T.distanceToSquared(R.centerInPlayer):1/0;ce=(g!=null&&g.centerInPlayer?T.distanceToSquared(g.centerInPlayer):1/0)<ht?"right":"left"}return ce==="left"?(_e=Math.max(0,_e-1),St(),w.userData.wingHitCountLeft=(w.userData.wingHitCountLeft??0)+1,w.userData.lastWingHit="left",w.userData.lastWingHitAt=typeof performance<"u"&&performance.now?performance.now():Date.now(),_e===0&&(Lt(R,!1),te(R),w.userData.onWingLost&&w.userData.onWingLost("left"))):(Ie=Math.max(0,Ie-1),St(),w.userData.wingHitCountRight=(w.userData.wingHitCountRight??0)+1,w.userData.lastWingHit="right",w.userData.lastWingHitAt=typeof performance<"u"&&performance.now?performance.now():Date.now(),Ie===0&&(Lt(g,!1),te(g),w.userData.onWingLost&&w.userData.onWingLost("right"))),Et(),ce}function m(G,Se){if(!G||!G.length)return;const rt=he.r*Se,ce=he.g*Se,ht=he.b*Se;G.forEach(lt=>{lt.material.emissive&&lt.material.emissive.setRGB(rt,ce,ht)})}function ae(G){var ce,ht;at>0&&(at=Math.max(0,at-G)),nt>0&&(nt=Math.max(0,nt-G));const Se=at>0&&((ce=R==null?void 0:R.model)==null?void 0:ce.visible)!==!1,rt=nt>0&&((ht=g==null?void 0:g.model)==null?void 0:ht.visible)!==!1;if(Se){const lt=.6+.4*Math.sin((de-at)*oe);m(Ze.left,lt),dt=!0}else dt&&(m(Ze.left,0),dt=!1);if(rt){const lt=.6+.4*Math.sin((de-nt)*oe);m(Ze.right,lt),ue=!0}else ue&&(m(Ze.right,0),ue=!1)}function st(){_e=ve,Ie=ve,St(),Lt(R,!0),Lt(g,!0),at=de,nt=de,Et()}function ot(G,Se,rt,ce=0){if(ge>0){ge=Math.max(0,ge-rt);const kt=ge>0?1:0;C.forEach(nn=>{nn.material.emissive&&nn.material.emissive.setRGB(kt,0,0)})}ae(rt);const ht=ce?ce*Me:-G*c,lt=G*Y,Dt=-Se*q;if(fe===0&&(w.rotation.z+=(ht-w.rotation.z)*se*rt),w.rotation.y+=(lt-w.rotation.y)*se*rt,w.rotation.x+=(Dt-w.rotation.x)*se*rt,fe>0){fe=Math.max(0,fe-rt);const kt=De*(4*Math.PI)*(rt/ne);w.rotateZ(kt),fe===0&&(w.rotation.z=0)}}function Ne(G){fe===0&&(fe=ne,De=G)}function Be(){return fe>0}function Ht(){return De}function je(){ge=.15,C.forEach(G=>{G.material.emissive&&G.material.emissive.setRGB(1,0,0)})}function be(G=0){var ce,ht;if(!y||bt.length===0)return;let Se=G;if(!Number.isFinite(Se)||Se<=0){const lt=typeof performance<"u"?performance.now():Date.now();Se=tt?Math.max(0,(lt-tt)/1e3):0,tt=lt}if(J?wt=Math.min(1,wt+Se*Oe):wt=Math.max(0,wt-Se*Fe),J&&(Ft.copy(A),w.localToWorld(Ft),w.getWorldQuaternion(Zt),Ue===0||Ft.distanceToSquared(Kt[0])>=Qe*Qe)){for(let lt=ke-1;lt>0;lt--)Kt[lt].copy(Kt[lt-1]),Bt[lt].copy(Bt[lt-1]);Kt[0].copy(Ft),Bt[0].copy(Zt),Ue=Math.min(ke,Ue+1)}const rt=1+Math.max(0,Ce-1)*.35;for(let lt=0;lt<bt.length;lt++){const Dt=bt[lt];if(lt>=Ue||wt<=.001){Dt.visible=!1;continue}const kt=Ue>1?lt/(Ue-1):0,nn=(1-kt)*wt;if(nn<=.01){Dt.visible=!1;continue}$t.copy(Kt[lt]),Zt.copy(Bt[lt]),Dt.userData.init?(Dt.position.lerp($t,qt),Dt.quaternion.slerp(Zt,qt)):(Dt.position.copy($t),Dt.quaternion.copy(Zt),Dt.userData.init=!0);const pt=Mn.lerp(Gt,vt,kt)*rt;Dt.scale.copy(X).multiplyScalar(pt),(ht=(ce=Dt.material)==null?void 0:ce.uniforms)!=null&&ht.opacity&&(Dt.material.uniforms.opacity.value=_t*nn),Dt.visible=!0}}function $e(G=1){pe.scale.copy(X).multiplyScalar(G),Ee.scale.copy(et).multiplyScalar(G),Ce=G,J=G>1.01}return w.userData.blink=je,w.userData.updateTrail=be,w.userData.setEngineGlowScale=$e,w.userData.applyWingDamage=h,w.userData.restoreWings=st,w.userData.wingMaxHp=ve,St(),Et(),{mesh:w,radius:H,update:ot,startRoll:Ne,isRolling:Be,getRollDir:Ht,blink:je,updateTrail:be,setEngineGlowScale:$e}}async function Gl(e,{railCurve:t,playerObj:o,laserSystem:l,enemySystem:a=null,enemyLasers:y=null,enemyBoltPool:i=null,explosionPool:u=null,onDialogue:S=null,onEscortOutcome:w=null,playerSpeed:Z=35,spawn:d={x:80,y:12,z:-3500},spawnTriggerZ:E=-3520,materialMode:f="standard"}={}){const D=new Un;let W=null;try{W=(await D.loadAsync("./models/player_starfighter_v2.glb")).scene}catch(Te){console.warn("[ally] failed to load model",Te)}W||(W=new xe(new tn(5,2,10),new Ls({color:43775})));const L=f==="lambert";W.updateMatrixWorld(!0);const x=new bn().setFromObject(W),N=x.getCenter(new n),$=new no,M=x.isEmpty()?4:x.getBoundingSphere($).radius,ie=x.isEmpty()?null:new n(N.x,N.y,x.max.z),P=new Yi(.2,20);P.scale(1.4,.85,1);const V=(Te,ut,z=.35)=>new zi({transparent:!0,blending:_s,depthWrite:!1,side:ms,uniforms:{color:{value:new ls(Te)},opacity:{value:ut},softness:{value:z}},vertexShader:`
      varying vec2 vUv;
      void main(){
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,fragmentShader:`
      uniform vec3  color;
      uniform float opacity;
      uniform float softness;
      varying vec2  vUv;
      void main(){
        vec2 p = (vUv - 0.5) * 2.0;
        float d = length(p);
        float mask = 1.0 - smoothstep(1.0 - softness, 1.0, d);
        gl_FragColor = vec4(color, opacity * mask);
      }
    `}),k=x.isEmpty()?-1:x.min.z-.2,R=()=>{const Te=new so;Te.visible=!1;const ut=W.clone(!0),z=[];ut.traverse(Re=>{Re.isMesh&&(Re.material=L?cs(Re.material):Re.material.clone(),Re.frustumCulled=!1,z.push(Re))}),Te.add(ut),ie&&(Te.userData.chargeNoseOffsetZ=x.max.z,Te.userData.chargeNosePoint=ie.clone());const K=new xe(P,V(52479,.45,.45));K.position.set(N.x,N.y,k),K.frustumCulled=!1,Te.add(K);const Le=new xe(P,V(30664,.55,.35));return Le.scale.set(.6,.6,.6),Le.position.set(N.x,N.y,k-.01),Le.frustumCulled=!1,Te.add(Le),Te.userData._blinkMeshes=z,Te.userData._blinkBase=z.map(Re=>{var it;return(it=Re.material)!=null&&it.emissive?Re.material.emissive.clone():null}),Te.userData.flashT=0,Te.userData.hitRadius=M*.9,e.add(Te),Te},g=R(),B=R(),me=new n(d.x,d.y,d.z),U=new n(80,-10,-4002),H=new n(95,-10,-4003),C=[U,U,U,H,H,H],c=210,Y=c*c,q=20,se=35,ne=2,fe=.35,De=.22,Me=1.4,ge=35,Ae=20,ye=20,pe=5,Ee=.6,X=-1280,et=-1470,A=[new n(-210,30,-1450),new n(-52,15,-1600),new n(12,22,-1845)],ke=A[0].clone(),Qe=20,Oe=A[A.length-1].z-Qe,Fe=[new n(-350,20,-1470),new n(-360,10,-1470),new n(-370,-10,-1470),new n(-380,-20,-1470)],qt=[new n(6,6,12),new n(-6,6,14),new n(7,-6,13),new n(-7,-6,12)],Gt=.9,vt=2.5,_t=6,Ct=Z*1.15,bt=1.8,Kt=Z,Bt=20,$t=20,Zt=3.5,Ft=35,Ue=10,wt=new n(0,1,0),tt=new n(0,0,1),J=new Rt().setFromAxisAngle(wt,Math.PI),Ce=new n,ve=new n(0,0,-1),_e=new n(0,0,-1),Ie=new n,Ze=new n(0,1,0),gt=new n,ct=new n,yt=new Vs,Ke=new n,r=new Rt,T=new Rt,I=new n,he=new n,de=new n,oe=new n,at=new n,nt=new n,dt=new n,ue=new n,Vt=new n,St=new n,Et=new n(0,0,1),Lt=t.getLength();let te=!1,we=!1,p="idle",h=-10,m=0,ae=0,st=0,ot=0,Ne=0,Be=!1,Ht=!1,je="idle",be=0,$e=0,G=0,Se=0,rt=bt,ce=0,ht=0;const lt=[];let Dt=null,kt=Z,nn=!1,pt=!1;function fn(Te,ut,z,K){g.position.copy(me),g.visible=!0,te=!0,p="approach",m=0,ae=0,st=0,ot=0,Ne=0,h=-10,hn({id:"turret-ally-spawn",portraitSrc:"./textures/red.png",textLines:["I'll take out the turrets on the right!"]})}const pn=Te=>{if(!(Te!=null&&Te.userData))return;Te.userData.flashT=.15,(Te.userData._blinkMeshes??[]).forEach(z=>{var K;(K=z.material)!=null&&K.emissive&&z.material.emissive.setRGB(1,0,0)})},Nt=(Te,ut)=>{if(!(Te!=null&&Te.userData))return;const z=Te.userData;if(!z.flashT||(z.flashT=Math.max(0,z.flashT-ut),z.flashT>0))return;const K=z._blinkMeshes??[],Le=z._blinkBase??[];K.forEach((Re,it)=>{var gn;if(!((gn=Re.material)!=null&&gn.emissive))return;const At=Le[it];At?Re.material.emissive.copy(At):Re.material.emissive.setRGB(0,0,0)})},hn=Te=>{if(typeof S=="function"){S(Te);return}typeof(globalThis==null?void 0:globalThis.postMessage)=="function"&&globalThis.__IS_RENDER_WORKER&&globalThis.postMessage({type:"dialogue",payload:Te})};function En(Te,ut,z,K){nt.copy(ut).sub(Te);const Le=nt.lengthSq();let Re=0;return Le>1e-8&&(dt.copy(z).sub(Te),Re=dt.dot(nt)/Le,Re<0?Re=0:Re>1&&(Re=1)),ue.copy(Te).addScaledVector(nt,Re),ue.distanceToSquared(z)<=K}function ln(){B.position.copy(ke),B.visible=!0,B.traverse(ut=>{ut.isMesh&&(ut.visible=!0)}),B.scale.setScalar(Zt),B.updateMatrixWorld(!0),Be=!0,je="path",be=(Number.isFinite(kt)?kt:Z)*Gt,$e=Math.min(1,A.length-1),G=0,Se=0,rt=bt,ce=0,ht=0,lt.length=0,nn=!1,pt=!1,Ss(),hn({id:"escort-spawn",portraitSrc:"./textures/green.png",textLines:["They're on me! I can't shake 'em!"]})}function mn(Te,ut=0){if(!(a!=null&&a.spawnManual)||!Te)return;const z=a.spawnManual(Te,{state:"chase",onSpawn:K=>{K.userData.chaseTarget=B,K.userData.chaseOffset=qt[ut%qt.length],K.userData.chaseOffsetMode="world",K.userData.chaseMinDist=6,K.userData.chaseSpeed=Ct,K.userData.allyChaser=!0,K.userData.noCullBehind=!0,K.userData.fireT=999}});z&&lt.push(z)}function Ss(){Fe.forEach((Te,ut)=>mn(Te,ut))}function io(){var ut;let Te=0;for(let z=0;z<lt.length;z++){const K=lt[z];!K||!K.visible||(ut=K.userData)!=null&&ut.dead||(Te+=1)}return Te}function ao(){if(lt.length){for(let Te=0;Te<lt.length;Te++){const ut=lt[Te];ut&&(ut.visible=!1,ut.userData&&(ut.userData.dead=!0,ut.userData.allyChaser=!1,ut.userData.noCullBehind=!1,ut.userData.chaseTarget=null))}lt.length=0}}function Ys(){var Le;const Te=typeof y=="function"?y():y;if(!(Te!=null&&Te.length)||!B.visible)return;const ut=B.userData.hitRadius??6,z=ut*ut,K=B.position;for(let Re=0;Re<Te.length;Re++){const it=Te[Re];if(!((Le=it==null?void 0:it.userData)!=null&&Le.active))continue;const At=it.prev??it.position;if(En(At,it.position,K,z)){it.userData.active=!1,it.userData.life=0,pn(B);break}}}function ro(){var ut;if(!(i!=null&&i.alloc))return;const Te=B.position;for(let z=0;z<lt.length;z++){const K=lt[z];if(!K||!K.visible||(ut=K.userData)!=null&&ut.dead)continue;const Le=i.alloc({big:!1,life:1.2,dir:1,bounced:!1});Le&&(K.getWorldPosition(St),Vt.copy(Te).sub(St),Vt.lengthSq()<1e-6&&Vt.set(0,0,-1),Vt.normalize(),r.setFromUnitVectors(Et,Vt),i.setTransform(Le,St,r))}}function ts(Te,ut,z=0){!Te||ut.lengthSq()<1e-6||(ct.copy(ut).normalize(),Ke.copy(Te.position).add(ct),yt.lookAt(Te.position,Ke,wt),r.setFromRotationMatrix(yt),Te.quaternion.copy(r),Te.quaternion.multiply(J),z&&(T.setFromAxisAngle(tt,z),Te.quaternion.multiply(T)))}function Us(Te,ut){var z;if(!(!o||!t||!(l!=null&&l.fireAllyShot))){if(o.getWorldPosition(Ce),typeof ut=="number"){if(t.getTangentAt(ut,_e).normalize(),Te>0&&Number.isFinite(ut)){if(Dt!==null){const K=ut-Dt,Le=Math.abs(K)*Lt/Te;Number.isFinite(Le)&&Le>=0&&(kt=Le)}Dt=ut}}else _e.set(0,0,-1);if(Ie.copy(_e).cross(Ze.set(0,1,0)).normalize(),Ze.crossVectors(Ie,_e).normalize(),we||Ce.z<=E&&(we=!0,fn()),te){if(p!=="exit"&&(h=Math.min(q,h+se*Te),gt.copy(Ce).addScaledVector(_e,h),gt.x=Ft,gt.y=Ue,g.position.lerp(gt,Math.min(1,ne*Te))),p==="approach"){const Le=g.position.distanceToSquared(U),Re=g.position.distanceToSquared(H);Math.min(Le,Re)<=Y&&(p="attack",m=0)}if(p==="attack"){for(m+=Te;ae<C.length&&m>=fe+ae*De;)l.fireAllyShot(g,C[ae]),ae++;ae>=C.length&&m>=fe+C.length*De+Me&&(p="exit",st=0,Ne=0,ot=Ee,I.copy(_e).multiplyScalar(ge),I.x-=Ae,I.y+=ye,he.copy(I).normalize(),hn({id:"turret-ally-exit",portraitSrc:"./textures/red.png",textLines:["Scratch two turrets! No need to thank me."]}))}if(p==="exit"){if(st+=Te,g.position.addScaledVector(I,Te),ot>0){ot=Math.max(0,ot-Te);const Le=4*Math.PI*(Te/Ee);Ne+=Le,ot===0&&(Ne=0)}st>=pe&&(g.visible=!1,te=!1)}let K=null;p==="attack"&&ae<C.length&&(K=C[ae]),p==="exit"?ts(g,he,Ne):K?(ct.copy(K).sub(g.position),ct.lengthSq()>1e-6&&ct.normalize(),ve.copy(_e).lerp(ct,.6).normalize(),ts(g,ve,Ne)):ts(g,_e,Ne)}if(!Ht&&Ce.z<=X&&(Ht=!0,ln()),Be){B.visible=!0;const K=io();if(K>0&&Ys(),G>0){G=Math.max(0,G-Te);const Le=4*Math.PI*(Te/Ee);Se+=Le,G===0&&(Se=0)}else rt=Math.max(0,rt-Te),rt===0&&(G=Ee,rt=bt,Se=0);if(je==="destroying")ht+=Te,ht>=.2&&(B.visible=!1,Be=!1);else if(je==="exit")ce+=Te,B.position.addScaledVector(de,Te),ts(B,oe,Se),ce>=pe&&(B.visible=!1,Be=!1);else{const Le=A[Math.min($e,A.length-1)];at.copy(Le).sub(B.position);const Re=at.length();Re>1e-4&&at.multiplyScalar(1/Re);const it=Number.isFinite(kt)?kt:Z,At=Ce.z<=et?it:it*Gt;be+=(At-be)*Math.min(1,vt*Te);const gn=be*Te,j=Math.max(gn,_t);Re<=j?(B.position.copy(Le),$e<A.length-1?$e+=1:K===0?(je="exit",ce=0,Se=0,G=Ee,de.copy(_e).multiplyScalar(Kt),de.x+=Bt,de.y+=$t,oe.copy(de).normalize(),nn||(nn=!0,typeof w=="function"&&w({survived:!0})),hn({id:"escort-escape",portraitSrc:"./textures/green.png",textLines:["Thanks, cat! That was too close!"]})):(je="destroying",ht=0,pn(B),ro(),(z=u==null?void 0:u.spawn)==null||z.call(u,B.position),nn||(nn=!0,typeof w=="function"&&w({survived:!1})),hn({id:"escort-destroyed",portraitSrc:"./textures/green.png",textLines:["I'm hit! Ahhhhh!"]}))):Re>1e-4&&B.position.addScaledVector(at,gn);const mt=Re>1e-4?at:_e;ts(B,mt,Se)}}!pt&&Ht&&Ce.z<=Oe&&je!=="path"&&(pt=!0,ao()),Nt(g,Te),Nt(B,Te)}}function os(Te,ut){if(!Te||!ut)return;const z=[g.visible,B.visible],K=[g.position.clone(),B.position.clone()],Le=[g.quaternion.clone(),B.quaternion.clone()];g.visible=!0,B.visible=!0,ut.getWorldPosition(Ce),ut.getWorldDirection(ve),g.position.copy(Ce).addScaledVector(ve,30),B.position.copy(Ce).addScaledVector(ve,36),g.quaternion.copy(ut.quaternion),B.quaternion.copy(ut.quaternion),Te.compile(e,ut),g.visible=z[0],B.visible=z[1],g.position.copy(K[0]),B.position.copy(K[1]),g.quaternion.copy(Le[0]),B.quaternion.copy(Le[1])}return{mesh:g,meshes:[g,B],update:Us,prewarm:os}}function Co(e,{poolSize:t=24,baseSize:o=6,colors:l=null,life:a=.35}={}){const y=new Cr(o,o),i=typeof document<"u"?document.createElement("canvas"):typeof OffscreenCanvas<"u"?new OffscreenCanvas(128,128):null;if(!i)throw new Error("No canvas available for explosion texture");i.width=i.height=128;const u=i.getContext("2d"),S=u.createRadialGradient(64,64,0,64,64,64);S.addColorStop(0,"rgba(255,255,255,1)"),S.addColorStop(.6,"rgba(255,255,255,0.4)"),S.addColorStop(1,"rgba(255,255,255,0)"),u.fillStyle=S,u.fillRect(0,0,128,128);const w=new zr(i);w.needsUpdate=!0;const Z=[16737826,16759586,16724770],d=l&&l.length?l:Z,E=[.8,.6,.85],f=d.map((N,$)=>new cn({color:N,map:w,transparent:!0,opacity:E[$%E.length],blending:_s,depthWrite:!1,side:ms})),D=[];for(let N=0;N<t;N++){const $=f[N%f.length],M=new xe(y,$);M.visible=!1,M.frustumCulled=!1,M.userData.life=0,M.userData.variant=N%f.length,e.add(M),D.push(M)}function W(N,$=null){const M=D.find(P=>!P.visible);if(!M)return;M.visible=!0;const ie=Number.isFinite($)?$:a;return M.userData.maxLife=ie,M.userData.life=ie,M.scale.setScalar(1),M.position.copy(N),M}function L(N,$=null){D.forEach(M=>{if(!M.visible)return;if(M.userData.life-=N,M.userData.life<=0){M.visible=!1;return}const ie=M.userData.maxLife??a,P=ie>0?M.userData.life/ie:0,V=M.userData.variant===1?.6:M.userData.variant===2?.85:.8;M.material.opacity=V*P;const k=Mn.lerp(1,2.5,1-P);M.scale.setScalar(k),$&&M.quaternion.copy($.quaternion)})}function x(N,$){const M=D.map(P=>({vis:P.visible,life:P.userData.life}));D.slice(0,Math.min(D.length,8)).forEach(P=>{P.visible=!0,P.userData.maxLife=a,P.userData.life=a,P.scale.setScalar(1)});const ie=N.getSize(new Vn);N.setSize(64,64,!1),N.render(e,$),N.setSize(ie.x,ie.y,!1),D.forEach((P,V)=>{P.visible=M[V].vis,P.userData.life=M[V].life})}return{spawn:W,update:L,prewarm:x}}function Vl(e,{speed:t=200,life:o=2,colour:l=65280,poolSize:a=30,cooldown:y=.18,bossMesh:i=null,damageBoss:u=()=>{},bossHitR2:S=400,stationMesh:w=null,damageStation:Z=()=>{},camera:d,getEnemies:E=()=>[],passageCollider:f=null,passageColliders:D=[],onEnemyKilled:W=()=>{},onShotFired:L=()=>{},onShotHit:x=()=>{}}={}){var ii;let N=!1,$=!1,M=1;const ie=l,P=65535,V=.3,k=V*.5,R=new tn(V,V,6).translate(0,0,3),g=new n,B=new n,me=new n,U=new n,H=[],C=new n,c=new Rt,Y=3*3,q=1.5,se=new cn({color:ie}),ne=Array.from({length:a},()=>{const _=new xe(R,se);return _.visible=!1,e.add(_),_}),fe=8,De=new cn({color:ie}),Me=Array.from({length:fe},()=>{const _=new xe(R,De);return _.visible=!1,e.add(_),_}),ge=3,Ae=.7,ye=120,pe=120,Ee=i,X=u,et=S,A=w,ke=((ii=w==null?void 0:w.userData)==null?void 0:ii.collider)??null,Qe=Z,Oe=d,Fe=E,qt=.3,Gt=.8,vt=3,_t=8,Ct=16,bt=(_t+Ct)*.5,Kt=65407,Bt=45152,$t=.5,Zt=.5,Ft=.5,Ue=-.85,wt=-1,tt=1.1,J=ye,Ce=pe,ve=6,_e=_t*2,Ie=Ct*2,Ze=$t*3,gt=.35,ct=vt,yt=vt*2,Ke=[];f&&Ke.push(f),Array.isArray(D)&&Ke.push(...D.filter(Boolean));const r=Math.max(40,a*2),T=0,I=V*2,he=.03,de=.175,oe=Co(e,{poolSize:r,baseSize:I,colors:[ie]}),at=Co(e,{poolSize:r,baseSize:I,colors:[P]}),nt=(_,ee)=>{var le;_!=null&&_.material&&((le=_.material.uniforms)!=null&&le.opacity?_.material.uniforms.opacity.value=ee:_.material.opacity=ee)},dt=()=>new zi({transparent:!0,depthWrite:!1,blending:_s,uniforms:{innerColor:{value:new ls(Kt)},outerColor:{value:new ls(Bt)},opacity:{value:.65}},vertexShader:`
    varying vec3 vNormal;
    varying vec3 vViewPosition;
    void main() {
      vNormal = normalize(normalMatrix * normal);
      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
      vViewPosition = -mvPosition.xyz;
      gl_Position = projectionMatrix * mvPosition;
    }
  `,fragmentShader:`
    uniform vec3 innerColor;
    uniform vec3 outerColor;
    uniform float opacity;
    varying vec3 vNormal;
    varying vec3 vViewPosition;
    void main() {
      vec3 viewDir = normalize(vViewPosition);
      float rim = 1.0 - clamp(dot(normalize(vNormal), viewDir), 0.0, 1.0);
      float t = smoothstep(0.0, 1.0, rim);
      vec3 color = mix(innerColor, outerColor, t);
      float edge = smoothstep(0.6, 1.0, rim);
      float alpha = opacity * (0.35 + 0.65 * (1.0 - edge));
      gl_FragColor = vec4(color, alpha);
    }
  `}),ue=new To(Gt,16,16),Vt=new cn({color:65407}),St=Array.from({length:8},()=>{const _=new xe(ue,Vt);return _.visible=!1,e.add(_),_});[{radius:_t,opacity:.9,material:new cn({color:Kt,transparent:!0,opacity:.9})},{radius:bt,opacity:.65,material:dt()},{radius:Ct,opacity:.4,material:new cn({color:Bt,transparent:!0,opacity:.4})}].forEach(_=>{const ee=new To(_.radius,16,16),le=new xe(ee,_.material);le.visible=!1,le.userData.life=0,le.userData.baseOpacity=_.opacity,e.add(le),H.push(le)});const Lt=new cn({color:13639455}),te=new cn({color:530995}),we=new cn({color:16777215}),p=new ss,h=new xe(new yl(tt,0),Lt);p.add(h);const m=new xe(new Yi(tt*.7,8),te);m.position.z=tt*.85,p.add(m);const ae=new ss,st=new xe(new tn(.18,.7,.06),we);st.position.set(-.12,0,0);const ot=new xe(new tn(.32,.22,.06),we);ot.position.set(.05,.2,0);const Ne=new xe(new tn(.32,.22,.06),we);Ne.position.set(.05,-.2,0),ae.add(st,ot,Ne),ae.position.z=m.position.z+.02,p.add(ae);const Be=Array.from({length:ve},()=>{const _=p.clone(!0),ee=new ss;return ee.add(_),ee.visible=!1,e.add(ee),ee}),Ht=[],je=new To(_e,12,12),be=new To(Ie,12,12),$e=new cn({color:65535,transparent:!0,opacity:.9,blending:_s,depthWrite:!1}),G=new cn({color:52479,transparent:!0,opacity:.35,blending:_s,depthWrite:!1}),Se=(Ie-_e)*1.15,rt=new Rr(_e*.25,Se,4),ce=new cn({color:30664,transparent:!0,opacity:.75,blending:_s,depthWrite:!1}),ht=new n(0,1,0),lt=[new n(1,0,0),new n(-1,0,0),new n(0,1,0),new n(0,-1,0),new n(0,0,1),new n(0,0,-1),new n(1,1,1),new n(1,1,-1),new n(1,-1,1),new n(-1,1,1),new n(-1,-1,1),new n(-1,1,-1)].map(_=>_.normalize()),Dt=()=>{const _=new ss,ee=new xe(je,$e.clone()),le=new xe(be,G.clone()),b=new ss;return lt.forEach(ze=>{const We=new xe(rt,ce.clone());We.quaternion.setFromUnitVectors(ht,ze),We.position.copy(ze).multiplyScalar(_e+Se*.5),b.add(We)}),_.add(ee),_.add(le),_.add(b),_.visible=!1,_.userData.life=0,_.userData.inner=ee,_.userData.outer=le,_.userData.spikes=b,_.userData.innerOpacity=ee.material.opacity,_.userData.outerOpacity=le.material.opacity,_.userData.spikeOpacity=ce.opacity,e.add(_),_};for(let _=0;_<3;_++)Ht.push(Dt());const kt=new Io(3,3.2,8),nn=new cn({color:65407,transparent:!0,opacity:1,side:ms}),pt=new xe(kt,nn);pt.visible=!1,e.add(pt);const fn=new Io(3.05,3.15,8),pn=new cn({color:6750131,transparent:!0,opacity:.6,side:ms}),Nt=new xe(fn,pn);Nt.visible=!1,e.add(Nt);const hn=new n,En=new n,ln=new Rt,mn=50,Ss=2/3,io=1,ao=.5,Ys=.6,ro=.3,ts=60,Us=16,os=new n(0,0,1),Te=new n(0,0,-1),ut=new n,z=new n,K=new n,Le=new n;new n,new n;const Re=new n,it=new n,At=new n,gn=new n,j=new bn,mt=new bn,Ot=new n;let Pn=1;const Zn=()=>Pn++;let is=!1;const gs=(_,ee)=>{var b;const le=(b=_==null?void 0:_.userData)==null?void 0:b.chargeNoseOffsetZ;return typeof le!="number"?Ft+Ue:le+ee+wt+Ue};function ys(_,ee,le,b){var jt,Wt;if(!_)return;const ze=(jt=_==null?void 0:_.userData)==null?void 0:jt.chargeNosePoint,We=typeof((Wt=_==null?void 0:_.userData)==null?void 0:Wt.chargeNosePad)=="number"?_.userData.chargeNosePad:wt,Xe=b??_.quaternion;if(ze&&ze.isVector3){le.copy(ze),_.localToWorld(le),Rn.set(0,0,1).applyQuaternion(Xe),le.addScaledVector(Rn,ee+We+Ue);return}_.getWorldPosition(le);const zt=gs(_,ee);Rn.set(0,0,zt).applyQuaternion(Xe),le.add(Rn)}function ks(_,ee,le,b){var Xe;if(!_)return null;const ze=b??_.quaternion,We=(Xe=_==null?void 0:_.userData)==null?void 0:Xe.chargeNosePoint;if(We&&We.isVector3)le.copy(We),_.localToWorld(le);else{_.getWorldPosition(le);const zt=gs(_,0);Rn.set(0,0,zt).applyQuaternion(ze),le.add(Rn)}return Rn.set(0,0,1).applyQuaternion(ze),le.addScaledVector(Rn,-T),ee!==0&&(Fn.set(1,0,0).applyQuaternion(ze),le.addScaledVector(Fn,ee)),le}function Bn(_,ee,le,b){if(!_||!(ee!=null&&ee.visible))return null;const ze=_.worldAABB;if(ze&&(At.set(Math.min(le.x,b.x),Math.min(le.y,b.y),Math.min(le.z,b.z)),gn.set(Math.max(le.x,b.x),Math.max(le.y,b.y),Math.max(le.z,b.z)),j.min.copy(At),j.max.copy(gn),!j.intersectsBox(ze)))return null;it.copy(b).sub(le);const We=it.length();if(We<1e-5)return null;it.multiplyScalar(1/We);const Xe=_.linecast(le,it,We);return Xe.hit?Xe:null}function Zs(_,ee){return Bn(ke,A,_,ee)}function Es(_,ee=.5){if(!ke||!(A!=null&&A.visible))return!1;const le=ke.worldAABB,b=Math.max(ee,.25);return le&&(mt.copy(le).expandByScalar(b),!mt.containsPoint(_))?!1:ke.testSphere(_,b).hit||ke.isPointInside(_)}function Ps(_,ee){var le,b,ze;for(const We of Ke){if(!We)continue;const Xe=We.mesh??We.root??null;if(Xe&&(!Xe.visible||(le=Xe.userData)!=null&&le.dead||((b=Xe.userData)==null?void 0:b.laserCollisionEnabled)===!1||(ze=Xe.userData)!=null&&ze.destructible&&Xe.userData.destructible.hp<=0))continue;const zt=We.worldAABB;let jt=!0;if(zt&&(At.set(Math.min(_.x,ee.x),Math.min(_.y,ee.y),Math.min(_.z,ee.z)),gn.set(Math.max(_.x,ee.x),Math.max(_.y,ee.y),Math.max(_.z,ee.z)),j.min.copy(At),j.max.copy(gn),jt=j.intersectsBox(zt)),!jt)continue;it.copy(ee).sub(_);const Wt=it.length();if(Wt>1e-5){it.multiplyScalar(1/Wt);const qe=We.linecast(_,it,Wt);if(qe.hit)return qe.collider=We,qe.mesh=We.mesh??We.root??null,qe}}return null}function Qs(_,ee){var zt,jt,Wt,qe;const le=(_==null?void 0:_.mesh)??((zt=_==null?void 0:_.collider)==null?void 0:zt.mesh)??null,b=(jt=le==null?void 0:le.userData)==null?void 0:jt.destructible;if(!(le!=null&&le.visible)||!b)return!1;const ze=((Wt=ee==null?void 0:ee.userData)==null?void 0:Wt.damage)??1,Xe=(Number.isFinite(b.hp)?b.hp:0)-ze;if(b.hp=Xe,(qe=le.userData)!=null&&qe.blink&&le.userData.blink(),Xe>0)return!0;if(le.visible=!1,le.userData.dead=!0,le.userData.laserCollisionEnabled=!1,typeof le.userData.onDestroyed=="function"){const Je=le.getWorldPosition?le.getWorldPosition(Ot):le.position;le.userData.onDestroyed(Je,le)}return!0}function ei(_,ee){if(!_||!ee)return null;let le=1/0,b=null;const ze=Fe?Fe():[];for(let We=0;We<ze.length;We++){const Xe=ze[We];if(!(Xe!=null&&Xe.visible))continue;const zt=Le.copy(Xe.position).sub(_),jt=-zt.dot(ee);if(jt<0||jt>ts)continue;const Wt=zt.lengthSq()-jt*jt;Wt<Us&&Wt<le&&(le=Wt,b=Xe)}return b}function lo(_,ee,le=.1){if(!_||!ee||!ee.visible)return;typeof ee.getWorldPosition=="function"?ee.getWorldPosition(Re):Re.copy(ee.position);const b=z.copy(Re).sub(_.position);b.lengthSq()>1e-6?b.normalize():b.copy(Te);const ze=ut.set(0,0,1).applyQuaternion(_.quaternion),We=K.copy(ze).lerp(b,le);We.lengthSq()>1e-6?We.normalize():We.copy(Te),_.quaternion.setFromUnitVectors(os,We)}let ds=!1,js=0,As=0,Dn=!1,ws=0,on=null,Tn=null,sn=null,Qt=0;const zn=1;let _n=!1;const Rn=new n,Fn=new n,bs=[0],Is=[-1,1];addEventListener("keydown",_=>{_.code==="Space"&&(ds=!0)}),addEventListener("keyup",_=>{_.code==="Space"&&(ds=!1,Dn||(As=0))});function Ts(){ds=!1,Dn=!1,As=0,ws=0,on&&(on.visible=!1,on=null),pt.visible=!1,Nt.visible=!1,Qt=0,sn&&(sn.userData.lockRing&&(sn.userData.lockRing.visible=!1),sn=null),Fe().forEach(_=>{_.userData.lockRing&&(_.userData.lockRing.visible=!1)})}function Rs(_){const ee=N?Is:bs,le=Zn();let b=!1;ee.forEach(ze=>{const We=ne.find(Xe=>!Xe.visible);if(We&&(_.getWorldPosition(We.position),_.getWorldQuaternion(We.quaternion),ze!==0&&(Fn.set(1,0,0).applyQuaternion(We.quaternion),We.position.addScaledVector(Fn,ze)),We.userData.prev=(We.userData.prev||new n).copy(We.position),We.userData.damage=M,We.userData.isBlue=$,We.userData.shotId=le,We.visible=!0,We.userData.life=o,b=!0,_)){const Xe=ks(_,ze,B,We.quaternion);Xe&&($?at:oe).spawn(Xe,he)}}),b&&!is&&L&&L(le,"laser")}function fs(_,ee){if(!_||!ee)return!1;const le=Me.find(ze=>!ze.visible);if(!le)return!1;ys(_,k,le.position,_.quaternion),C.copy(ee).sub(le.position),C.lengthSq()<1e-6?C.set(0,0,1):C.normalize(),c.setFromUnitVectors(os,C),le.quaternion.copy(c),le.userData.prev=(le.userData.prev||new n).copy(le.position),le.userData.damage=1,le.userData.isBlue=!1,le.userData.shotId=null,le.userData.life=o,le.visible=!0;const b=ks(_,0,B,_.quaternion);return b&&oe.spawn(b,he),!0}function ti(_,ee){_&&(ee?at:oe).spawn(_,de)}function co(_){if(on=St.find(le=>!le.visible),!on)return;_.getWorldQuaternion(on.quaternion);const ee=.5;ys(_,Gt*ee,on.position,on.quaternion),on.scale.setScalar(ee),on.visible=!0,on.userData.flown=0,on.userData.time=0,on.userData.prev=(on.userData.prev||new n).copy(on.position)}function ni(_){if(!_||_n)return!1;const ee=Be.find(ze=>!ze.visible);if(!ee)return!1;const le=Zn();_.getWorldQuaternion(ee.quaternion),ys(_,tt,ee.position,ee.quaternion),ee.visible=!0,ee.userData.flown=0,ee.userData.time=0,ee.userData.prev=(ee.userData.prev||new n).copy(ee.position),ee.userData.shotId=le,ee.userData.statHit=!1;const b=sn&&sn.visible?sn:null;return b?ee.userData.target=b:ee.userData.target=null,is||L&&L(le,"bomb"),!0}function Zi(_,ee,{allowFire:le=!0}={}){if(e.updateMatrixWorld(!1),H.forEach(b=>{if(!b.visible)return;if(b.userData.life-=_,b.userData.life<=0){b.visible=!1;return}const ze=1-b.userData.life/$t,We=Mn.lerp(Zt,1,ze);b.scale.setScalar(We);const Xe=b.userData.baseOpacity??.5;nt(b,Xe*(b.userData.life/$t)),Oe&&b.quaternion.copy(Oe.quaternion)}),Ht.forEach(b=>{var Xt;if(!b.visible)return;const ze=b.userData.life??0;if(ze<=0){b.visible=!1;return}const We=Math.min(_,ze);b.userData.life=ze-_;const Xe=1-b.userData.life/Ze,zt=Mn.lerp(gt,1,Xe);b.scale.setScalar(zt);const jt=b.userData.life/Ze,Wt=b.userData.inner,qe=b.userData.outer;Wt!=null&&Wt.material&&(Wt.material.opacity=b.userData.innerOpacity*jt),qe!=null&&qe.material&&(qe.material.opacity=b.userData.outerOpacity*jt);const Je=b.userData.spikes;(Xt=Je==null?void 0:Je.children)!=null&&Xt.length&&Je.children.forEach(An=>{An.material&&(An.material.opacity=b.userData.spikeOpacity*jt)}),We>0&&si(b.position,We,b.userData.hitTarget)&&b.userData.shotId&&!b.userData.statHit&&(b.userData.statHit=!0,x&&x(b.userData.shotId)),b.userData.life<=0&&(b.visible=!1)}),oe.update(_,Oe),at.update(_,Oe),le?_n&&(_n=!1):(ds=!1,_n||(Ts(),_n=!0)),js+=_,!Dn&&ds&&js>=y&&(Rs(ee),As++,js=0,As>=ge&&ds&&(Dn=!0,ws=0,co(ee),on.userData.target=sn)),Dn&&ds&&on){ws=Math.min(Ae,ws+_),ee.getWorldQuaternion(on.quaternion);const b=Mn.lerp(qt,Gt,ws/Ae);ys(ee,Gt*b,on.position,on.quaternion),on.scale.setScalar(b)}if(Dn&&!ds&&on){Dn=!1,As=0;const b=Zn();on.userData.shotId=b,on.userData.statHit=!1,is||L&&L(b,"charge"),on.userData.target=sn,sn&&(sn.userData.lockRing&&(sn.userData.lockRing.visible=!1),sn=null)}if(ee){hn.set(0,0,1),ee.getWorldDirection(hn).negate(),ee.getWorldPosition(En),pt.position.copy(En).addScaledVector(hn,-mn),Nt.position.copy(En).addScaledVector(hn,-mn*Ss),ln.setFromUnitVectors(os,hn),pt.quaternion.copy(ln),Nt.quaternion.copy(ln),nn.opacity=Dn?io:ao,pn.opacity=Dn?Ys:ro;const b=le&&ee.visible!==!1;pt.visible=b,Nt.visible=b}if(Dn)Tn=null,Tn=ei(En,hn),Tn&&(sn=Tn,Qt=0),Fe().forEach(b=>{b.userData.lockRing&&(b.userData.lockRing.visible=b===sn)});else if(sn){Qt+=_;const b=Qt>zn||!sn.visible;Fe().forEach(ze=>{ze.userData.lockRing&&(ze.userData.lockRing.visible=!1)}),b&&(sn=null)}else Fe().forEach(b=>{b.userData.lockRing&&(b.userData.lockRing.visible=!1)});St.forEach(b=>{var zt,jt,Wt;if(!b.visible||Dn&&b===on)return;me.copy(b.position),b.userData.prev=(b.userData.prev||new n).copy(me),b.translateZ(ye*_),b.userData.flown+=ye*_,b.userData.time+=_;let ze=!1;const We=Ps(me,b.position);if(We&&(b.position.copy(We.point),ze=!0),!ze&&ke){const qe=Zs(me,b.position);qe?(b.position.copy(qe.point),ze=!0):Es(b.position,Gt)&&(ze=!0)}let Xe=null;if(!ze){const qe=Fe?Fe():[];for(let Je=0;Je<qe.length;Je++){const Xt=qe[Je];if(!(Xt!=null&&Xt.visible))continue;const An=((zt=Xt.userData)==null?void 0:zt.chargeRadius)??((jt=Xt.userData)==null?void 0:jt.hitRadius),as=An?An*An:Y;if(Xt.getWorldPosition(g).distanceToSquared(b.position)<as){Xe=Xt,ze=!0;break}}}!ze&&Ee&&Ee.visible&&Ee.position.distanceToSquared(b.position)<et&&(ze=!0),lo(b,b.userData.target,.1),(b.userData.flown>=pe||b.userData.time>=q)&&(ze=!0),ze&&(xo(b.position,Xe,((Wt=b.userData)==null?void 0:Wt.shotId)??null),b.visible=!1)}),Be.forEach(b=>{var zt,jt,Wt;if(!b.visible)return;!b.userData.target&&sn&&sn.visible&&Dn&&(b.userData.target=sn),me.copy(b.position),b.userData.prev=(b.userData.prev||new n).copy(me),b.translateZ(J*_),b.userData.flown=(b.userData.flown??0)+J*_,b.userData.time=(b.userData.time??0)+_;let ze=!1;const We=Ps(me,b.position);if(We&&(b.position.copy(We.point),ze=!0),!ze&&ke){const qe=Zs(me,b.position);qe?(b.position.copy(qe.point),ze=!0):Es(b.position,tt)&&(ze=!0)}let Xe=null;if(!ze){const qe=Fe?Fe():[];for(let Je=0;Je<qe.length;Je++){const Xt=qe[Je];if(!(Xt!=null&&Xt.visible))continue;const An=((zt=Xt.userData)==null?void 0:zt.chargeRadius)??((jt=Xt.userData)==null?void 0:jt.hitRadius),as=An?An*An:Y;if(Xt.getWorldPosition(g).distanceToSquared(b.position)<as){Xe=Xt,ze=!0;break}}}!ze&&Ee&&Ee.visible&&Ee.position.distanceToSquared(b.position)<et&&(ze=!0),lo(b,b.userData.target,.1),(b.userData.flown>=Ce||b.userData.time>=q)&&(ze=!0),ze&&(fo(b.position,Xe,((Wt=b.userData)==null?void 0:Wt.shotId)??null),b.visible=!1)}),ne.forEach(b=>{var We,Xe;if(!b.visible)return;me.copy(b.position),b.userData.prev=(b.userData.prev||new n).copy(me),b.translateZ(t*_);const ze=Ps(me,b.position);ze&&(b.position.copy(ze.point),Qs(ze,b)&&((We=b.userData)!=null&&We.shotId)&&x&&x(b.userData.shotId),ti(ze.point,(Xe=b.userData)==null?void 0:Xe.isBlue),b.visible=!1),b.userData.life-=_,b.userData.life<=0&&(b.visible=!1)}),Me.forEach(b=>{if(!b.visible)return;me.copy(b.position),b.userData.prev=(b.userData.prev||new n).copy(me),b.translateZ(t*_);const ze=Ps(me,b.position);ze&&(b.position.copy(ze.point),Qs(ze,b),ti(ze.point,!1),b.visible=!1),b.userData.life-=_,b.userData.life<=0&&(b.visible=!1)})}function Qi(){const _=ne.filter(ee=>ee.visible);return Me.forEach(ee=>{ee.visible&&_.push(ee)}),_}function uo(_){var le,b;if(!_)return;if(!((le=_.userData)!=null&&le.noScore)){const ze=((b=_.userData)==null?void 0:b.scoreValue)??100;Ao(ze)}W&&_.getWorldPosition&&(_.getWorldPosition(U),W(U,_))}function Bs(_){var ee;!_||(ee=_.userData)!=null&&ee.dead||(_.visible=!1,_.userData.dead=!0,_.userData.lockRing&&(_.userData.lockRing.visible=!1),uo(_))}function xo(_,ee=null,le=null){var qe,Je,Xt,An,as,Ds;let b=!1;const ze=_t,We=new Set,Xe=xt=>xt==="eyes"||xt==="palmL"||xt==="palmR";let zt=!1;const jt=new Set;if((qe=ee==null?void 0:ee.userData)!=null&&qe.androssPart&&((Je=ee==null?void 0:ee.userData)!=null&&Je.damageFn)){const xt=ee.userData.androssOwner??ee;We.add(xt);const Jt=ee.userData.damageFn(vt);ee.userData.blink&&ee.userData.blink(),Jt&&uo(xt),zt=!0}const Wt=Fe?Fe():[];for(let xt=0;xt<Wt.length;xt++){const Jt=Wt[xt];if(!(Jt!=null&&Jt.visible)||!Jt.userData)continue;(Xt=Jt.updateMatrixWorld)==null||Xt.call(Jt,!1);const ai=((An=Jt.userData)==null?void 0:An.blastRadius)??ze;if(!(Jt.getWorldPosition(g).distanceToSquared(_)>=ai*ai)){if(Jt.userData.androssPart&&Jt.userData.damageFn){const po=Jt.userData.androssOwner??Jt;if(We.has(po)||!ee&&Xe(Jt.userData.androssPart))continue;We.add(po);const Ki=Jt.userData.damageFn(vt);Jt.userData.blink&&Jt.userData.blink(),Ki&&uo(po),zt=!0;continue}jt.has(Jt)||(jt.add(Jt),Jt.userData.blink&&Jt.userData.blink(),Jt.userData.flashT=.5,(as=Jt.userData.meshes)!=null&&as.forEach&&Jt.userData.meshes.forEach(po=>po.material.emissive.setRGB(1,0,0)),Jt.userData.hp>vt?Jt.userData.hp-=vt:Bs(Jt),zt=!0)}}!b&&Ee&&Ee.visible&&Ee.position.distanceToSquared(_)<et&&(X(vt),b=!0,zt=!0),Es(_,ze)&&(Qe(vt),(Ds=A==null?void 0:A.userData)!=null&&Ds.blink&&A.userData.blink(),zt=!0),H.forEach((xt,Jt)=>{xt.visible=!0,xt.position.copy(_),xt.scale.setScalar(Zt),xt.userData.life=$t,typeof xt.userData.baseOpacity!="number"&&(xt.userData.baseOpacity=.5),nt(xt,xt.userData.baseOpacity)}),zt&&le&&x&&x(le)}const Os=new Set,Xs=new Set,Mo=_=>_==="eyes"||_==="palmL"||_==="palmR";function Wo(_,ee,le=null){var We,Xe,zt,jt,Wt;if(!_||ee<=0)return!1;let b=!1;if(Os.clear(),Xs.clear(),(We=le==null?void 0:le.userData)!=null&&We.androssPart&&le.userData.damageFn){const qe=le.userData.androssOwner??le;Xs.add(qe);const Je=le.userData.damageFn(ee);le.userData.blink&&le.userData.blink(),Je&&uo(qe),b=!0}const ze=Fe?Fe():[];for(let qe=0;qe<ze.length;qe++){const Je=ze[qe];if(!(Je!=null&&Je.visible)||!Je.userData)continue;(Xe=Je.updateMatrixWorld)==null||Xe.call(Je,!1);const Xt=((zt=Je.userData)==null?void 0:zt.blastRadius)??_e;if(Je.getWorldPosition(g).distanceToSquared(_)>=Xt*Xt)continue;if(Je.userData.androssPart&&Je.userData.damageFn){const xt=Je.userData.androssOwner??Je;if(Xs.has(xt)||!le&&Mo(Je.userData.androssPart))continue;Xs.add(xt);const Jt=Je.userData.damageFn(ee);Je.userData.blink&&Je.userData.blink(),Jt&&uo(xt),b=!0;continue}if(Os.has(Je))continue;Os.add(Je),Je.userData.blink&&Je.userData.blink(),Je.userData.flashT=.5,(jt=Je.userData.meshes)!=null&&jt.forEach&&Je.userData.meshes.forEach(xt=>xt.material.emissive.setRGB(1,0,0));const as=Je.userData.hp??1;if(as<=1){Je.userData.hp=0,Bs(Je);continue}const Ds=as-ee;Je.userData.hp=Ds,Ds<=0&&Bs(Je),b=!0}return Ee&&Ee.visible&&Ee.position.distanceToSquared(_)<et&&(X(ee),b=!0),Es(_,_e)&&(Qe(ee),(Wt=A==null?void 0:A.userData)!=null&&Wt.blink&&A.userData.blink(),b=!0),b}function si(_,ee,le=null){if(!_||ee<=0)return!1;const b=ct*ee;return b<=0?!1:Wo(_,b,le)}function fo(_,ee=null,le=null){var We,Xe,zt,jt;const b=Ht.find(Wt=>!Wt.visible);if(!b)return;b.visible=!0,b.position.copy(_),b.scale.setScalar(gt),b.userData.life=Ze,b.userData.hitTarget=ee,b.userData.shotId=le,b.userData.statHit=!1,(We=b.userData.inner)!=null&&We.material&&(b.userData.inner.material.opacity=b.userData.innerOpacity),(Xe=b.userData.outer)!=null&&Xe.material&&(b.userData.outer.material.opacity=b.userData.outerOpacity),(jt=(zt=b.userData.spikes)==null?void 0:zt.children)!=null&&jt.length&&b.userData.spikes.children.forEach(Wt=>{Wt.material&&(Wt.material.opacity=b.userData.spikeOpacity)}),Wo(_,yt,ee)&&le&&!b.userData.statHit&&(b.userData.statHit=!0,x&&x(le))}function _o(_,ee=Oe){const le=ne.map(qe=>qe.visible),b=Me.map(qe=>qe.visible),ze=St.map(qe=>qe.visible),We=Be.map(qe=>qe.visible),Xe=Ht.map(qe=>qe.visible),zt=pt.visible,jt=Nt.visible;ne.forEach(qe=>qe.visible=!0),Me.forEach(qe=>qe.visible=!0),St.forEach(qe=>qe.visible=!0),Be.forEach(qe=>qe.visible=!0),pt.visible=!0,Nt.visible=!0,H.forEach(qe=>qe.visible=!0),Ht.forEach(qe=>qe.visible=!0),_.compile(e,ee);const Wt=_.getSize(new Vn);_.setSize(64,64,!1),_.render(e,ee),_.setSize(Wt.x,Wt.y,!1),ne.forEach((qe,Je)=>qe.visible=le[Je]),Me.forEach((qe,Je)=>qe.visible=b[Je]),St.forEach((qe,Je)=>qe.visible=ze[Je]),Be.forEach((qe,Je)=>qe.visible=We[Je]),pt.visible=zt,Nt.visible=jt,H.forEach(qe=>{qe.visible=!1,qe.userData.life=0}),Ht.forEach((qe,Je)=>{qe.visible=Xe[Je],qe.userData.life=0}),oe.prewarm(_,ee),at.prewarm(_,ee)}function Ks(_){if(!_)return;const ee=N,le=$,b=ne.map(Xe=>Xe.visible),ze=ne.map(Xe=>Xe.userData.life),We=ne.map(Xe=>Xe.userData.damage);N=!0,is=!0,Rs(_),is=!1,N=ee,$=le,ne.forEach((Xe,zt)=>{!b[zt]&&Xe.visible&&(Xe.visible=!1,Xe.userData.life=ze[zt]??0,Xe.userData.damage=We[zt])})}function oi(){const _=$?P:ie;M=$?2:1,se.color.setHex(_),ne.forEach(ee=>{ee.visible&&(ee.userData.damage=M)})}function ji(_=!0){$=_,oi()}function Xi(){N=!1,$=!1,oi()}return{update:Zi,getActive:Qi,enableDual:(_=!0)=>{N=_},enableBlue:ji,resetUpgrades:Xi,isDual:()=>N,isBlue:()=>$,clearInput:Ts,fireAllyShot:fs,fireBomb:ni,prewarm:_o,prewarmDual:Ks}}function Yl(e,{radius:t=12200,depth:o=500,count:l=2e4,size:a=.7,colour:y=16777215}={}){const i=new Float32Array(l*3),u=Math.max(1,t+o);for(let w=0;w<l;w++){const Z=Math.cbrt(Math.random())*u,d=new n().randomDirection().multiplyScalar(Z);i.set([d.x,d.y,d.z],w*3)}const S=new Li().setAttribute("position",new wl(i,3));e.add(new bl(S,new Dl({size:a,color:y})))}function Ul({asteroidGroup:e,laserSystem:t,enemyShips:o,enemyLasers:l,bossMesh:a,damageBoss:y,playerMesh:i,playerRadius:u,stationMesh:S,damageStation:w,asteroidPassage:Z=null,staticHazards:d=[],hazardPlayerCollisionEnabled:E=!0,hazardLaserCollisionEnabled:f=!0,hazardEnemyCollisionEnabled:D=!0,asteroidHazardCollisionEnabled:W=!1,onLaserHit:L=()=>{},onPlayerHit:x=()=>{},onEnemyDestroyed:N=()=>{},onEnemyNeutralized:$=()=>{},onAsteroidDestroyed:M=()=>{},onShotHit:ie=()=>{},isRolling:P=()=>!1,androssBeams:V=()=>[]}){var tt;const k=new n,R=new n,g=new n,B=new n,me=new n,U=new n,H=new bn,C=new n,c=new n,Y=100,q=120,se=120,ne=new n,fe=new n,De=new WeakMap;new bn;const Me=new n,ge=new n,Ae=new n,ye=new no,pe=new n,Ee=new n;new n;const X=new n,et=new n,A=new n,ke=.5;let Qe=0;const Oe=((tt=S==null?void 0:S.userData)==null?void 0:tt.collider)??null,Fe=[];function qt(J){var _e,Ie,Ze;if(!J)return;const Ce=J.getMesh?J.getMesh():J.mesh??null,ve=J.collider??((_e=Ce==null?void 0:Ce.userData)==null?void 0:_e.collider)??null;!Ce||!ve||Fe.push({mesh:Ce,collider:ve,laserCollisionEnabled:((Ie=Ce.userData)==null?void 0:Ie.laserCollisionEnabled)!==!1,gateCylinder:((Ze=Ce.userData)==null?void 0:Ze.gateCylinder)??null,playerState:{insideTimer:0,colliding:!1},enemyState:new WeakMap})}qt(Z),(d??[]).forEach(qt);let Gt=0,vt=!1;function _t(J){if(!J||J.userData.dead)return;J.visible=!1,J.userData.dead=!0;const Ce=J.getWorldPosition?J.getWorldPosition(g):J.position;M(Ce)}function Ct(J,{awardScore:Ce=!0}={}){var _e;if(!J)return;(Ce&&!((_e=J.userData)!=null&&_e.noScore)?N:$)(J.position,J)}function bt(J,{awardScore:Ce=!0}={}){var _e,Ie,Ze,gt;if(!(J!=null&&J.visible)||!J.userData)return!1;if(J.userData.androssPart&&J.userData.damageFn){const ct=J.userData.androssOwner??J,yt=J.userData.damageFn(1);return yt&&Ct(ct,{awardScore:Ce}),yt}const ve=J.userData.hp??1;return ve>1?(J.userData.hp=ve-1,(Ie=(_e=J.userData).blink)==null||Ie.call(_e),!1):((gt=(Ze=J.userData).blink)==null||gt.call(Ze),J.visible=!1,J.userData.dead=!0,J.userData.lockRing&&(J.userData.lockRing.visible=!1),Ct(J,{awardScore:Ce}),!0)}function Kt(J,Ce,ve,_e){if(!J||!(Ce!=null&&Ce.visible)||J.worldAABB&&(me.set(Math.min(ve.x,_e.x),Math.min(ve.y,_e.y),Math.min(ve.z,_e.z)),U.set(Math.max(ve.x,_e.x),Math.max(ve.y,_e.y),Math.max(ve.z,_e.z)),H.min.copy(me),H.max.copy(U),!H.intersectsBox(J.worldAABB)))return!1;const Ie=J.worldAABB;if(Ie&&(me.set(Math.min(ve.x,_e.x),Math.min(ve.y,_e.y),Math.min(ve.z,_e.z)),U.set(Math.max(ve.x,_e.x),Math.max(ve.y,_e.y),Math.max(ve.z,_e.z)),H.min.copy(me),H.max.copy(U),!H.intersectsBox(Ie)))return!1;B.copy(_e).sub(ve);const Ze=B.length();if(Ze<1e-5)return!1;B.multiplyScalar(1/Ze);const gt=J.linecast(ve,B,Ze);return gt.hit?(_e.copy(gt.point),!0):!1}function Bt(J,Ce,ve){let _e=0,Ie=1;const Ze=Ce.x-J.x,gt=Ce.y-J.y,ct=Ce.z-J.z;if(Math.abs(Ze)<1e-8){if(J.x<ve.min.x||J.x>ve.max.x)return!1}else{const yt=1/Ze;let Ke=(ve.min.x-J.x)*yt,r=(ve.max.x-J.x)*yt;if(Ke>r){const T=Ke;Ke=r,r=T}if(_e=Math.max(_e,Ke),Ie=Math.min(Ie,r),_e>Ie)return!1}if(Math.abs(gt)<1e-8){if(J.y<ve.min.y||J.y>ve.max.y)return!1}else{const yt=1/gt;let Ke=(ve.min.y-J.y)*yt,r=(ve.max.y-J.y)*yt;if(Ke>r){const T=Ke;Ke=r,r=T}if(_e=Math.max(_e,Ke),Ie=Math.min(Ie,r),_e>Ie)return!1}if(Math.abs(ct)<1e-8){if(J.z<ve.min.z||J.z>ve.max.z)return!1}else{const yt=1/ct;let Ke=(ve.min.z-J.z)*yt,r=(ve.max.z-J.z)*yt;if(Ke>r){const T=Ke;Ke=r,r=T}if(_e=Math.max(_e,Ke),Ie=Math.min(Ie,r),_e>Ie)return!1}return!0}function $t(J,Ce,ve){var _e;for(const Ie of Fe)if((_e=Ie.mesh)!=null&&_e.visible&&Ie.laserCollisionEnabled!==!1){if(Ie.gateZ!==void 0&&Ie.gateHalfZ!==void 0){const Ze=J.z,gt=Ce.z,ct=Ie.gateHalfZ+80;if(Math.abs(Ze-Ie.gateZ)>ct&&Math.abs(gt-Ie.gateZ)>ct)continue}if(Ie.gateCylinder){const Ze=Ie.gateCylinder,gt=Math.min(J.y,Ce.y);if(Math.max(J.y,Ce.y)<Ze.minY||gt>Ze.maxY||Ft(Ze.x,Ze.z,J,Ce)>Ze.radius*Ze.radius)continue}if(Kt(Ie.collider,Ie.mesh,J,Ce))return ve&&ve(Ie),!0}return!1}function Zt(J,Ce=1){var gt;const ve=J==null?void 0:J.mesh,_e=(gt=ve==null?void 0:ve.userData)==null?void 0:gt.destructible;if(!(ve!=null&&ve.visible)||!_e)return!1;const Ze=(Number.isFinite(_e.hp)?_e.hp:0)-Ce;if(_e.hp=Ze,Ze>0)return!1;if(ve.visible=!1,ve.userData.dead=!0,ve.userData.laserCollisionEnabled=!1,typeof ve.userData.onDestroyed=="function"){const ct=ve.getWorldPosition?ve.getWorldPosition(A):ve.position;ve.userData.onDestroyed(ct,ve)}return!0}function Ft(J,Ce,ve,_e){const Ie=_e.x-ve.x,Ze=_e.z-ve.z,gt=J-ve.x,ct=Ce-ve.z,yt=Ie*Ie+Ze*Ze;let Ke=0;yt>1e-8&&(Ke=(gt*Ie+ct*Ze)/yt),Ke<0?Ke=0:Ke>1&&(Ke=1);const r=ve.x+Ie*Ke-J,T=ve.z+Ze*Ke-Ce;return r*r+T*T}function Ue(J=0){var Ie,Ze,gt,ct,yt,Ke;if(Qe>0&&J>0&&(Qe=Math.max(0,Qe-J)),f&&Fe.length){const r=t.getActive();for(let I=0;I<r.length;I++){const he=r[I];if(!he.visible)continue;const de=he.userData.prev??he.position;$t(de,he.position,oe=>{var nt;const at=((nt=he.userData)==null?void 0:nt.damage)??1;Zt(oe,at)})&&(he.visible=!1)}const T=l();for(let I=0;I<T.length;I++){const he=T[I];if(!(he!=null&&he.position))continue;const de=he.prev??he.position;$t(de,he.position)&&he.userData&&(he.userData.life=0)}}if(a.visible){const r=t.getActive();for(let I=0;I<r.length;I++){const he=r[I];if(he.visible&&!(Math.abs(he.position.z-a.position.z)>q)&&a.position.distanceToSquared(he.position)<Y){const de=((Ie=he.userData)==null?void 0:Ie.damage)??1;(Ze=he.userData)!=null&&Ze.shotId&&ie(he.userData.shotId),he.visible=!1,y(de)}}const T=l();for(let I=0;I<T.length;I++){const he=T[I];!he.visible||!he.userData.bounced||Math.abs(he.position.z-a.position.z)>q||a.position.distanceToSquared(he.position)<Y&&(he.visible=!1,y(1))}}t.getActive().forEach(r=>{e.children.forEach(T=>{var he;if(!T.visible)return;const I=T.scale.x;r.position.distanceToSquared(T.position)<I*I&&(_t(T),r.visible=!1,(he=r.userData)!=null&&he.shotId&&ie(r.userData.shotId),L())})}),l().forEach(r=>{if(!(r!=null&&r.position))return;const T=i.getWorldPosition(k).z;Math.abs(r.position.z-T)>se||e.children.forEach(I=>{if(!I.visible||I.userData.dead||Math.abs(I.position.z-r.position.z)>se)return;const he=I.scale.x;r.position.distanceToSquared(I.position)<he*he&&(_t(I),r.userData&&(r.userData.life=0))})}),o().forEach(r=>{e.children.forEach(T=>{var he,de;if(!T.visible||T.userData.dead||!r.visible)return;const I=T.scale.x*1.2;r.position.distanceToSquared(T.position)<I*I&&(r.userData.collided=!0,(de=(he=r.userData).finishPath)==null||de.call(he,"collision"),r.userData.hp>1?(r.userData.hp--,r.userData.blink(),_t(T),r.userData.hp===0&&(r.visible=!1)):(r.userData.blink(),_t(T),r.visible=!1))})});const Ce=i.getWorldPosition(k);l().forEach(r=>{var he;if(!(!(r!=null&&r.position)||(((he=r.userData)==null?void 0:he.bounced)??!1)||!(Ce.distanceToSquared(r.position)<(u+.5)**2))){if(P()){r.userData&&(r.userData.bounced=!0,r.userData.dir*=-1);return}r.userData&&(r.userData.life=0),x(r.position)}});const ve=V?V():[];if(ve&&ve.length)for(const r of ve){if(!(r!=null&&r.visible)||!r.geometry)continue;r.updateMatrixWorld(!0),r.geometry.boundingBox||(ct=(gt=r.geometry).computeBoundingBox)==null||ct.call(gt);const T=r.geometry.boundingBox;if(!T)continue;ge.set(0,0,T.min.z).applyMatrix4(r.matrixWorld),Ae.set(0,0,T.max.z).applyMatrix4(r.matrixWorld);const he=(T.max.x-T.min.x)*(((yt=r.scale)==null?void 0:yt.x)??1)*.5+.1;if(wt(Ce,ge,Ae,Me)<=he*he&&Qe<=0){A.copy(Ce).sub(Me),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(Ce):A.copy(Ce),x(A),Qe=ke;break}}t.getActive().forEach(r=>{o().forEach(T=>{var ue,Vt,St,Et,Lt,te;if(!r.visible||!T.visible)return;const I=T.userData.hitRadius??3,he=T.getWorldPosition?T.getWorldPosition(R):T.position,de=(ue=T.userData)==null?void 0:ue.hitBoxes,oe=((Vt=r.userData)==null?void 0:Vt.prev)??r.position;let at=!1;if(de&&de.length){X.copy(oe),et.copy(r.position),T.worldToLocal(X),T.worldToLocal(et);for(let we=0;we<de.length;we++)if(Bt(X,et,de[we])){at=!0;break}if(!at)return}else if(at=r.position.distanceToSquared(he)<I*I,!at)return;const nt=((St=r.userData)==null?void 0:St.damage)??1;if(T.userData.androssPart&&T.userData.damageFn){const we=T.userData.androssOwner??T,p=T.userData.damageFn(nt);r.visible=!1,(Et=r.userData)!=null&&Et.shotId&&ie(r.userData.shotId),p&&Ct(we);return}const dt=T.userData.hp??1;dt>nt?(T.userData.hp=dt-nt,T.userData.blink(),r.visible=!1,(Lt=r.userData)!=null&&Lt.shotId&&ie(r.userData.shotId)):(T.userData.blink(),r.visible=T.visible=!1,T.userData.dead=!0,(te=r.userData)!=null&&te.shotId&&ie(r.userData.shotId),Ct(T))})}),l().forEach(r=>{var T;r!=null&&r.position&&(T=r.userData)!=null&&T.bounced&&o().forEach(I=>{var dt,ue,Vt,St;if(((dt=r.userData)==null?void 0:dt.life)<=0||r.visible===!1||!I.visible||!((ue=I.userData)!=null&&ue.hp)||!((Vt=I.userData)!=null&&Vt.blink))return;const he=I.userData.hitRadius??3,de=I.getWorldPosition?I.getWorldPosition(R):I.position,oe=(St=I.userData)==null?void 0:St.hitBoxes,at=r.prev??r.position;let nt=!1;if(oe&&oe.length?(X.copy(at),et.copy(r.position),I.worldToLocal(X),I.worldToLocal(et),nt=oe.some(Et=>Bt(X,et,Et))):nt=r.position.distanceToSquared(de)<he*he,nt){if(I.userData.androssPart&&I.userData.damageFn){const Et=I.userData.androssOwner??I,Lt=I.userData.damageFn(1);r.userData&&(r.userData.life=0),Lt&&Ct(Et);return}I.userData.hp>1?(I.userData.hp--,I.userData.blink(),r.userData&&(r.userData.life=0)):(I.userData.blink(),r.userData&&(r.userData.life=0),I.visible=!1,I.userData.dead=!0,Ct(I))}})});const _e=i.getWorldPosition(k).z;if(e.children.forEach(r=>{if(!r.visible||Math.abs(r.position.z-_e)>se)return;const T=r.scale.x*1.2,I=i.getWorldPosition(k);I.distanceToSquared(r.position)<(u+T)*(u+T)&&(_t(r),A.copy(I).sub(r.position),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(I):A.copy(I),x(A))}),E&&J>0&&Fe.length){const r=i.getWorldPosition(R);Fe.forEach(T=>{var nt,dt,ue;const I=T.playerState;if(!T.collider||!((nt=T.mesh)!=null&&nt.visible)){I.insideTimer=0,I.colliding=!1;return}if(T.gateZ!==void 0&&T.gateHalfZ!==void 0){const Vt=T.gateHalfZ+80;if(Math.abs(r.z-T.gateZ)>Vt){I.insideTimer=0,I.colliding=!1;return}}if(T.collider.worldAABB&&!T.collider.worldAABB.intersectsSphere(ye.set(r,u))){I.insideTimer=0,I.colliding=!1;return}const he=T.collider.testSphere(r,u),de=!!((ue=(dt=T.mesh)==null?void 0:dt.userData)!=null&&ue.skipInsideCheck),oe=he.hit||!de&&T.collider.isPointInside(r),at=he.hit?he.point:r;if(oe)for(I.colliding||(A.copy(r).sub(at),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(r):A.copy(r),x(A),I.insideTimer=0),I.colliding=!0,I.insideTimer+=J;I.insideTimer>=1;)A.copy(r).sub(at),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(r):A.copy(r),x(A),I.insideTimer-=1;else I.insideTimer=0,I.colliding=!1})}else E&&Fe.length&&Fe.forEach(r=>{r.playerState.insideTimer=0,r.playerState.colliding=!1});if(D&&J>0&&Fe.length){const r=o();r&&r.length?Fe.forEach(T=>{var de;if(!T.collider||!((de=T.mesh)!=null&&de.visible)){T.enemyState=new WeakMap;return}const I=T.gateHalfZ!==void 0?T.gateHalfZ+80:null,he=T.enemyState;r.forEach(oe=>{var Et,Lt,te,we,p,h,m,ae,st;if(!(oe!=null&&oe.visible)||(Et=oe.userData)!=null&&Et.dead)return;if(I!==null&&Math.abs(oe.position.z-T.gateZ)>I){const ot=he.get(oe);ot&&(ot.insideTimer=0,ot.colliding=!1);return}const at=((Lt=oe.userData)==null?void 0:Lt.hitRadius)??3,nt=oe.getWorldPosition?oe.getWorldPosition(R):oe.position;if(T.collider.worldAABB&&!T.collider.worldAABB.intersectsSphere(ye.set(nt,at))){const ot=he.get(oe);ot&&(ot.insideTimer=0,ot.colliding=!1);return}const dt=he.get(oe)??{insideTimer:0,colliding:!1},ue=T.collider.testSphere(nt,at),Vt=!!((we=(te=T.mesh)==null?void 0:te.userData)!=null&&we.skipInsideCheck);if(ue.hit||!Vt&&T.collider.isPointInside(nt)){if(oe.userData.collided=!0,(h=(p=oe.userData).finishPath)==null||h.call(p,"collision"),!dt.colliding){if(bt(oe,{awardScore:!1})){he.delete(oe);return}dt.insideTimer=0}for(dt.colliding=!0,dt.insideTimer+=J;dt.insideTimer>=1&&oe.visible&&!((m=oe.userData)!=null&&m.dead)&&(bt(oe,{awardScore:!1}),!(!oe.visible||(ae=oe.userData)!=null&&ae.dead));)dt.insideTimer-=1}else dt.insideTimer=0,dt.colliding=!1;!oe.visible||(st=oe.userData)!=null&&st.dead?he.delete(oe):he.set(oe,dt)})}):Fe.forEach(T=>{T.enemyState=new WeakMap})}else D&&Fe.length&&Fe.forEach(r=>{r.enemyState=new WeakMap});if(W&&Fe.length&&e.children.forEach(r=>{var I,he,de;if(!r.visible||r.userData.dead)return;const T=r.scale.x;for(const oe of Fe){if(!oe.collider||!((I=oe.mesh)!=null&&I.visible))continue;if(oe.collider.worldAABB){oe.collider.worldAABB.getCenter(pe),oe.collider.worldAABB.getSize(Ee);const ue=Ee.z*.5;if(Math.abs(r.position.z-pe.z)>ue+150)continue}if(oe.collider.worldAABB&&!oe.collider.worldAABB.intersectsSphere(ye.set(r.position,T)))continue;const at=oe.collider.testSphere(r.position,T),nt=!!((de=(he=oe.mesh)==null?void 0:he.userData)!=null&&de.skipInsideCheck);if(at.hit||!nt&&oe.collider.isPointInside(r.position)){_t(r);break}}}),Oe&&(S!=null&&S.visible)&&J>0){const r=i.getWorldPosition(R);if((Ke=Oe.worldAABB)!=null&&Ke.containsPoint(r)){const T=Oe.testSphere(r,u),I=T.hit||Oe.isPointInside(r),he=T.hit?T.point:r;if(I)for(vt||(A.copy(r).sub(he),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(r):A.copy(r),x(A),Gt=0),vt=!0,Gt+=J;Gt>=1;)A.copy(r).sub(he),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(r):A.copy(r),x(A),Gt-=1;else Gt=0,vt=!1}else Gt=0,vt=!1}else Gt=0,vt=!1;l().forEach(r=>{var T;r!=null&&r.position&&(T=r.userData)!=null&&T.bounced&&o().forEach(I=>{var at,nt;if(!I.visible||!((at=I.userData)!=null&&at.hp)||!((nt=I.userData)!=null&&nt.blink))return;const he=I.userData.hitRadius??3,de=I.getWorldPosition?I.getWorldPosition(R):I.position;r.position.distanceToSquared(de)<he*he&&(I.userData.hp>1?(I.userData.hp--,I.userData.blink(),r.userData&&(r.userData.life=0)):(I.userData.blink(),r.userData&&(r.userData.life=0),I.visible=!1,I.userData.dead=!0,Ct(I)))})}),o().forEach(r=>{var nt,dt,ue,Vt;if(!r.visible){De.delete(r);return}const T=(nt=r.userData)==null?void 0:nt.androssPart;if(T==="eyes"||T==="palmL"||T==="palmR")return;const I=i.getWorldPosition(k),he=(dt=r.userData)==null?void 0:dt.handCollider,de=((ue=r.userData)==null?void 0:ue.androssPart)==="handL"||((Vt=r.userData)==null?void 0:Vt.androssPart)==="handR";let oe=!1;const at=Math.max(0,(De.get(r)??0)-J);if(De.set(r,at),he!=null&&he.box){const St=r.worldToLocal(ne.copy(I)),Et=he.box.min,Lt=he.box.max;fe.set(Mn.clamp(St.x,Et.x,Lt.x),Mn.clamp(St.y,Et.y,Lt.y),Mn.clamp(St.z,Et.z,Lt.z));const te=u*.4;oe=St.distanceToSquared(fe)<te*te}else oe=I.distanceToSquared(r.position)<(u+3)**2;if(oe){if(de){at===0&&(A.copy(fe).applyMatrix4(r.matrixWorld),A.copy(I).sub(A),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(I):A.copy(I),x(A),De.set(r,.75));return}r.visible=!1,Ct(r),A.copy(I).sub(r.position),A.lengthSq()>1e-6?A.normalize().multiplyScalar(u).add(I):A.copy(I),x(A)}}),Oe&&(S!=null&&S.visible)&&(t.getActive().forEach(r=>{var I,he;if(!r.visible)return;const T=r.userData.prev??r.position;if(Kt(Oe,S,T,r.position)){const de=((I=r.userData)==null?void 0:I.damage)??1;r.visible=!1,(he=r.userData)!=null&&he.shotId&&ie(r.userData.shotId),w==null||w(de)}}),l().forEach(r=>{var I;if(!(r!=null&&r.position)||!((I=r.userData)!=null&&I.bounced))return;const T=r.prev??r.position;Kt(Oe,S,T,r.position)&&(r.userData&&(r.userData.life=0),w==null||w(1))}))}function wt(J,Ce,ve,_e=null){C.copy(ve).sub(Ce);const Ie=C.lengthSq();if(Ie===0)return _e&&_e.copy(Ce),J.distanceToSquared(Ce);c.copy(J).sub(Ce);const Ze=Math.max(0,Math.min(1,c.dot(C)/Ie));return _e&&_e.copy(Ce).addScaledVector(C,Ze),c.copy(Ce).addScaledVector(C,Ze).distanceToSquared(J)}return{update:Ue}}const Fr=typeof document>"u"||typeof window>"u"||globalThis.__IS_RENDER_WORKER,ha=!Fr&&!!globalThis.__SHOW_DIAGNOSTICS__;let gi=0,la=0,Do=null,Pi=null;ha?(Do=document.createElement("div"),Object.assign(Do.style,{position:"fixed",right:"8px",bottom:"4px",font:"14px monospace",color:"#00ff00",pointerEvents:"none",textAlign:"right"}),document.body.appendChild(Do)):Fr&&typeof(self==null?void 0:self.postMessage)=="function"&&globalThis.__SHOW_DIAGNOSTICS__&&(Pi=e=>self.postMessage({type:"diag",payload:e}));let Bi="";function Zl(e=[]){if(!Do)return;const t=e.join("<br>");t!==Bi&&(Bi=t,Do.innerHTML=t)}function Ql(e,t=[]){if(!(!ha&&!Pi)&&(gi+=e,la+=1,gi>=.5)){const o=Math.round(la/gi),l=[`${o} FPS`,...t];if(ha&&Do){const a=l.join("<br>");a!==Bi&&(Bi=a,Do.innerHTML=a)}else Pi&&Pi({fps:o,lines:l});gi=la=0}}const jl=[],ca=new Map,Xl=new Un;async function Kl(e){if(ca.has(e))return ca.get(e).clone(!0);const t=await Xl.loadAsync(e);return ca.set(e,t.scene),t.scene.clone(!0)}async function vs(e,{spawnArray:t,playerObj:o,railCurve:l,playerSpeed:a,boltPool:y=null,canFire:i=null,modelPath:u="./models/dark1.glb",yaw:S=0,fireDir:w=-1,orbitRadius:Z=0,orbitRate:d=0,diagSpeed:E=0,diagVec:f=null,lateralAmp:D=0,lateralHz:W=0,verticalAmp:L=0,verticalHz:x=0,retreatDist:N=50,despawnDelay:$=1/0,behaviour:M={},camera:ie,dualGun:P=!1,gunSpacing:V=0,fireInterval:k=1.2,fireOffsetZ:R=0,forwardAxis:g=null,burstCount:B=0,burstInterval:me=0,burstPause:U=0,passLoop:H=!1,passDuration:C=6,passAhead:c=120,passBehind:Y=20,passFireWindow:q=80,orientToVelocity:se=!1,orientToPlayerWhenFiring:ne=!1,glowOffset:fe=null,hazardColliders:De=[],hazardEntries:Me=null,bakedPaths:ge=null,useBakedPaths:Ae=!0,manualPoolSize:ye=0,materialMode:pe="standard",editorGroup:Ee=null}){var ut;let X=!1;M&&("despawnDelay"in M&&($=M.despawnDelay),"yaw"in M&&(S=M.yaw),"fireDir"in M&&(w=M.fireDir),"orbitRadius"in M&&(Z=M.orbitRadius),"orbitRate"in M&&(d=M.orbitRate),"diagSpeed"in M&&(E=M.diagSpeed),"diagVec"in M&&(f=M.diagVec),"lateralAmp"in M&&(D=M.lateralAmp),"lateralHz"in M&&(W=M.lateralHz),"verticalAmp"in M&&(L=M.verticalAmp),"verticalHz"in M&&(x=M.verticalHz),"dualGun"in M&&(P=M.dualGun),"gunSpacing"in M&&(V=M.gunSpacing),"fireInterval"in M&&(k=M.fireInterval),"fireOffsetZ"in M&&(R=M.fireOffsetZ),"forwardAxis"in M&&(g=M.forwardAxis),"burstCount"in M&&(B=M.burstCount),"burstInterval"in M&&(me=M.burstInterval),"burstPause"in M&&(U=M.burstPause),"passLoop"in M&&(H=M.passLoop),"passDuration"in M&&(C=M.passDuration),"passAhead"in M&&(c=M.passAhead),"passBehind"in M&&(Y=M.passBehind),"passFireWindow"in M&&(q=M.passFireWindow),"orientToVelocity"in M&&(se=M.orientToVelocity),"orientToPlayerWhenFiring"in M&&(ne=M.orientToPlayerWhenFiring),"glowOffset"in M&&(fe=M.glowOffset),"retreatDist"in M&&(N=M.retreatDist),M&&"backpedal"in M&&(X=M.backpedal));const et=Array.isArray(t)?t:[];if(et.length===0&&ye<=0)return{update:()=>{},getActiveShips:()=>[]};const A=await Kl(u);A.scale.setScalar(5);const ke=pe==="lambert",Qe=new Rt().setFromAxisAngle(new n(0,1,0),S),Oe=g&&g.isVector3?g.clone().normalize():null,Fe=1.2,qt=y??((ut=e.userData)==null?void 0:ut.boltPool)??null,Gt=B>0&&me>0,vt=[],_t=new n,Ct=new n,bt=new Rt,Kt=new Rt,Bt=new n,$t=new n,Zt=new n,Ft=new n(0,0,1),Ue=new n,wt=new n,tt=new n,J=new n,Ce=new n,ve=new bn;function _e(z){var Re,it,At;if(!z)return;const K=z.getMesh?z.getMesh():z.mesh??null,Le=z.collider??((Re=K==null?void 0:K.userData)==null?void 0:Re.collider)??null;!K||!Le||vt.push({mesh:K,collider:Le,laserCollisionEnabled:((it=K.userData)==null?void 0:it.laserCollisionEnabled)!==!1,gateCylinder:((At=K.userData)==null?void 0:At.gateCylinder)??null})}(Array.isArray(Me)?Me:[]).forEach(_e);function Ze(z,K,Le,Re){const it=Re.x-Le.x,At=Re.z-Le.z,gn=z-Le.x,j=K-Le.z,mt=it*it+At*At;let Ot=0;mt>1e-8&&(Ot=(gn*it+j*At)/mt),Ot<0?Ot=0:Ot>1&&(Ot=1);const Pn=Le.x+it*Ot-z,Zn=Le.z+At*Ot-K;return Pn*Pn+Zn*Zn}function gt(z,K){var Re,it,At;if(!vt.length)return!0;tt.copy(K).sub(z);const Le=tt.length();if(Le<=1e-5)return!0;tt.multiplyScalar(1/Le),J.set(Math.min(z.x,K.x),Math.min(z.y,K.y),Math.min(z.z,K.z)),Ce.set(Math.max(z.x,K.x),Math.max(z.y,K.y),Math.max(z.z,K.z)),ve.set(J,Ce);for(let gn=0;gn<vt.length;gn++){const j=vt[gn];if((Re=j.mesh)!=null&&Re.visible&&j.laserCollisionEnabled!==!1){if(j.gateCylinder){const mt=j.gateCylinder,Ot=Math.min(z.y,K.y);if(Math.max(z.y,K.y)<mt.minY||Ot>mt.maxY||Ze(mt.x,mt.z,z,K)>mt.radius*mt.radius)continue}if(!((it=j.collider)!=null&&it.worldAABB&&!ve.intersectsBox(j.collider.worldAABB))&&(At=j.collider)!=null&&At.linecast){const mt=j.collider.linecast(z,tt,Le);if(mt!=null&&mt.hit)return!1}}}return!0}function ct(z){if(!P){yt(z,0);return}const K=z.userData.barrelSide;yt(z,K*V),z.userData.barrelSide=-K}function yt(z,K){if(!qt)return;const Le=qt.alloc({big:!1,life:Fe,dir:w,bounced:!1});if(!Le)return;z.getWorldPosition(Ct),z.getWorldQuaternion(bt);let Re=bt,it=null;const At=w>=0?1:-1;Oe&&(it=_t.copy(Oe).applyQuaternion(bt),Kt.setFromUnitVectors(Ft,it),Re=Kt),P&&(Bt.set(0,1,0).applyQuaternion(bt),$t.set(0,0,-1).applyQuaternion(bt),Ct.addScaledVector(Bt,1.8),Ct.addScaledVector($t,1.5)),K&&(Zt.set(1,0,0).applyQuaternion(bt),Ct.addScaledVector(Zt,K)),R&&(Oe?Ct.addScaledVector(it,R*At):(_t.set(0,0,1).applyQuaternion(bt),Ct.addScaledVector(_t,R*At))),qt.setTransform(Le,Ct,Re)}const Ke=new Io(1.6,1.9,4),r=new cn({color:65407,side:ms}),T=new Yi(.2,12);T.scale(1.4,.85,1);const I=typeof document<"u"?document.createElement("canvas"):typeof OffscreenCanvas<"u"?new OffscreenCanvas(64,64):null;if(!I)throw new Error("No canvas available for glow texture");I.width=I.height=64;const he=I.getContext("2d"),de=he.createRadialGradient(32,32,0,32,32,32);de.addColorStop(0,"rgba(255,255,255,1)"),de.addColorStop(.5,"rgba(255,255,255,0.35)"),de.addColorStop(1,"rgba(255,255,255,0)"),he.fillStyle=de,he.fillRect(0,0,64,64);const oe=new zr(I),at=(z,K)=>new cn({color:z,map:oe,transparent:!0,opacity:K,blending:_s,depthWrite:!1,side:ms}),nt=at(16729122,.5),dt=at(16750848,.6),ue=u.includes("blue1")?1.2:-1,Vt=new n(0,0,ue),St=fe&&fe.isVector3?fe.clone():Vt,Et=St.clone();if(Et.lengthSq()>1e-6){const z=St.clone().normalize();Et.addScaledVector(z,-.01)}else Et.z-=.01;const Lt=u.includes("dark1")?2:1,te=u.includes("dark1")?1.5:3,we=Lt*te,p=[],h=[],m=et.map((z,K)=>({...z,__spawnIdx:K,__src:z,spawned:!1})),ae=Ae&&ge instanceof Map?ge:new Map;function st(){const z=A.clone(!0);z.visible=!1,z.userData={enemy:!0,enemyRoot:!0,flashT:0};const K=[];z.traverse(At=>{At.isMesh&&(At.material=ke?cs(At.material):At.material.clone(),At.userData.enemy=!0,At.frustumCulled=!1,K.push(At))}),z.userData.meshes=K,z.userData.blink=()=>{z.userData.flashT=.15};const Le=new xe(Ke,r.clone());Le.visible=!1,z.add(Le),z.userData.lockRing=Le;const Re=new xe(T,nt);Re.position.copy(St),Re.scale.multiplyScalar(we);const it=new xe(T,dt);return it.scale.set(.6*we,.6*we,.6*we),it.position.copy(Et),z.add(Re),z.add(it),e.add(z),z}const ot=m.map(()=>{const z=st();return p.push(z),z});m.forEach((z,K)=>{z.ship=ot[K]});const Ne=[];for(let z=0;z<ye;z++){const K=st();K.userData.manual=!0,K.userData.dead=!0,K.visible=!1,Ne.push(K),p.push(K)}const Be=Ne.length?ot.concat(Ne):ot,Ht=M.spawnRadius??200,je=Ht*Ht,be=M.spawnBucketSize??Ht*2,$e=new Map,G=z=>Math.floor((z??0)/be);m.forEach(z=>{const K=G(z.z);$e.has(K)||$e.set(K,[]),$e.get(K).push(z)});function Se(z,K){var Re;const Le=ae.get(K.__spawnIdx)??null;z.visible=!0,z.userData.dead=!1,z.userData.fireT=0,z.userData.barrelSide=1,z.userData.phi=0,z.userData.ttl=$,z.userData.hp=M.hp??1,z.userData.flashT=0,z.userData.dropHealRing=!!K.dropHealRing,z.userData.burstRemaining=B,z.userData.burstCooldown=0,z.userData.burstShotT=0,z.userData.passT=Math.random()*C,z.userData.passFireReady=!0,z.userData.lockRing.visible=!1,z.position.set(K.x,K.y,K.z),z.userData.collided=!1,z.userData.state=Le?"path":"approach",z.userData.retreatZ=null,K.__src&&(z.userData.editorRef=K.__src,z.userData.editorGroup=Ee,z.userData.editorIndex=K.__spawnIdx),Le?z.userData.bakedPath={samples:Le.samples,duration:Le.duration??((Re=Le.samples)!=null&&Re.length?Le.samples[Le.samples.length-1].t:0),t:0,idx:0}:z.userData.bakedPath=null,z.userData.pathLog=null,z.userData.captureT=0,z.userData.captureAcc=0,z.userData.spawnIdx=K.__spawnIdx??null,z.userData.spawnPoint={x:K.x,y:K.y,z:K.z},z.userData.pathLogged=!0,z.userData.finishPath=null}function rt(){return m.forEach(z=>{Se(z.ship,z)}),m.map(z=>z.ship)}const ce=new n,ht=new n,lt=new n,Dt=new n,kt=new n,nn=new n,pt=new n,fn=new n,pn=new n;new n,new n;const Nt=new n;new n,new no;const hn=new n,En=new Rt,ln=new n,mn=20,Ss=ie;function io(z,K){const Le=typeof i=="function"?i():!0;o.getWorldPosition(ht);let Re=0;const it=3,At=G(ht.z),gn=[At-1,At,At+1];for(let j=0;j<gn.length;j++){const mt=$e.get(gn[j]);if(!(!mt||!mt.length)){for(let Ot=mt.length-1;Ot>=0&&Re<it;Ot--){const Pn=mt[Ot];if(Pn.spawned){mt.splice(Ot,1);continue}const Zn=Pn.ship;if(!Zn){mt.splice(Ot,1);continue}ce.set(Pn.x,Pn.y,Pn.z),ce.distanceToSquared(ht)<je&&(Se(Zn,Pn),Pn.spawned=!0,Re++,mt.splice(Ot,1))}if(mt.length||$e.delete(gn[j]),Re>=it)break}}h.length=0,p.forEach(j=>{var js,As,Dn,ws,on,Tn,sn;if(!j.visible||j.userData.dead)return;h.push(j),pn.copy(j.position),j.userData.fireT+=z;let mt=!1;const Ot=((js=j.userData)==null?void 0:js.chaseTarget)??null,Pn=((As=j.userData)==null?void 0:As.chaseOffset)??null,Zn=((Dn=j.userData)==null?void 0:Dn.chaseOffsetMode)??"local",is=((ws=j.userData)==null?void 0:ws.chaseMinDist)??0;let gs=!1;((on=j.userData)==null?void 0:on.state)==="chase"&&(Ot&&Ot.visible?(gs=!0,Ot.getWorldPosition(lt),wt.copy(lt),Pn&&(Ue.copy(Pn),Zn!=="world"&&Ot.quaternion&&Ue.applyQuaternion(Ot.quaternion),lt.add(Ue))):(j.userData.state="retreat",j.userData.chaseTarget=null));const ys=gs?lt:ht,ks=gs?wt:ys;if(gs){mt=!0,Dt.copy(ys).sub(j.position);const Qt=Dt.length();if(Qt>1e-4){Dt.multiplyScalar(1/Qt);const zn=j.userData.chaseSpeed??a*1.1,_n=Math.min(zn*z,Math.max(0,Qt-is));_n>0&&j.position.addScaledVector(Dt,_n)}}const Bn=j.userData.bakedPath;if(!gs&&Bn&&((Tn=Bn.samples)!=null&&Tn.length)){mt=!0,Bn.t=Math.min(Bn.t+z,Bn.duration);const Qt=Bn.samples;for(;Bn.idx<Qt.length-2&&Qt[Bn.idx+1].t<Bn.t;)Bn.idx++;const zn=Qt[Bn.idx],_n=Qt[Math.min(Bn.idx+1,Qt.length-1)],Rn=Math.max(1e-4,_n.t-zn.t),Fn=Mn.clamp((Bn.t-zn.t)/Rn,0,1);j.position.set(Mn.lerp(zn.pos[0],_n.pos[0],Fn),Mn.lerp(zn.pos[1],_n.pos[1],Fn),Mn.lerp(zn.pos[2],_n.pos[2],Fn)),Bn.t>=Bn.duration-.001&&(j.userData.bakedPath=null,j.userData.state="retreat",j.userData.retreatZ=j.position.z-ht.z)}let Zs=!1;if(!mt&&H){Zs=!0,j.userData.passT+=z,C>0&&(j.userData.passT%=C);const Qt=C>0?j.userData.passT/C*Math.PI*2:j.userData.passT;l.getTangentAt(K,kt).normalize(),nn.copy(kt).cross(pt.set(0,1,0)).normalize();const zn=pt.crossVectors(nn,kt).normalize(),Rn=(Math.sin(Qt)+1)*.5*(c+Y)-Y,Fn=Math.cos(Qt)*D,bs=Math.sin(Qt*.5)*L;j.position.copy(ht).addScaledVector(kt,Rn).addScaledVector(nn,Fn).addScaledVector(zn,bs),j.userData.passZOffset=Rn,j.userData.passFireReady=Math.abs(Rn)<=q}else if(!mt&&j.userData.state==="approach")ce.copy(ht).sub(j.position).normalize(),j.position.addScaledVector(ce,20*z),j.position.distanceToSquared(ht)<N*N&&(j.userData.state="retreat",l.getTangentAt(K,kt).normalize(),j.userData.retreatZ=j.position.z-ht.z);else if(!mt){if(j.position.addScaledVector(kt,a*z),X&&Math.random()<.2*z&&(fn.copy(kt).multiplyScalar(-20*z),j.position.add(fn)),E&&f&&j.position.addScaledVector(f,E*z),Z>0&&d!==0){j.userData.phi+=d*z;const Qt=nn.copy(kt).cross(pt.set(0,1,0)).normalize(),zn=pt.crossVectors(Qt,kt).normalize(),_n=Qt.multiplyScalar(-Math.sin(j.userData.phi)).add(zn.multiplyScalar(Math.cos(j.userData.phi))).multiplyScalar(Z*d);j.position.addScaledVector(_n,z)}D&&W&&(j.userData.phi+=W*2*Math.PI*z,nn.copy(kt).cross(pt.set(0,1,0)).normalize(),j.position.addScaledVector(nn,Math.cos(j.userData.phi)*D*z)),L&&x&&(j.userData.phi+=x*2*Math.PI*z,pt.set(0,1,0),j.position.addScaledVector(pt,Math.sin(j.userData.phi)*L*z))}const Es=!!Oe;let Ps=!0,Qs=!0;if(Zs){Nt.copy(j.position).sub(pn),Nt.lengthSq()>1e-6&&(Nt.normalize(),hn.copy(ys).sub(j.position),hn.lengthSq()>1e-6&&(hn.normalize(),Qs=Nt.dot(hn)>0));const Qt=typeof j.userData.passZOffset=="number"?j.userData.passZOffset:0;j.userData.passFireReady=Qs&&Math.abs(Qt)<=q}if(Zs&&(se||ne)&&(ne&&j.userData.passFireReady&&Qs?Ps=!0:se&&Nt.lengthSq()>1e-6&&(Es?(En.setFromUnitVectors(Oe,Nt),j.quaternion.copy(En)):(ce.copy(j.position).add(Nt),j.lookAt(ce)),Ps=!1)),Ps&&(Es?(hn.copy(ks).sub(j.position),hn.lengthSq()>1e-6&&(hn.normalize(),En.setFromUnitVectors(Oe,hn),j.quaternion.copy(En))):j.lookAt(ks)),Es||j.quaternion.multiply(Qe),!((sn=j.userData)!=null&&sn.noCullBehind)&&j.position.z>ht.z+mn){j.visible=!1,j.userData.dead=!0;return}j.userData.ttl!==1/0&&(j.userData.ttl-=z,j.userData.ttl<=0&&(j.position.z=ht.z+mn+1)),j.userData.lockRing.visible&&Ss&&j.userData.lockRing.quaternion.copy(Ss.quaternion),Le&&(!H||j.userData.passFireReady)&&(Gt?j.userData.burstCooldown>0?j.userData.burstCooldown-=z:(j.userData.burstShotT+=z,j.userData.burstShotT>=me&&(ln.copy(j.position),gt(ln,ks)?(ct(j),j.userData.burstShotT=0,j.userData.burstRemaining-=1,j.userData.burstRemaining<=0&&(j.userData.burstCooldown=U,j.userData.burstRemaining=B)):j.userData.burstShotT=me)):j.userData.fireT>=k&&(ln.copy(j.position),gt(ln,ks)?(ct(j),j.userData.fireT=0):j.userData.fireT=k)),j.userData.needsFlash&&(j.userData.flashT=.15,delete j.userData.needsFlash);const lo=j.userData.flashT>0;lo&&(j.userData.flashT=Math.max(0,j.userData.flashT-z));const ds=lo?1:0;j.userData.meshes.forEach(Qt=>Qt.material.emissive.setRGB(ds,0,0))})}function ao(z,K){const Le=Be.map(Re=>Re.visible);Be.forEach(Re=>{Re.visible=!0}),z.compile(e,K),Be.forEach((Re,it)=>{Re.visible=Le[it]})}function Ys(z,K){const Le=Be.map(Re=>Re.visible);Be.forEach(Re=>{Re.visible=!0}),z.render(e,K),Be.forEach((Re,it)=>{Re.visible=Le[it]})}function ro(z,K){if(!Be.length)return;const Le=Be.map(Re=>({vis:Re.visible,pos:Re.position.clone()}));Be.forEach((Re,it)=>{Re.visible=!0,Re.position.set(it%5*2,-200-Math.floor(it/5)*2,-200)}),z.render(e,K),Be.forEach((Re,it)=>{Re.visible=Le[it].vis,Re.position.copy(Le[it].pos)})}function ts({origin:z=null,right:K=null,up:Le=null,spacing:Re=12,count:it=1,faceTarget:At=null}={}){if(!ot.length)return()=>{};const gn=Math.min(it,ot.length),j=[];for(let mt=0;mt<gn;mt++){const Ot=ot[mt];if(j.push({ship:Ot,vis:Ot.visible,pos:Ot.position.clone(),quat:Ot.quaternion.clone()}),Ot.visible=!0,Ot.userData.dead=!1,Ot.userData.flashT=0,z&&Ot.position.copy(z),K){const Pn=(mt-(gn-1)*.5)*Re;Ot.position.addScaledVector(K,Pn)}Le&&Ot.position.addScaledVector(Le,mt%2*Re*.15),At&&(Ot.lookAt(At),Ot.quaternion.multiply(Qe))}return()=>{j.forEach(mt=>{mt.ship.visible=mt.vis,mt.ship.position.copy(mt.pos),mt.ship.quaternion.copy(mt.quat)})}}let Us=-1;const os={x:0,y:0,z:0,dropHealRing:!1,__spawnIdx:-1};function Te(z,K={}){if(!Ne.length||!z)return null;const Le=Ne.find(Re=>!Re.visible||Re.userData.dead);return Le?(Us-=1,os.x=z.x,os.y=z.y,os.z=z.z,os.dropHealRing=!!K.dropHealRing,os.__spawnIdx=Us,Se(Le,os),K.state&&(Le.userData.state=K.state),typeof K.hp=="number"&&(Le.userData.hp=K.hp),typeof K.onSpawn=="function"&&K.onSpawn(Le),Le):null}return{update:io,getActiveShips:()=>h,getActiveLasers:()=>[],prewarm:ao,prewarmRender:Ys,prewarmSpawn:ro,previewSetup:ts,spawnManual:Te,materializeSpawns:rt}}async function $l(e,{spawnArray:t,playerObj:o,boltPool:l=null,canFire:a=null,hazardEntries:y=null,spawnBlue:i=null,modelPath:u="./models/dark_frigate.glb",scale:S=30,moveSpeed:w=3,hp:Z=40,scoreValue:d=400,wingBurstCount:E=10,wingBurstInterval:f=.3,wingBurstPause:D=2,noseFireInterval:W=1.3,bigLaserScale:L=2.2,spawnInterval:x=3,spawnLimit:N=3,spawnRadius:$=420,cullBehind:M=30,faceMinDistance:ie=140,yaw:P=0,forwardAxis:V=new n(-1,0,0),materialMode:k="standard",editorGroup:R=null}={}){var Lt;if(!Array.isArray(t)||t.length===0)return{update:()=>{},getActiveShips:()=>[]};const B=(await new Un().loadAsync(u)).scene,me=k==="lambert",U=new bn().setFromObject(B),H=new n,C=new n;U.getSize(H),U.getCenter(C);const c=Math.max(H.x,H.z)*.35,Y=[];{const te=new Vs,we=new n;B.updateMatrixWorld(!0),te.copy(B.matrixWorld).invert();const p=Math.max(H.x,H.y,H.z)||1,h=Math.min(14,Math.max(6,Math.round(H.x/p*12))),m=Math.min(14,Math.max(8,Math.round(H.y/p*12))),ae=Math.min(14,Math.max(6,Math.round(H.z/p*12))),st=h*m*ae,ot=new Uint8Array(st),Ne=U.min,Be=H.x||1e-6,Ht=H.y||1e-6,je=H.z||1e-6,be=1/Be,$e=1/Ht,G=1/je,Se=(ce,ht,lt)=>ce+h*(ht+m*lt);let rt=!1;if(B.traverse(ce=>{var Dt;if(!ce.isMesh||!ce.geometry||!((Dt=ce.geometry.attributes)!=null&&Dt.position))return;const ht=ce.geometry.attributes.position,lt=ce.matrixWorld;for(let kt=0,nn=ht.count;kt<nn;kt++){we.fromBufferAttribute(ht,kt),we.applyMatrix4(lt),we.applyMatrix4(te);const pt=Math.min(h-1,Math.max(0,Math.floor((we.x-Ne.x)*be*h))),fn=Math.min(m-1,Math.max(0,Math.floor((we.y-Ne.y)*$e*m))),pn=Math.min(ae-1,Math.max(0,Math.floor((we.z-Ne.z)*G*ae)));ot[Se(pt,fn,pn)]=1,rt=!0}}),rt)for(let ce=0;ce<ae;ce++){const ht=Ne.z+ce/ae*je,lt=Ne.z+(ce+1)/ae*je;for(let Dt=0;Dt<m;Dt++){const kt=Ne.y+Dt/m*Ht,nn=Ne.y+(Dt+1)/m*Ht;for(let pt=0;pt<h;pt++){if(!ot[Se(pt,Dt,ce)])continue;const fn=Ne.x+pt/h*Be,pn=Ne.x+(pt+1)/h*Be;Y.push(new bn(new n(fn,kt,ht),new n(pn,nn,lt)))}}}else Y.push(U.clone())}const q=V.clone().normalize(),se=new n(0,1,0),ne=new n().crossVectors(se,q).normalize(),fe=[new n(U.min.x,U.min.y,U.min.z),new n(U.min.x,U.min.y,U.max.z),new n(U.min.x,U.max.y,U.min.z),new n(U.min.x,U.max.y,U.max.z),new n(U.max.x,U.min.y,U.min.z),new n(U.max.x,U.min.y,U.max.z),new n(U.max.x,U.max.y,U.min.z),new n(U.max.x,U.max.y,U.max.z)];function De(te){let we=1/0,p=-1/0;fe.forEach(m=>{const ae=m.dot(te);ae<we&&(we=ae),ae>p&&(p=ae)});const h=C.dot(te);return{min:we,max:p,length:p-we,center:h}}const Me=De(q),ge=De(ne),Ae=De(se),ye=(te,we,p)=>C.clone().addScaledVector(q,te-Me.center).addScaledVector(ne,we-ge.center).addScaledVector(se,p-Ae.center),pe=Me.max-Me.length*.01,Ee=Me.min+Me.length*.22,X=Me.min+Me.length*.42,et=ge.max-ge.length*.05,A=ge.min+ge.length*.05,ke=ge.center+ge.length*.03,Qe=ge.center-ge.length*.03,Oe=Ae.center+Ae.length*.05,Fe=Ae.center-Ae.length*.02,qt=Ae.min+Ae.length*.12,Gt=ye(Ee,A,Oe),vt=ye(Ee,et,Oe),_t=ye(pe,Qe,Fe),Ct=ye(pe,ke,Fe),bt=ye(X,ge.center,qt),Kt=new Rt().setFromAxisAngle(new n(0,1,0),P),Bt=l??((Lt=e.userData)==null?void 0:Lt.boltPool)??null,$t=[],Zt=[],Ft=t.map((te,we)=>({...te,__spawnIdx:we,__src:te,spawned:!1}));function Ue(){const te=B.clone(!0);te.visible=!1,te.userData={enemy:!0,enemyRoot:!0,flashT:0,hitBoxes:Y,largeExplosion:!0};const we=[];return te.traverse(p=>{p.isMesh&&(p.material=me?cs(p.material):p.material.clone(),p.userData.enemy=!0,p.frustumCulled=!1,we.push(p))}),te.userData.meshes=we,te.userData.blink=()=>{te.userData.flashT=.2},e.add(te),te}const wt=Ft.map(()=>{const te=Ue();return $t.push(te),te});Ft.forEach((te,we)=>{te.ship=wt[we]});const tt=new n,J=new n,Ce=new Rt,ve=new n,_e=new n,Ie=new n,Ze=new n,gt=new n(0,0,1),ct=[],yt=new n,Ke=new n,r=new n,T=new bn;function I(te){var h,m,ae;if(!te)return;const we=te.getMesh?te.getMesh():te.mesh??null,p=te.collider??((h=we==null?void 0:we.userData)==null?void 0:h.collider)??null;!we||!p||ct.push({mesh:we,collider:p,laserCollisionEnabled:((m=we.userData)==null?void 0:m.laserCollisionEnabled)!==!1,gateCylinder:((ae=we.userData)==null?void 0:ae.gateCylinder)??null})}(Array.isArray(y)?y:[]).forEach(I);function de(te,we,p,h){const m=h.x-p.x,ae=h.z-p.z,st=te-p.x,ot=we-p.z,Ne=m*m+ae*ae;let Be=0;Ne>1e-8&&(Be=(st*m+ot*ae)/Ne),Be<0?Be=0:Be>1&&(Be=1);const Ht=p.x+m*Be-te,je=p.z+ae*Be-we;return Ht*Ht+je*je}function oe(te,we){var h,m,ae;if(!ct.length)return!0;yt.copy(we).sub(te);const p=yt.length();if(p<=1e-5)return!0;yt.multiplyScalar(1/p),Ke.set(Math.min(te.x,we.x),Math.min(te.y,we.y),Math.min(te.z,we.z)),r.set(Math.max(te.x,we.x),Math.max(te.y,we.y),Math.max(te.z,we.z)),T.set(Ke,r);for(let st=0;st<ct.length;st++){const ot=ct[st];if((h=ot.mesh)!=null&&h.visible&&ot.laserCollisionEnabled!==!1){if(ot.gateCylinder){const Ne=ot.gateCylinder,Be=Math.min(te.y,we.y);if(Math.max(te.y,we.y)<Ne.minY||Be>Ne.maxY||de(Ne.x,Ne.z,te,we)>Ne.radius*Ne.radius)continue}if(!((m=ot.collider)!=null&&m.worldAABB&&!T.intersectsBox(ot.collider.worldAABB))&&(ae=ot.collider)!=null&&ae.linecast){const Ne=ot.collider.linecast(te,yt,p);if(Ne!=null&&Ne.hit)return!1}}}return!0}function at(te,we,p){return ve.copy(we).sub(te),ve.lengthSq()>1e-6?ve.normalize():ve.set(0,0,1),(p??Ce).setFromUnitVectors(gt,ve)}function nt(te,we,{big:p=!1}={}){if(!Bt)return;const h=Bt.alloc({big:p,life:1.8,dir:1,bounced:!1,scale:p?L:1});h&&Bt.setTransform(h,te,we,p?L:1)}function dt(te,we){const p=typeof we.scale=="number"?we.scale:1,h=S*p;te.scale.setScalar(h),te.position.set(we.x,we.y,we.z),we.__src&&(te.userData.editorRef=we.__src,te.userData.editorGroup=R,te.userData.editorIndex=we.__spawnIdx),te.visible=!0,te.userData.dead=!1,te.userData.hp=typeof we.hp=="number"?we.hp:Z,te.userData.scoreValue=typeof we.scoreValue=="number"?we.scoreValue:d,te.userData.hitRadius=c*h,te.userData.dropHealRing=!!we.dropHealRing,te.userData.flashT=0,te.userData.wingBurstRemaining=E,te.userData.wingBurstCooldown=0,te.userData.wingBurstShotT=0,te.userData.noseFireT=0,te.userData.noseSide=1,te.userData.spawnT=0;const m=typeof we.spawnLimit=="number"?we.spawnLimit:N;te.userData.spawnRemaining=Number.isFinite(m)?m:1/0,te.userData.spawnInterval=typeof we.spawnInterval=="number"?we.spawnInterval:x;const ae=typeof we.yaw=="number"?we.yaw:0;te.userData.yawOffsetQ||(te.userData.yawOffsetQ=new Rt),te.userData.yawOffsetQ.setFromAxisAngle(se,ae),te.userData.spawnOffsetVec||(te.userData.spawnOffsetVec=new n);const st=we.spawnOffset;st&&typeof st=="object"?te.userData.spawnOffsetVec.set(Number(st.x)||0,Number(st.y)||0,Number(st.z)||0):typeof we.spawnOffsetY=="number"?te.userData.spawnOffsetVec.set(0,we.spawnOffsetY,0):te.userData.spawnOffsetVec.set(0,0,0),te.userData.guns={wingLeft:Gt.clone(),wingRight:vt.clone(),noseLeft:_t.clone(),noseRight:Ct.clone(),belly:bt.clone()},te.updateMatrixWorld(!0)}function ue(te){const we=typeof a=="function"?a():!0;o.getWorldPosition(tt);let p=0;const h=1;for(let m=0;m<Ft.length&&p<h;m++){const ae=Ft[m];ae.spawned||(J.set(ae.x,ae.y,ae.z),J.distanceToSquared(tt)<=$*$&&(dt(ae.ship,ae),ae.spawned=!0,p+=1))}Zt.length=0,$t.forEach(m=>{var Ne;if(!m.visible||m.userData.dead)return;if(Zt.push(m),m.position.distanceToSquared(tt)>=ie*ie&&(m.lookAt(tt),m.quaternion.multiply(Kt),m.userData.yawOffsetQ&&m.quaternion.multiply(m.userData.yawOffsetQ)),_e.copy(q).applyQuaternion(m.quaternion).normalize(),m.position.addScaledVector(_e,w*te),m.position.z>tt.z+M){m.visible=!1,m.userData.dead=!0;return}if(we){if(m.userData.wingBurstCooldown>0)m.userData.wingBurstCooldown=Math.max(0,m.userData.wingBurstCooldown-te);else if(m.userData.wingBurstShotT+=te,m.userData.wingBurstShotT>=f){let Be=!1;m.localToWorld(J.copy(m.userData.guns.wingLeft)),oe(J,tt)&&(at(J,tt,Ce),nt(J,Ce),Be=!0),m.localToWorld(J.copy(m.userData.guns.wingRight)),oe(J,tt)&&(at(J,tt,Ce),nt(J,Ce),Be=!0),Be?(m.userData.wingBurstShotT=0,m.userData.wingBurstRemaining-=1,m.userData.wingBurstRemaining<=0&&(m.userData.wingBurstRemaining=E,m.userData.wingBurstCooldown=D)):m.userData.wingBurstShotT=f}if(m.userData.noseFireT+=te,m.userData.noseFireT>=W){const Be=m.userData.noseSide>0;m.userData.noseSide*=-1;const Ht=Be?m.userData.guns.noseRight:m.userData.guns.noseLeft;m.localToWorld(J.copy(Ht)),oe(J,tt)?(m.userData.noseFireT=0,at(J,tt,Ce),nt(J,Ce,{big:!0})):m.userData.noseFireT=W}i&&m.userData.spawnRemaining>0&&(m.userData.spawnT+=te,m.userData.spawnT>=m.userData.spawnInterval&&(m.userData.spawnT=0,m.localToWorld(Ie.copy(m.userData.guns.belly)),((Ne=m.userData.spawnOffsetVec)==null?void 0:Ne.lengthSq())>1e-6&&(Ze.copy(m.userData.spawnOffsetVec).applyQuaternion(m.quaternion),Ie.add(Ze)),i(Ie),Number.isFinite(m.userData.spawnRemaining)&&(m.userData.spawnRemaining-=1)))}m.userData.flashT>0&&(m.userData.flashT=Math.max(0,m.userData.flashT-te));const ot=m.userData.flashT>0?1:0;m.userData.meshes.forEach(Be=>Be.material.emissive.setRGB(ot,0,0))})}function Vt(te,we){const p=wt.map(h=>h.visible);wt.forEach(h=>{h.visible=!0}),te.compile(e,we),wt.forEach((h,m)=>{h.visible=p[m]})}function St({origin:te=null,right:we=null,up:p=null,spacing:h=12,count:m=1,faceTarget:ae=null}={}){if(!wt.length)return()=>{};const st=Math.min(m,wt.length),ot=[];for(let Ne=0;Ne<st;Ne++){const Be=wt[Ne];if(ot.push({ship:Be,vis:Be.visible,pos:Be.position.clone(),quat:Be.quaternion.clone(),scale:Be.scale.clone()}),Be.visible=!0,Be.userData.dead=!1,Be.userData.flashT=0,Be.scale.setScalar(S),te&&Be.position.copy(te),we){const Ht=(Ne-(st-1)*.5)*h;Be.position.addScaledVector(we,Ht)}p&&Be.position.addScaledVector(p,Ne%2*h*.1),ae&&(Be.lookAt(ae),Be.quaternion.multiply(Kt))}return()=>{ot.forEach(Ne=>{Ne.ship.visible=Ne.vis,Ne.ship.position.copy(Ne.pos),Ne.ship.quaternion.copy(Ne.quat),Ne.ship.scale.copy(Ne.scale)})}}function Et(){return Ft.forEach(te=>{dt(te.ship,te)}),Ft.map(te=>te.ship)}return{update:ue,getActiveShips:()=>Zt,prewarm:Vt,previewSetup:St,materializeSpawns:Et}}const xs={straight:{retreatDist:50,fireDir:1,despawnDelay:20},corkscrew:{yaw:Math.PI,fireDir:-1,orbitRadius:4,orbitRate:3,retreatDist:50,despawnDelay:20},blueStraight:{yaw:Math.PI,fireDir:-1,retreatDist:50,despawnDelay:20},diagLR:{fireDir:1,diagSpeed:25,diagVec:new n(1,-.3,0).normalize(),retreatDist:70,despawnDelay:20},diagRL:{fireDir:1,diagSpeed:25,diagVec:new n(-1,.3,0).normalize(),retreatDist:70,despawnDelay:20},zigzagWide:{fireDir:1,lateralAmp:18,lateralHz:.8,retreatDist:60,despawnDelay:20},zigzagTight:{yaw:Math.PI,fireDir:-1,lateralAmp:8,lateralHz:1,retreatDist:55,despawnDelay:20},hoverBob:{yaw:Math.PI,fireDir:-1,verticalAmp:15,verticalHz:1,retreatDist:45,despawnDelay:20},spiralIn:{fireDir:1,orbitRadius:16,orbitRate:2,retreatDist:40,despawnDelay:20},spiderTurret:{dualGun:!0,gunSpacing:.6,fireInterval:.3,fireDir:1,lateralAmp:18,lateralHz:.6,verticalAmp:8,verticalHz:.4,retreatDist:50,backpedal:!0,hp:5,despawnDelay:30},jetArc:{fireDir:1,fireOffsetZ:1.5,forwardAxis:new n(-1,0,0),hp:5,burstCount:5,burstInterval:.12,burstPause:2,passLoop:!0,passDuration:7,passAhead:180,passBehind:8,passFireWindow:70,orientToVelocity:!0,orientToPlayerWhenFiring:!0,glowOffset:new n(.8,0,0),lateralAmp:16,lateralHz:.45,verticalAmp:10,verticalHz:.25,retreatDist:90,despawnDelay:28}};async function Jl(e,{spawn:t,playerObj:o,railCurve:l,playerSpeed:a,modelPath:y="./models/dark2.glb",boltPool:i=null,onDestroyed:u=null,canFire:S=null,materialMode:w="standard",autoDespawnZ:Z=-3205}){var ye;const d=(await new Un().loadAsync(y)).scene,E=w==="lambert";d.scale.setScalar(36),d.position.set(t.x,t.y,t.z),d.visible=!1,e.add(d);const f=new bn().setFromObject(d),D=new n;f.getSize(D);const W=D.z*.44,L=W*W;D.x*.1,D.y*.1;const x=D.z*.1,N=[new n(0,0,0),new n(-.7,-.1,-x*.1),new n(.7,-.1,-x*.1),new n(-.2,-.15,-x*.1),new n(.2,-.15,-x*.1)],$=1.2,M=1.8,ie=i??((ye=e.userData)==null?void 0:ye.boltPool)??null;function P(pe,Ee,X=!1){if(!ie)return;const et=ie.alloc({big:X,life:$*(X?1.5:1),dir:1,bounced:!1,scale:X?2:1});et&&ie.setTransform(et,pe,Ee,X?2:1)}function V(){return[]}const k=45;let R=k,g=0,B=!1;const me=[];d.traverse(pe=>{pe.isMesh&&(pe.material=E?cs(pe.material):pe.material.clone(),me.push(pe))});function U(){return d}function H(pe){B||(R=Math.max(0,R-pe),g=pe>=3?.3:.15,qo(R/k),R===0&&(B=!0,d.visible=!1,qo(null),typeof u=="function"&&u()))}const C=new n,c=new Rt,Y=new n,q=new n,se=new n(0,0,1);let ne=0,fe=!1;const De=Number.isFinite(t==null?void 0:t.autoDespawnZ)?t.autoDespawnZ:Z;function Me(pe,Ee,X){return q.copy(Ee).sub(pe),q.lengthSq()>1e-6?q.normalize():q.copy(se),(X??c).setFromUnitVectors(se,q)}function ge(pe,Ee){const X=typeof S=="function"?S():!0;if(!fe)if(o.getWorldPosition(Y),Y.z<=t.z+300)fe=!0,d.visible=!0,qo(R/k);else return;qo(R>0?R/k:null);const et=Math.min(1,Ee+.0032);if(d.position.copy(l.getPointAt(et)),d.lookAt(Y.setFromMatrixPosition(o.matrixWorld)),!B&&Number.isFinite(De)&&d.position.z<=De){B=!0,R=0,d.visible=!1,qo(null),typeof u=="function"&&u({auto:!0,noScore:!0});return}if(R>0&&X&&(ne+=pe,ne>=M&&(ne=0,N.forEach(A=>{d.localToWorld(C.copy(A)),Me(C,Y,c),P(C,c)}),Math.random()<.34&&(C.copy(N[0]),d.localToWorld(C),Me(C,Y,c),P(C,c,!0)))),g>0){g=Math.max(0,g-pe);const A=g>0?1:0;me.forEach(ke=>ke.material.emissive.setRGB(A,0,0))}}function Ae(pe,Ee){const X=d.visible,et=d.position.clone(),A=d.quaternion.clone(),ke=[];if(d.visible=!0,Ee){const Qe=new n,Oe=new n;Ee.getWorldPosition(Qe),Ee.getWorldDirection(Oe),d.position.copy(Qe).addScaledVector(Oe,80),d.lookAt(Qe)}d.traverse(Qe=>{Qe.isMesh&&(ke.push([Qe,Qe.frustumCulled]),Qe.frustumCulled=!1)}),pe.render(e,Ee),d.visible=X,d.position.copy(et),d.quaternion.copy(A),ke.forEach(([Qe,Oe])=>{Qe.frustumCulled=Oe})}return{update:ge,getActiveLasers:V,damageBoss:H,getMesh:U,getRadiusSq:()=>L,prewarm:Ae}}async function ec(e,{spawnArray:t=[{x:0,y:0,z:-120}],blueSpawnArray:o=[],ringSpawnArray:l=[],wingRepairSpawnArray:a=[],bombSpawnArray:y=[],playerObj:i,lasers:u,onBombPickup:S=()=>{},onRingCollected:w=()=>{}}){const Z=new n,d=new n,E=300,f=new tn(.25,6,.25),D=new Ls({color:65407,emissive:65407,emissiveIntensity:1.5,roughness:.3,metalness:.6}),W=65535,L=new Ls({color:W,emissive:W,emissiveIntensity:1.5,roughness:.3,metalness:.6}),x=new tn(2,1.2,.3),N=new Ls({color:4676}),$=new xe(x,N);$.position.y=0;const M=new Ls({color:16777215,emissive:16777215,emissiveIntensity:.8,roughness:.2,metalness:.4}),ie=new xe(new tn(.22,2,.22),M);ie.position.set(-.55,0,.2);const P=new xe(new tn(1.1,.22,.22),M);P.position.set(.05,-.9,.2);const V=new ss;V.add(ie),V.add(P);const k=p=>{const h=new ss,m=new xe(f,p);m.position.x=-1,h.add(m);const ae=new xe(f,p);return ae.position.x=1,h.add(ae),h.add($.clone()),h.add(V.clone()),h},R=k(D),g=k(L),B=[];t.forEach(p=>{const h=R.clone(!0),m=new ss;m.add(h),m.position.set(p.x,p.y,p.z),m.userData.editorRef=p,m.userData.editorGroup="pickupDual",e.add(m),B.push({group:m,core:h,baseY:p.y,active:!1,pending:!0,spawnRef:p,spawnGroup:"pickupDual"}),h.visible=!1});const me=[],U=(p=null,h=!1)=>{const m=g.clone(!0),ae=new ss;return ae.add(m),p&&ae.position.copy(p),e.add(ae),{group:ae,core:m,baseY:p?p.y:0,active:!1,pending:h}};o.forEach(p=>{const h=U(new n(p.x,p.y,p.z),!0);h.group.userData.editorRef=p,h.group.userData.editorGroup="pickupDualBlue",h.spawnRef=p,h.spawnGroup="pickupDualBlue",me.push(h),h.core.visible=!1});const H=Math.max(4,Array.isArray(t)?t.length:0);for(let p=0;p<H;p++){const h=U();h.core.visible=!1,me.push(h)}const C=3,c=2.25,Y=1.7,q=C*Y,se=q*q,ne=3.5,fe=.45,De=Math.PI*4/fe,Me=(C+c)*.5,ge=(C-c)*.5,Ae=new Po(Me,ge,6,12),ye=new Ls({color:12632256,emissive:2105376,emissiveIntensity:1.25,metalness:1,roughness:.12,side:$o}),pe=new xe(Ae,ye),Ee=new ss;Ee.add(pe);const X=[],et=12,A=()=>{const p=Ee.clone(!0);return p.visible=!1,p.scale.setScalar(Y),e.add(p),{mesh:p,baseY:0,state:"done",animT:0,spin:0}};l.forEach(p=>{const h=A();h.mesh.position.set(p.x,p.y,p.z),h.mesh.visible=!1,h.baseY=p.y,h.state="pending",h.mesh.userData.editorRef=p,h.mesh.userData.editorGroup="pickupHealRing",h.spawnRef=p,h.spawnGroup="pickupHealRing",X.push(h)});for(let p=0;p<et;p++)X.push(A());const ke=new ss,Qe=new Ls({color:7060735,emissive:2845695,emissiveIntensity:1.2,roughness:.2,metalness:.6}),Oe=new Ls({color:10147583,emissive:3836927,emissiveIntensity:.9,roughness:.25,metalness:.4}),Fe=new xe(new tn(.55,4.2,.45),Qe);Fe.position.set(0,0,0),ke.add(Fe);const qt=new xe(new Xn(.9,.8,.6,14),Qe);qt.rotation.x=Math.PI*.5,qt.position.set(0,-2.4,0),ke.add(qt);const Gt=new Ls({color:2772351,emissive:1586010,emissiveIntensity:.6,roughness:.35,metalness:.2}),vt=new xe(new Xn(.45,.4,.55,12),Gt);vt.rotation.x=Math.PI*.5,vt.position.set(0,-2.4,.06),ke.add(vt);const _t=new xe(new tn(1.3,.9,.55),Qe);_t.position.set(0,2.05,0),ke.add(_t);const Ct=new tn(.45,.85,.55),bt=new xe(Ct,Oe);bt.position.set(-.65,2.45,0),ke.add(bt);const Kt=bt.clone();Kt.position.set(.65,2.25,0),ke.add(Kt),ke.rotation.z=-Math.PI*.25,ke.scale.setScalar(1.55),ke.updateMatrixWorld(!0);const Bt=new bn().setFromObject(ke),$t=Bt.getCenter(new n);ke.children.forEach(p=>{p.position.sub($t)}),ke.updateMatrixWorld(!0),Bt.setFromObject(ke);const Ft=Bt.getBoundingSphere(new no).radius,Ue=[],wt=(Array.isArray(t)?t.length:0)+(Array.isArray(o)?o.length:0),tt=Math.max(6,wt),J=(p=null,h=!1)=>{const m=ke.clone(!0),ae=new ss;return ae.add(m),p&&ae.position.copy(p),e.add(ae),{group:ae,core:m,baseY:p?p.y:0,pickupRadius:Ft,pickupRadiusSq:Ft*Ft,active:!1,pending:h}};a.forEach(p=>{const h=J(new n(p.x,p.y,p.z),!0);h.group.userData.editorRef=p,h.group.userData.editorGroup="pickupWingRepair",h.spawnRef=p,h.spawnGroup="pickupWingRepair",Ue.push(h),h.core.visible=!1});for(let p=0;p<tt;p++){const h=J();h.core.visible=!1,Ue.push(h)}const Ce=40,ve=.85,Ie=(await new Un().loadAsync("./models/pickup_bomb.glb")).scene,Ze=new Map,gt=p=>{const h=p.color?p.color.clone():new ls(16777215);h.multiplyScalar(ve);const m=new cn({color:h,map:p.map??null,transparent:p.transparent??!1,opacity:p.opacity??1,alphaTest:p.alphaTest??0,side:p.side??$o,depthWrite:p.depthWrite??!0,depthTest:p.depthTest??!0});return p.vertexColors!==void 0&&(m.vertexColors=p.vertexColors),m.toneMapped=!1,m},ct=p=>{p.traverse(h=>{var ae;if(!h.isMesh||!((ae=h.userData)!=null&&ae.bombMatKeys))return;const m=h.userData.bombMatKeys;Array.isArray(h.material)?h.material=m.map(st=>Ze.get(st)).filter(Boolean):h.material=Ze.get(m[0])})};Ie.traverse(p=>{if(p.isLight){p.visible=!1;return}if(!p.isMesh||!p.material)return;const m=(Array.isArray(p.material)?p.material:[p.material]).map(ae=>{if(!ae)return null;ae.userData.bombKey||(ae.userData.bombKey=`bomb_${Ze.size}`);const st=ae.userData.bombKey;return Ze.has(st)||Ze.set(st,gt(ae)),st}).filter(Boolean);p.userData.bombMatKeys=m,m.length&&(p.material=Array.isArray(p.material)?m.map(ae=>Ze.get(ae)).filter(Boolean):Ze.get(m[0]))}),Ie.scale.setScalar(1),Ie.updateMatrixWorld(!0);const yt=new bn().setFromObject(Ie),Ke=yt.getCenter(new n);Ie.position.sub(Ke),Ie.updateMatrixWorld(!0),yt.setFromObject(Ie);const T=yt.getBoundingSphere(new no).radius*Ce,I=[],he=Math.max(4,Array.isArray(y)?y.length:0),de=(p=null,h=!1)=>{const m=Ie.clone(!0);ct(m);const ae=new ss;return ae.add(m),ae.scale.setScalar(Ce),p&&ae.position.copy(p),e.add(ae),{group:ae,core:m,baseY:p?p.y:0,pickupRadius:T,pickupRadiusSq:T*T,active:!1,pending:h}};y.forEach(p=>{const h=de(new n(p.x,p.y,p.z),!0);h.group.userData.editorRef=p,h.group.userData.editorGroup="pickupBomb",h.spawnRef=p,h.spawnGroup="pickupBomb",I.push(h),h.core.visible=!1});for(let p=0;p<he;p++){const h=de();h.core.visible=!1,I.push(h)}const oe=p=>{p.active=!1,p.core.visible=!1},at=p=>{p.active=!1,p.core.visible=!1};function nt(p){if(!p)return!1;let h=Ue.find(m=>!m.active&&!m.pending);return h?(h.group.position.copy(p),h.baseY=p.y,h.pending=!1,h.active=!0,h.core.visible=!0,!0):!1}function dt(p){if(!p)return!1;let h=me.find(m=>!m.active&&!m.pending);return h?(h.group.position.copy(p),h.baseY=p.y,h.pending=!1,h.active=!0,h.core.visible=!0,!0):!1}const ue=()=>{var m,ae;const p=(m=i==null?void 0:i.userData)==null?void 0:m.wingHpLeft,h=(ae=i==null?void 0:i.userData)==null?void 0:ae.wingHpRight;return typeof p!="number"||typeof h!="number"?!1:p<=0||h<=0},Vt=(p,h)=>{const m=h-p;return m>=0&&m<=E};function St(p,h){var Ne,Be,Ht,je;i.getWorldPosition(d);const m=d.z,ae=ue(),st=((Ne=u==null?void 0:u.isDual)==null?void 0:Ne.call(u))&&!((Be=u==null?void 0:u.isBlue)!=null&&Be.call(u)),ot=((Ht=u==null?void 0:u.isDual)==null?void 0:Ht.call(u))&&((je=u==null?void 0:u.isBlue)==null?void 0:je.call(u));B.forEach(be=>{if(be.pending)if(Vt(be.group.position.z,m)){if(ae){nt(be.group.position),be.pending=!1,be.active=!1,be.core.visible=!1;return}if(ot&&nt(be.group.position)){be.pending=!1,be.active=!1,be.core.visible=!1;return}if(st&&dt(be.group.position)){be.pending=!1,be.active=!1,be.core.visible=!1;return}be.pending=!1,be.active=!0,be.core.visible=!0}else return;if(!be.active)return;if(ae){nt(be.group.position),oe(be);return}const $e=be.group;$e.position.y=be.baseY+Math.sin(h*.001)*1.8,$e.getWorldPosition(Z),Z.distanceToSquared(d)<36&&(oe(be),u.enableDual(!0),u.enableBlue&&u.enableBlue(!1))}),me.forEach(be=>{if(be.pending)if(Vt(be.group.position.z,m)){if(ae){nt(be.group.position),be.pending=!1,be.active=!1,be.core.visible=!1;return}be.pending=!1,be.active=!0,be.core.visible=!0}else return;if(!be.active)return;if(ae){nt(be.group.position),oe(be);return}const $e=be.group;$e.position.y=be.baseY+Math.sin(h*.001)*1.8,$e.getWorldPosition(Z),Z.distanceToSquared(d)<36&&(oe(be),u.enableDual(!0),u.enableBlue&&u.enableBlue(!0))}),Ue.forEach(be=>{var G,Se;if(be.pending)if(Vt(be.group.position.z,m))be.pending=!1,be.active=!0,be.core.visible=!0;else return;if(!be.active)return;const $e=be.group;$e.rotation.y+=.9*p,$e.position.y=be.baseY+Math.sin(h*.001)*1.8,$e.getWorldPosition(Z),Z.distanceToSquared(d)<be.pickupRadiusSq&&(at(be),(Se=(G=i.userData)==null?void 0:G.restoreWings)==null||Se.call(G))}),I.forEach(be=>{if(be.pending)if(Vt(be.group.position.z,m))be.pending=!1,be.active=!0,be.core.visible=!0;else return;if(!be.active)return;const $e=be.group;$e.rotation.y+=.8*p,$e.position.y=be.baseY+Math.sin(h*.001)*1.2,$e.getWorldPosition(Z),Z.distanceToSquared(d)<be.pickupRadiusSq&&(oe(be),S(1))}),X.forEach(be=>{const $e=be.mesh;if(be.state==="pending")if(Vt($e.position.z,m))be.state="idle",be.mesh.visible=!0,be.mesh.scale.setScalar(Y),be.mesh.rotation.set(0,0,0);else return;if($e.visible){if(be.state==="idle"){$e.rotation.y+=1*p,$e.position.y=be.baseY+Math.sin(h*.001)*2.4,$e.getWorldPosition(Z);const G=Z.z-d.z;if(Math.abs(G)<=ne){const Se=Z.x-d.x,rt=Z.y-d.y;Se*Se+rt*rt<=se&&(be.state="collecting",be.animT=0,be.spin=0,$e.rotation.set(0,0,0),Il(1),w(1))}}else if(be.state==="collecting"){be.animT+=p;const G=Math.min(1,be.animT/fe);be.spin+=De*p,$e.position.copy(d),$e.rotation.z=be.spin;const Se=Mn.lerp(1,.05,G);$e.scale.setScalar(Y*Se),G>=1&&(be.state="done",$e.visible=!1)}}})}function Et(p,h){const m=p.getSize(new Vn),ae=new n,st=new n,ot=new n,Ne=[];h.getWorldPosition(ae),h.getWorldDirection(st),ot.copy(ae).add(st.multiplyScalar(20));const Be=(je,be=0)=>{je!=null&&je.group&&(Ne.push({type:"pickup",entry:je,visible:je.group.visible,coreVisible:je.core.visible,position:je.group.position.clone(),rotation:je.group.rotation.clone()}),je.group.visible=!0,je.core.visible=!0,je.group.position.copy(ot).add(new n(be,0,0)),je.group.rotation.set(0,0,0))},Ht=(je,be=0)=>{je!=null&&je.mesh&&(Ne.push({type:"ring",entry:je,visible:je.mesh.visible,position:je.mesh.position.clone(),rotation:je.mesh.rotation.clone(),scale:je.mesh.scale.clone()}),je.mesh.visible=!0,je.mesh.position.copy(ot).add(new n(be,0,0)),je.mesh.rotation.set(0,0,0),je.mesh.scale.setScalar(Y))};Be(B[0],-8),Be(me[0],-4),Be(Ue[0],6),Be(I[0],10),Ht(X[0],0),p.setSize(64,64,!1),p.render(e,h),p.setSize(m.x,m.y,!1),Ne.forEach(je=>{if(je.type==="pickup"){const be=je.entry;be.group.visible=je.visible,be.core.visible=je.coreVisible,be.group.position.copy(je.position),be.group.rotation.copy(je.rotation)}else if(je.type==="ring"){const be=je.entry;be.mesh.visible=je.visible,be.mesh.position.copy(je.position),be.mesh.rotation.copy(je.rotation),be.mesh.scale.copy(je.scale)}})}function Lt(p=0){for(let h=0;h<B.length;h++){const m=B[h];if(m.pending){m.group.position.z>p+30&&(m.pending=!1,m.active=!1,m.core.visible=!1);continue}m.active&&m.group.position.z>p+30&&oe(m)}for(let h=0;h<me.length;h++){const m=me[h];if(m.pending){m.group.position.z>p+30&&(m.pending=!1,m.active=!1,m.core.visible=!1);continue}m.active&&m.group.position.z>p+30&&oe(m)}for(let h=0;h<Ue.length;h++){const m=Ue[h];if(m.pending){m.group.position.z>p+30&&(m.pending=!1,m.active=!1,m.core.visible=!1);continue}m.active&&m.group.position.z>p+30&&at(m)}for(let h=0;h<I.length;h++){const m=I[h];if(m.pending){m.group.position.z>p+30&&(m.pending=!1,m.active=!1,m.core.visible=!1);continue}m.active&&m.group.position.z>p+30&&oe(m)}for(let h=0;h<X.length;h++){const m=X[h];if(m.state!=="idle")continue;const ae=m.mesh;ae.position.z>p+30&&(m.state="done",ae.visible=!1)}}function te(p){if(!p)return!1;const h=X.find(m=>m.state==="done"&&!m.mesh.visible);return h?(h.mesh.position.copy(p),h.mesh.rotation.set(0,0,0),h.mesh.scale.setScalar(Y),h.mesh.visible=!0,h.baseY=p.y,h.state="idle",h.animT=0,h.spin=0,!0):!1}function we(){const p=[];return B.forEach(h=>{h.spawnRef&&(h.pending=!1,h.active=!0,h.core.visible=!0,h.group.visible=!0,p.push(h.group))}),me.forEach(h=>{h.spawnRef&&(h.pending=!1,h.active=!0,h.core.visible=!0,h.group.visible=!0,p.push(h.group))}),Ue.forEach(h=>{h.spawnRef&&(h.pending=!1,h.active=!0,h.core.visible=!0,h.group.visible=!0,p.push(h.group))}),I.forEach(h=>{h.spawnRef&&(h.pending=!1,h.active=!0,h.core.visible=!0,h.group.visible=!0,p.push(h.group))}),X.forEach(h=>{h.spawnRef&&(h.state="idle",h.mesh.visible=!0,p.push(h.mesh))}),p}return{update:St,prewarm:Et,idleCull:Lt,spawnHealRingAt:te,materializeAll:we}}async function tc(e,{spawn:t=null,spawnArray:o=[],playerObj:l,camera:a,canFire:y=null,spinRate:i=Mn.degToRad(30),gunArc:u=Mn.degToRad(30),fireInterval:S=1.2,materialMode:w="standard"}={}){const Z=a;t||(Array.isArray(o)&&o.length?t=o[0]:t={x:0,y:0,z:0});const d=200,E=(await new Un().loadAsync("./models/plat.glb")).scene;E.scale.setScalar(8),E.position.set(t.x,t.y,t.z),e.add(E),E.visible=!1,E.userData.active=!1;const f=[new n(.66,.025,0),new n(0,.025,.66),new n(-.66,.025,0),new n(0,.025,-.66)],D=3.2,W=f.map(De=>De.clone().multiplyScalar(D)),L=new Float32Array(4).fill(0),x=160,N=2,$=new tn(.3,.3,6).translate(0,0,3),M=new cn({color:16737792}),ie=Array.from({length:32},()=>{const De=new xe($,M);return De.visible=!1,e.add(De),De});function P(De){const Me=ie.find(Ae=>!Ae.visible);if(!Me)return;const ge=W[De].clone();E.localToWorld(ge),Me.position.copy(ge),l.getWorldPosition(Y),Me.lookAt(Y),Me.visible=!0,Me.userData.life=N,Me.userData.dir=1,Me.userData.bounced=!1,L[De]=S}const V=[];function k(){V.length=0;for(let De=0;De<ie.length;De++){const Me=ie[De];Me.visible&&V.push(Me)}return V}const R=[],g=w==="lambert";E.traverse(De=>{De.isMesh&&(De.material=g?cs(De.material):De.material.clone(),R.push(De))});const B=new Io(1.6,1.9,4),me=new cn({color:65407,side:ms}),U=new xe(B,me);U.visible=!1,U.position.y=1,U.scale.setScalar(5),e.add(U),E.userData.lockRing=U,E.userData={enemy:!0,enemyRoot:!0,hp:5,flashT:0,meshes:R,blink(){this.flashT=.15,R.forEach(De=>{De.material.emissive&&De.material.emissive.setRGB(1,0,0)})}},E.userData.lockRing=U;const H=new n,C=new n,c=new n,Y=new n,q=new Rt,se=new n,ne=new n;function fe(De){const Me=typeof y=="function"?y():!0;E.rotateY(i*De*10);const ge=100;if(l.getWorldPosition(C),E.getWorldPosition(c),!E.userData.active){if(C.distanceToSquared(c)>d*d)return;E.visible=!0,E.userData.active=!0}if(!E.userData.dead&&C.z<c.z-ge){E.visible=!1,E.userData.active=!1,E.userData.dead=!0;return}if(U.visible&&Z&&(E.getWorldPosition(U.position),Z.getWorldQuaternion(q),U.quaternion.copy(q)),E.userData.flashT>0&&(E.userData.flashT-=De,E.userData.flashT<=0&&R.forEach(Ae=>{Ae.material.emissive&&Ae.material.emissive.setRGB(0,0,0)})),ie.forEach(Ae=>{Ae.visible&&(Ae.translateZ(x*De*(Ae.userData.dir??1)),Ae.userData.life-=De,Ae.userData.life<=0&&(Ae.visible=!1))}),!!E.visible&&(l.getWorldPosition(C),E.getWorldPosition(c),se.copy(C).sub(c),se.y=0,!(se.lengthSq()<1e-4))){se.normalize(),l.getWorldPosition(C),E.getWorldPosition(c),H.copy(C).sub(c).setY(0).normalize();for(let Ae=0;Ae<4;++Ae)L[Ae]-=De,!(L[Ae]>0)&&(ne.copy(f[Ae]).applyQuaternion(E.quaternion).setY(0).normalize(),Me&&ne.dot(H)>=.866&&P(Ae))}}return{update:fe,getActiveLasers:k,getMesh:()=>E,getActiveShips:()=>E.visible?[E]:[],prewarm(De,Me){const ge=E.visible,Ae=E.frustumCulled;E.visible=!0,E.frustumCulled=!1,De.render(e,Me),E.visible=ge,E.frustumCulled=Ae}}}const nc=new Un,mo={proto:null,promise:null};async function sc(e="./models/turret.glb"){if(mo.proto)return mo.proto;mo.promise||(mo.promise=nc.loadAsync(e));const t=await mo.promise;return mo.proto=t.scene,mo.proto}async function oc(e,{playerObj:t,stationMesh:o,camera:l=null,spawn:a={x:0,y:0,z:0},boltPool:y=null,canFire:i=null,materialMode:u="standard"}={}){var De;const D=(await sc()).clone(!0);D.scale.setScalar(5),D.position.set(a.x,a.y,a.z),e.add(D),D.visible=!1,D.userData.active=!1,D.userData.enemy=!0,D.userData.enemyRoot=!0,D.userData.hp=3,D.userData.flashT=0,D.userData.dead=!1;const W=[],L=u==="lambert";D.traverse(Me=>{Me.isMesh&&(Me.material=L?cs(Me.material):Me.material.clone(),W.push(Me))}),D.userData.meshes=W,D.userData.blink=function(){this.flashT=.15,W.forEach(Me=>{Me.material.emissive&&Me.material.emissive.setRGB(1,0,0)})};const x=new Io(1.6,1.9,4),N=new cn({color:65407,side:ms}),$=new xe(x,N);$.visible=!1,$.scale.setScalar(4),e.add($),D.userData.lockRing=$;function M(){return[]}const ie=new wa,P=new n,V=new n,k=new n,R=new n,g=new n,B=new n,me=new n,U=new Rt;let H=0;y??((De=e.userData)==null||De.boltPool);const C=.75;let c=!1;function Y(){if(!y)return;const Me=y.alloc({big:!1,life:3,dir:1,bounced:!1});Me&&(D.getWorldQuaternion(U),D.getWorldPosition(me),B.set(0,0,-1).applyQuaternion(U),me.addScaledVector(B,2),y.setTransform(Me,me,U),D.userData.activeBoltHandle=Me)}function q(Me){const ge=typeof i=="function"?i():!0;if(D.userData.flashT>0&&(D.userData.flashT-=Me,D.userData.flashT<=0&&W.forEach(pe=>{pe.material.emissive&&pe.material.emissive.setRGB(0,0,0)})),D.userData.dead)return;if(t.getWorldPosition(P),D.getWorldPosition(R),c&&Me>0?k.copy(P).sub(V).multiplyScalar(1/Me):(k.set(0,0,0),c=!0),V.copy(P),P.z<R.z-100){D.visible=!1,D.userData.active=!1,D.userData.dead=!0;return}if(!D.userData.active)if(P.distanceToSquared(R)<36e4)D.visible=!0,D.userData.active=!0,H=0;else return;const Ae=R.distanceTo(P),ye=Math.min(Ae/160,C);if(g.copy(P).addScaledVector(k,ye),D.lookAt(g),$.visible&&l&&(D.getWorldPosition($.position),l.getWorldQuaternion($.quaternion)),H+=Me,H>=1){H=0,B.subVectors(g,R).normalize(),ie.set(R,B);const Ee=ie.intersectObject(o,!0).length===0;ge&&Ee&&Y()}}function se(){return D.visible?[D]:[]}function ne(){return D.userData.dead?!1:(D.visible=!1,D.userData.active=!1,D.userData.dead=!0,$&&($.visible=!1),!0)}function fe(){return D}return{update:q,getActiveShips:se,getActiveLasers:M,destroy:ne,getMesh:fe}}function ic(e,{smallCount:t=200,bigCount:o=30,smallColor:l=16737792,bigColor:a=16750848}={}){const y=new tn(.3,.3,6).translate(0,0,3),i=new cn({color:l}),u=new Ka(y,i,t);u.instanceMatrix.setUsage($a),u.visible=!0,u.frustumCulled=!1,e.add(u);const S=new tn(.6,.6,12).translate(0,0,6),w=new cn({color:a}),Z=new Ka(S,w,o);Z.instanceMatrix.setUsage($a),Z.visible=!0,Z.frustumCulled=!1,e.add(Z);const d=new Array(t).fill(null).map(()=>({active:!1,life:0,dir:1,bounced:!1,scale:1,prev:new n,pos:new n,quat:new Rt})),E=new Array(o).fill(null).map(()=>({active:!1,life:0,dir:1,bounced:!1,scale:1,prev:new n,pos:new n,quat:new Rt})),f=[],D=new n;function W(k,R){const g=L({big:!1,life:.01,dir:1}),B=L({big:!0,life:.01,dir:1});x(g,new n,new Rt),x(B,new n,new Rt),P(0);const me=k.getSize(new Vn);k.setSize(64,64,!1),k.render(e,R),k.setSize(me.x,me.y,!1),N(g),N(B)}function L({big:k=!1,life:R=2,dir:g=1,bounced:B=!1,scale:me=1}={}){const U=k?E:d,H=U.findIndex(c=>!c.active);if(H===-1)return null;const C=U[H];return C.active=!0,C.life=R,C.dir=g,C.bounced=B,C.scale=me,{isBig:k,idx:H}}function x(k,R,g,B){if(!k)return;const U=(k.isBig?E:d)[k.idx];U.pos.copy(R),U.quat.copy(g),U.scale=B??U.scale,U.bounced=k.bounced??U.bounced,U.dir=k.dir??U.dir}function N(k){if(!k)return;const g=(k.isBig?E:d)[k.idx];g.active=!1,g.life=0}const $=new Vs,M=new n;function ie(k,R){let g=0;for(let B=0;B<k.length;B++){const me=k[B];me.active&&(M.set(me.scale,me.scale,me.scale),$.compose(me.pos,me.quat,M),R.setMatrixAt(g,$),me._drawIndex=g,g++)}R.count=g,R.instanceMatrix.needsUpdate=!0}function P(k){f.length=0,d.forEach(R=>{R.active&&(R.prev.copy(R.pos),D.set(0,0,1).applyQuaternion(R.quat),R.pos.addScaledVector(D,160*k*R.dir),R.life-=k,R.life<=0&&(R.active=!1))}),E.forEach(R=>{R.active&&(R.prev.copy(R.pos),D.set(0,0,1).applyQuaternion(R.quat),R.pos.addScaledVector(D,200*k*R.dir),R.life-=k,R.life<=0&&(R.active=!1,R.scale=1))}),d.forEach(R=>{R.active&&f.push({position:R.pos,prev:R.prev,userData:R,handle:R,isBig:!1,visible:!0})}),E.forEach(R=>{R.active&&f.push({position:R.pos,prev:R.prev,userData:R,handle:R,isBig:!0,visible:!0})}),ie(d,u),ie(E,Z)}function V(){return f}return{alloc:L,setTransform:x,free:N,update:P,getActive:V,meshSmall:u,meshBig:Z,prewarm:W}}const ac=["map","aoMap","alphaMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","metalnessMap","normalMap","roughnessMap","specularMap","clearcoatMap","clearcoatRoughnessMap","sheenColorMap","sheenRoughnessMap","iridescenceMap","iridescenceThicknessMap","transmissionMap","thicknessMap"];function Hr(e,t){if(!(!e||typeof t!="number")){if(Array.isArray(e)){e.forEach(o=>Hr(o,t));return}for(const o of ac){const l=e[o];l&&l.isTexture&&(l.anisotropy=Math.min(l.anisotropy??t,t))}}}function Nr(e){return e&&(Array.isArray(e)?e.map(Nr):new ga({color:e.color?e.color.clone():new ls(16777215),map:e.map??null,emissive:e.emissive?e.emissive.clone():new ls(0),emissiveMap:e.emissiveMap??null,emissiveIntensity:e.emissiveIntensity??1,transparent:e.transparent??!1,opacity:e.opacity??1,alphaTest:e.alphaTest??0,side:e.side??$o,depthWrite:e.depthWrite??!0,depthTest:e.depthTest??!0}))}function rc(e){e.updateMatrixWorld(!0),e.traverse(t=>{t.matrixAutoUpdate=!1})}function lc(e=4){const t=new Map,o=(y,i,u)=>`${y}|${i}|${u}`;function l(y,i,u){const S=e,w=new n(Math.floor(y.x/S),Math.floor(y.y/S),Math.floor(y.z/S)),Z=new n(Math.floor(i.x/S),Math.floor(i.y/S),Math.floor(i.z/S));for(let d=w.x;d<=Z.x;d++)for(let E=w.y;E<=Z.y;E++)for(let f=w.z;f<=Z.z;f++){const D=o(d,E,f);let W=t.get(D);W||(W=[],t.set(D,W)),W.push(u)}}function a(y,i,u=[]){const S=new Set,w=e,Z=new n(Math.floor(y.x/w),Math.floor(y.y/w),Math.floor(y.z/w)),d=new n(Math.floor(i.x/w),Math.floor(i.y/w),Math.floor(i.z/w));for(let E=Z.x;E<=d.x;E++)for(let f=Z.y;f<=d.y;f++)for(let D=Z.z;D<=d.z;D++){const W=`${E}|${f}|${D}`,L=t.get(W);if(L)for(const x of L)S.has(x)||(S.add(x),u.push(x))}return u}return{insertTri:l,queryAABB:a,cellSize:e}}function cc(e,t,o,l,a,y,i,u,S){const w=y.subVectors(o,t),Z=i.subVectors(l,t),d=u.subVectors(e,t),E=w.dot(d),f=Z.dot(d);if(E<=0&&f<=0)return a.copy(t),a;const D=u.subVectors(e,o),W=w.dot(D),L=Z.dot(D);if(W>=0&&L<=W)return a.copy(o),a;const x=E*L-W*f;if(x<=0&&E>=0&&W<=0){const g=E/(E-W);return a.copy(w).multiplyScalar(g).add(t),a}const N=u.subVectors(e,l),$=w.dot(N),M=Z.dot(N);if(M>=0&&$<=M)return a.copy(l),a;const ie=$*f-E*M;if(ie<=0&&f>=0&&M<=0){const g=f/(f-M);return a.copy(Z).multiplyScalar(g).add(t),a}const P=W*M-$*L;if(P<=0&&L-W>=0&&$-M>=0){const g=(L-W)/(L-W+($-M));return a.copy(S.subVectors(l,o)).multiplyScalar(g).add(o),a}const V=1/(P+ie+x),k=ie*V,R=x*V;return a.copy(t).addScaledVector(w,k).addScaledVector(Z,R),a}function ar(e,t,o,l,a,y,i,u,S,w){const d=y.subVectors(l,o),E=i.subVectors(a,o),f=u.crossVectors(t,E),D=d.dot(f);if(D>-1e-8&&D<1e-8)return 1/0;const W=1/D,L=S.subVectors(e,o),x=L.dot(f)*W;if(x<0||x>1)return 1/0;const N=w.crossVectors(L,d),$=t.dot(N)*W;if($<0||x+$>1)return 1/0;const M=E.dot(N)*W;return M>1e-8?M:1/0}function uc(e,t=4,o=null){const l=new n,a=new n,y=new n,i=new n,u=new n,S=new n,w=new n,Z=new bn,d=new n,E=new n,f=[];e.updateMatrixWorld(!0),e.traverse(H=>{if(H.isMesh&&H.geometry){const C=H.geometry.clone();C.applyMatrix4(H.matrixWorld),f.push(C)}});const D=Lr(f,!1),W=D.getAttribute("position"),L=D.index?D.index.array:Array.from({length:W.count},(H,C)=>C),x=L.length/3,N=new Array(x),$=lc(t);for(let H=0;H<x;H++){const C=L[H*3+0],c=L[H*3+1],Y=L[H*3+2],q=new n(W.getX(C),W.getY(C),W.getZ(C)),se=new n(W.getX(c),W.getY(c),W.getZ(c)),ne=new n(W.getX(Y),W.getY(Y),W.getZ(Y));E.copy(se).sub(q).cross(a.copy(ne).sub(q)).normalize(),N[H]={a:q,b:se,c:ne,n:E.clone()},S.set(Math.min(q.x,se.x,ne.x),Math.min(q.y,se.y,ne.y),Math.min(q.z,se.z,ne.z)),w.set(Math.max(q.x,se.x,ne.x),Math.max(q.y,se.y,ne.y),Math.max(q.z,se.z,ne.z)),$.insertTri(S,w,H)}const M=new bn().setFromObject(e),ie=[];function P(H,C,c,Y,q){return Y.set(Math.min(H.x,C.x)-c,Math.min(H.y,C.y)-c,Math.min(H.z,C.z)-c),q.set(Math.max(H.x,C.x)+c,Math.max(H.y,C.y)+c,Math.max(H.z,C.z)+c),new bn(Y.clone(),q.clone())}function V(H,C,c=[]){return c.length=0,$.queryAABB(H,C,c)}function k(H,C){if(Z.copy(M).expandByScalar(C),!Z.containsPoint(H))return{hit:!1};const c={hit:!1,point:new n,normal:new n,depth:0};S.set(H.x-C,H.y-C,H.z-C),w.set(H.x+C,H.y+C,H.z+C);const Y=V(S,w,ie);let q=0;for(let se=0;se<Y.length;se++){const ne=N[Y[se]],fe=cc(H,ne.a,ne.b,ne.c,d,l,a,y,i),De=H.distanceToSquared(fe);if(De<=C*C){const Me=Math.sqrt(De),ge=C-Me;ge>q&&(q=ge,c.hit=!0,c.point.copy(fe),c.normal.copy(ne.n),c.depth=ge)}}return c}function R(H,C,c,Y=3){const q={position:new n().copy(C),hit:!1,iterations:0,normal:new n};if(!P(H,C,c,S,w).intersectsBox(M))return q;for(let ne=0;ne<Y;ne++){const fe=k(q.position,c);if(!fe.hit)break;const De=l.copy(fe.normal).multiplyScalar(fe.depth+.001);q.position.add(De),q.hit=!0,q.normal.copy(fe.normal),q.iterations++}return q}function g(H,C,c=1/0){const q=new ba(H,C).intersectBox(M,new n);if(q===null||q>c)return{hit:!1};const se=l.copy(C).multiplyScalar(c).add(H);S.set(Math.min(H.x,se.x),Math.min(H.y,se.y),Math.min(H.z,se.z)),w.set(Math.max(H.x,se.x),Math.max(H.y,se.y),Math.max(H.z,se.z));const ne=V(S,w,ie);let fe=c,De=null;for(let Me=0;Me<ne.length;Me++){const ge=N[ne[Me]],Ae=ar(H,C,ge.a,ge.b,ge.c,l,a,y,i,u);Ae<fe&&(fe=Ae,De=ge.n)}if(fe!==c){const Me=l.copy(C).multiplyScalar(fe).add(H);return{hit:!0,t:fe,point:Me.clone(),normal:De.clone()}}return{hit:!1}}function B(H){if(!M.containsPoint(H))return!1;S.set(H.x,H.y,H.z),w.copy(M.max);const C=V(S,w,ie),c=a.set(1,0,0);let Y=0;for(let q=0;q<C.length;q++){const se=N[C[q]],ne=ar(H,c,se.a,se.b,se.c,l,a,y,i,u);ne!==1/0&&ne>1e-5&&Y++}return Y%2===1}function me(H=new cn({color:65535,wireframe:!0,transparent:!0,opacity:.15})){if(!o)return null;const C=new xe(D,H);return o.add(C),C}return{testSphere:k,constrainPoint:R,linecast:g,isPointInside:B,addDebugWire:me,worldAABB:M}}async function dc(e,{playerObj:t,camera:o,onDestroyed:l=()=>{},colliderCellSize:a=4,anisotropyCap:y=1,freezeTransforms:i=!0}={}){const S=(await new Un().loadAsync("./models/station.glb")).scene;S.scale.setScalar(72),S.position.set(30,-40,-4e3),e.add(S),S.visible=!0,S.userData.enemy=!0,S.userData.enemyRoot=!0,S.userData.hp=100,S.userData.flashT=0,S.userData.dead=!1,S.userData.onDestroyed=l;const w=[];S.traverse(V=>{V.isMesh&&(V.material=Nr(V.material),Hr(V.material,y),w.push(V))}),i&&rc(S);const Z=uc(S,a,e);S.userData.collider=Z,S.userData.meshes=w,S.userData.blink=()=>{S.userData.flashT=.15,w.forEach(V=>{V.material.emissive&&V.material.emissive.setRGB(1,0,0)})};const d=new Io(1.6,1.9,4),E=new cn({color:65407,side:ms}),f=new xe(d,E);f.visible=!1,f.scale.setScalar(15),e.add(f),S.userData.lockRing=f;function D(){return S}function W(){return S.visible?[S]:[]}function L(V=1){var k,R;S.userData.dead||(S.userData.hp=Math.max(0,S.userData.hp-V),S.userData.blink(),S.userData.hp===0&&(S.visible=!1,S.userData.dead=!0,(R=(k=S.userData).onDestroyed)==null||R.call(k)))}const x=new Rt,N=new n;function $(V){if(!S.userData.dead&&t&&(t.getWorldPosition(N),S.position.z>N.z+80)){S.visible=!1,S.userData.dead=!0,f.visible=!1;return}S.userData.flashT>0&&(S.userData.flashT-=V,S.userData.flashT<=0&&w.forEach(k=>{k.material.emissive&&k.material.emissive.setRGB(0,0,0)})),f.visible&&o&&(S.getWorldPosition(f.position),o.getWorldQuaternion(x),f.quaternion.copy(x))}const M=new n,ie=new n;function P(V,k){if(!V||!k)return;const R=5,g=V.getRenderTarget(),B=k.layers.mask,me=S.visible,U=S.position.clone(),H=S.quaternion.clone(),C=[],c=[];S.visible=!0,k.getWorldPosition(M),k.getWorldDirection(ie),S.position.copy(M).addScaledVector(ie,120),S.quaternion.copy(k.quaternion),S.traverse(q=>{C.push([q,q.layers.mask]),q.layers.set(R),q.isMesh&&(c.push([q,q.frustumCulled]),q.frustumCulled=!1)}),k.layers.set(R);const Y=new ya(16,16);"outputColorSpace"in V&&V.outputColorSpace&&(Y.texture.colorSpace=V.outputColorSpace),V.setRenderTarget(Y),V.render(e,k),V.setRenderTarget(g),Y.dispose(),k.layers.mask=B,S.visible=me,S.position.copy(U),S.quaternion.copy(H),c.forEach(([q,se])=>{q.frustumCulled=se}),C.forEach(([q,se])=>{q.layers.mask=se})}return{update:$,getMesh:D,damageStation:L,getActiveShips:W,prewarm:P}}const fc=["map","aoMap","alphaMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","metalnessMap","normalMap","roughnessMap","specularMap","clearcoatMap","clearcoatRoughnessMap","sheenColorMap","sheenRoughnessMap","iridescenceMap","iridescenceThicknessMap","transmissionMap","thicknessMap"];function qr(e,t){if(!(!e||typeof t!="number")){if(Array.isArray(e)){e.forEach(o=>qr(o,t));return}for(const o of fc){const l=e[o];l&&l.isTexture&&(l.anisotropy=Math.min(l.anisotropy??t,t))}}}function pc(e){e.updateMatrixWorld(!0),e.traverse(t=>{t.matrixAutoUpdate=!1})}function hc(e=4){const t=new Map,o=(y,i,u)=>`${y}|${i}|${u}`;function l(y,i,u){const S=e,w=new n(Math.floor(y.x/S),Math.floor(y.y/S),Math.floor(y.z/S)),Z=new n(Math.floor(i.x/S),Math.floor(i.y/S),Math.floor(i.z/S));for(let d=w.x;d<=Z.x;d++)for(let E=w.y;E<=Z.y;E++)for(let f=w.z;f<=Z.z;f++){const D=o(d,E,f);let W=t.get(D);W||(W=[],t.set(D,W)),W.push(u)}}function a(y,i,u=[]){const S=new Set,w=e,Z=new n(Math.floor(y.x/w),Math.floor(y.y/w),Math.floor(y.z/w)),d=new n(Math.floor(i.x/w),Math.floor(i.y/w),Math.floor(i.z/w));for(let E=Z.x;E<=d.x;E++)for(let f=Z.y;f<=d.y;f++)for(let D=Z.z;D<=d.z;D++){const W=`${E}|${f}|${D}`,L=t.get(W);if(L)for(const x of L)S.has(x)||(S.add(x),u.push(x))}return u}return{insertTri:l,queryAABB:a,cellSize:e}}function mc(e,t,o,l,a){const y=Xo.subVectors(o,t),i=Oi.subVectors(l,t),u=Ai.subVectors(e,t),S=y.dot(u),w=i.dot(u);if(S<=0&&w<=0)return a.copy(t),a;const Z=Ai.subVectors(e,o),d=y.dot(Z),E=i.dot(Z);if(d>=0&&E<=d)return a.copy(o),a;const f=S*E-d*w;if(f<=0&&S>=0&&d<=0){const P=S/(S-d);return a.copy(y).multiplyScalar(P).add(t),a}const D=Ai.subVectors(e,l),W=y.dot(D),L=i.dot(D);if(L>=0&&W<=L)return a.copy(l),a;const x=W*w-S*L;if(x<=0&&w>=0&&L<=0){const P=w/(w-L);return a.copy(i).multiplyScalar(P).add(t),a}const N=d*L-W*E;if(N<=0&&E-d>=0&&W-L>=0){const P=(E-d)/(E-d+(W-L));return a.copy(Gr.subVectors(l,o)).multiplyScalar(P).add(o),a}const $=1/(N+x+f),M=x*$,ie=f*$;return a.copy(t).addScaledVector(y,M).addScaledVector(i,ie),a}function rr(e,t,o,l,a){const i=Xo.subVectors(l,o),u=Oi.subVectors(a,o),S=Ai.crossVectors(t,u),w=i.dot(S);if(w>-1e-8&&w<1e-8)return 1/0;const Z=1/w,d=Gr.subVectors(e,o),E=d.dot(S)*Z;if(E<0||E>1)return 1/0;const f=gc.crossVectors(d,i),D=t.dot(f)*Z;if(D<0||E+D>1)return 1/0;const W=u.dot(f)*Z;return W>1e-8?W:1/0}const Xo=new n,Oi=new n,Ai=new n,Gr=new n,gc=new n,Fs=new n,Hs=new n,lr=new bn,yc=new n,cr=new n,Cs=new n;async function yi(e,{path:t="./models/asteroid_passage.glb",position:o={x:0,y:0,z:-900},rotation:l={x:0,y:0,z:45},scale:a=30,cellSize:y="auto",visible:i=!0,materialMode:u="default",anisotropyCap:S=1,freezeTransforms:w=!0}={}){const d=(await new Un().loadAsync(t)).scene;d.position.set(o.x,o.y,o.z),d.rotation.set(l.x,l.y,l.z),d.scale.setScalar(a),d.visible=i,e.add(d);const E=[];d.updateMatrixWorld(!0);const f=u==="lambert",D=c=>c&&(Array.isArray(c)?c.map(D):new ga({color:c.color?c.color.clone():new ls(16777215),map:c.map??null,emissive:c.emissive?c.emissive.clone():new ls(0),emissiveMap:c.emissiveMap??null,emissiveIntensity:c.emissiveIntensity??1,transparent:c.transparent??!1,opacity:c.opacity??1,alphaTest:c.alphaTest??0,side:c.side??$o,depthWrite:c.depthWrite??!0,depthTest:c.depthTest??!0}));d.traverse(c=>{if(c.isMesh&&c.geometry){if(c.visible===!1)return;const Y=c.geometry.clone();Y.applyMatrix4(c.matrixWorld),E.push(Y),c.material=f?D(c.material):c.material.clone(),qr(c.material,S)}}),w&&pc(d);const W=Lr(E,!1),L=W.getAttribute("position"),x=W.index?W.index.array:Array.from({length:L.count},(c,Y)=>Y),N=x.length/3;if(y==="auto"||y===null||!Number.isFinite(y)||y<=0){W.boundingBox||W.computeBoundingBox(),W.boundingBox.getSize(Cs);const Y=Math.max(Cs.x,Cs.y,Cs.z),q=Math.min(Cs.x,Cs.y,Cs.z),se=Cs.x+Cs.y+Cs.z-Y-q,ne=Math.max(q,Y*.15),fe=Math.max(Y*se*ne,.001),De=N/fe,ge=Math.cbrt(140/Math.max(De,1e-6));y=Mn.clamp(ge,4,18)}const $=new Array(N),M=hc(y);for(let c=0;c<N;c++){const Y=x[c*3+0],q=x[c*3+1],se=x[c*3+2],ne=new n(L.getX(Y),L.getY(Y),L.getZ(Y)),fe=new n(L.getX(q),L.getY(q),L.getZ(q)),De=new n(L.getX(se),L.getY(se),L.getZ(se));cr.copy(fe).sub(ne).cross(Oi.copy(De).sub(ne)).normalize(),$[c]={a:ne,b:fe,c:De,n:cr.clone()},Fs.set(Math.min(ne.x,fe.x,De.x),Math.min(ne.y,fe.y,De.y),Math.min(ne.z,fe.z,De.z)),Hs.set(Math.max(ne.x,fe.x,De.x),Math.max(ne.y,fe.y,De.y),Math.max(ne.z,fe.z,De.z)),M.insertTri(Fs,Hs,c)}const ie=new bn().setFromObject(d);function P(c,Y,q=[]){return q.length=0,M.queryAABB(c,Y,q)}function V(c,Y){if(lr.copy(ie).expandByScalar(Y),!lr.containsPoint(c))return{hit:!1};const q={hit:!1,point:new n,normal:new n,depth:0};Fs.set(c.x-Y,c.y-Y,c.z-Y),Hs.set(c.x+Y,c.y+Y,c.z+Y);const se=P(Fs,Hs,me);let ne=0;for(let fe=0;fe<se.length;fe++){const De=$[se[fe]],Me=mc(c,De.a,De.b,De.c,yc),ge=c.distanceToSquared(Me);if(ge<=Y*Y){const Ae=Math.sqrt(ge),ye=Y-Ae;ye>ne&&(ne=ye,q.hit=!0,q.point.copy(Me),q.normal.copy(De.n),q.depth=ye)}}return q}function k(c,Y,q,se=3){const ne={position:new n().copy(Y),hit:!1,iterations:0,normal:new n};if(!U(c,Y,q,Fs,Hs).intersectsBox(ie))return ne;for(let De=0;De<se;De++){const Me=V(ne.position,q);if(!Me.hit)break;const ge=Xo.copy(Me.normal).multiplyScalar(Me.depth+.001);ne.position.add(ge),ne.hit=!0,ne.normal.copy(Me.normal),ne.iterations++}return ne}function R(c,Y,q=1/0){const ne=new ba(c,Y).intersectBox(ie,new n);if(ne===null||ne>q)return{hit:!1};const fe=Xo.copy(Y).multiplyScalar(q).add(c);Fs.set(Math.min(c.x,fe.x),Math.min(c.y,fe.y),Math.min(c.z,fe.z)),Hs.set(Math.max(c.x,fe.x),Math.max(c.y,fe.y),Math.max(c.z,fe.z));const De=P(Fs,Hs,me);let Me=q,ge=null;for(let Ae=0;Ae<De.length;Ae++){const ye=$[De[Ae]],pe=rr(c,Y,ye.a,ye.b,ye.c);pe<Me&&(Me=pe,ge=ye.n)}if(Me!==q){const Ae=Xo.copy(Y).multiplyScalar(Me).add(c);return{hit:!0,t:Me,point:Ae.clone(),normal:ge.clone()}}return{hit:!1}}function g(c){if(!ie.containsPoint(c))return!1;Fs.set(c.x,c.y,c.z),Hs.copy(ie.max);const Y=P(Fs,Hs,me),q=Oi.set(1,0,0);let se=0;for(let ne=0;ne<Y.length;ne++){const fe=$[Y[ne]],De=rr(c,q,fe.a,fe.b,fe.c);De!==1/0&&De>1e-5&&se++}return se%2===1}function B(c=new cn({color:65535,wireframe:!0,transparent:!0,opacity:.15})){const Y=new xe(W,c);return e.add(Y),Y}const me=[];function U(c,Y,q,se,ne){return se.set(Math.min(c.x,Y.x)-q,Math.min(c.y,Y.y)-q,Math.min(c.z,Y.z)-q),ne.set(Math.max(c.x,Y.x)+q,Math.max(c.y,Y.y)+q,Math.max(c.z,Y.z)+q),new bn(se.clone(),ne.clone())}const H={testSphere:V,constrainPoint:k,linecast:R,isPointInside:g,addDebugWire:B,worldAABB:ie};H.mesh=d,d.userData.collider=H;function C(c,Y){const q=d.visible;d.visible=!0;const se=[];d.traverse(ne=>{ne.isMesh&&(se.push([ne,ne.frustumCulled]),ne.frustumCulled=!1)}),c.render(e,Y),d.visible=q,se.forEach(([ne,fe])=>{ne.frustumCulled=fe})}return{getMesh:()=>d,collider:H,update:()=>{},prewarm:C}}const ur={type:"change"},Da={type:"start"},Vr={type:"end"},wi=new ba,dr=new kr,wc=Math.cos(70*Mn.DEG2RAD),Wn=new n,rs=2*Math.PI,dn={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},ua=1e-6;class bc extends Ir{constructor(t,o=null){super(t,o),this.state=dn.NONE,this.target=new n,this.cursor=new n,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:zo.ROTATE,MIDDLE:zo.DOLLY,RIGHT:zo.PAN},this.touches={ONE:Ro.ROTATE,TWO:Ro.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new n,this._lastQuaternion=new Rt,this._lastTargetPosition=new n,this._quat=new Rt().setFromUnitVectors(t.up,new n(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new Ja,this._sphericalDelta=new Ja,this._scale=1,this._panOffset=new n,this._rotateStart=new Vn,this._rotateEnd=new Vn,this._rotateDelta=new Vn,this._panStart=new Vn,this._panEnd=new Vn,this._panDelta=new Vn,this._dollyStart=new Vn,this._dollyEnd=new Vn,this._dollyDelta=new Vn,this._dollyDirection=new n,this._mouse=new Vn,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=vc.bind(this),this._onPointerDown=Dc.bind(this),this._onPointerUp=xc.bind(this),this._onContextMenu=Tc.bind(this),this._onMouseWheel=Sc.bind(this),this._onKeyDown=Ec.bind(this),this._onTouchStart=Pc.bind(this),this._onTouchMove=Ac.bind(this),this._onMouseDown=Mc.bind(this),this._onMouseMove=_c.bind(this),this._interceptControlDown=Rc.bind(this),this._interceptControlUp=Cc.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(t){t.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=t}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(ur),this.update(),this.state=dn.NONE}update(t=null){const o=this.object.position;Wn.copy(o).sub(this.target),Wn.applyQuaternion(this._quat),this._spherical.setFromVector3(Wn),this.autoRotate&&this.state===dn.NONE&&this._rotateLeft(this._getAutoRotationAngle(t)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let l=this.minAzimuthAngle,a=this.maxAzimuthAngle;isFinite(l)&&isFinite(a)&&(l<-Math.PI?l+=rs:l>Math.PI&&(l-=rs),a<-Math.PI?a+=rs:a>Math.PI&&(a-=rs),l<=a?this._spherical.theta=Math.max(l,Math.min(a,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(l+a)/2?Math.max(l,this._spherical.theta):Math.min(a,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let y=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const i=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),y=i!=this._spherical.radius}if(Wn.setFromSpherical(this._spherical),Wn.applyQuaternion(this._quatInverse),o.copy(this.target).add(Wn),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let i=null;if(this.object.isPerspectiveCamera){const u=Wn.length();i=this._clampDistance(u*this._scale);const S=u-i;this.object.position.addScaledVector(this._dollyDirection,S),this.object.updateMatrixWorld(),y=!!S}else if(this.object.isOrthographicCamera){const u=new n(this._mouse.x,this._mouse.y,0);u.unproject(this.object);const S=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),y=S!==this.object.zoom;const w=new n(this._mouse.x,this._mouse.y,0);w.unproject(this.object),this.object.position.sub(w).add(u),this.object.updateMatrixWorld(),i=Wn.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;i!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(i).add(this.object.position):(wi.origin.copy(this.object.position),wi.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(wi.direction))<wc?this.object.lookAt(this.target):(dr.setFromNormalAndCoplanarPoint(this.object.up,this.target),wi.intersectPlane(dr,this.target))))}else if(this.object.isOrthographicCamera){const i=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),i!==this.object.zoom&&(this.object.updateProjectionMatrix(),y=!0)}return this._scale=1,this._performCursorZoom=!1,y||this._lastPosition.distanceToSquared(this.object.position)>ua||8*(1-this._lastQuaternion.dot(this.object.quaternion))>ua||this._lastTargetPosition.distanceToSquared(this.target)>ua?(this.dispatchEvent(ur),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(t){return t!==null?rs/60*this.autoRotateSpeed*t:rs/60/60*this.autoRotateSpeed}_getZoomScale(t){const o=Math.abs(t*.01);return Math.pow(.95,this.zoomSpeed*o)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_panLeft(t,o){Wn.setFromMatrixColumn(o,0),Wn.multiplyScalar(-t),this._panOffset.add(Wn)}_panUp(t,o){this.screenSpacePanning===!0?Wn.setFromMatrixColumn(o,1):(Wn.setFromMatrixColumn(o,0),Wn.crossVectors(this.object.up,Wn)),Wn.multiplyScalar(t),this._panOffset.add(Wn)}_pan(t,o){const l=this.domElement;if(this.object.isPerspectiveCamera){const a=this.object.position;Wn.copy(a).sub(this.target);let y=Wn.length();y*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*t*y/l.clientHeight,this.object.matrix),this._panUp(2*o*y/l.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(t*(this.object.right-this.object.left)/this.object.zoom/l.clientWidth,this.object.matrix),this._panUp(o*(this.object.top-this.object.bottom)/this.object.zoom/l.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(t,o){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const l=this.domElement.getBoundingClientRect(),a=t-l.left,y=o-l.top,i=l.width,u=l.height;this._mouse.x=a/i*2-1,this._mouse.y=-(y/u)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(t){return Math.max(this.minDistance,Math.min(this.maxDistance,t))}_handleMouseDownRotate(t){this._rotateStart.set(t.clientX,t.clientY)}_handleMouseDownDolly(t){this._updateZoomParameters(t.clientX,t.clientX),this._dollyStart.set(t.clientX,t.clientY)}_handleMouseDownPan(t){this._panStart.set(t.clientX,t.clientY)}_handleMouseMoveRotate(t){this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const o=this.domElement;this._rotateLeft(rs*this._rotateDelta.x/o.clientHeight),this._rotateUp(rs*this._rotateDelta.y/o.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(t){this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(t){this._updateZoomParameters(t.clientX,t.clientY),t.deltaY<0?this._dollyIn(this._getZoomScale(t.deltaY)):t.deltaY>0&&this._dollyOut(this._getZoomScale(t.deltaY)),this.update()}_handleKeyDown(t){let o=!1;switch(t.code){case this.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateUp(rs*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),o=!0;break;case this.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateUp(-rs*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),o=!0;break;case this.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateLeft(rs*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),o=!0;break;case this.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateLeft(-rs*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),o=!0;break}o&&(t.preventDefault(),this.update())}_handleTouchStartRotate(t){if(this._pointers.length===1)this._rotateStart.set(t.pageX,t.pageY);else{const o=this._getSecondPointerPosition(t),l=.5*(t.pageX+o.x),a=.5*(t.pageY+o.y);this._rotateStart.set(l,a)}}_handleTouchStartPan(t){if(this._pointers.length===1)this._panStart.set(t.pageX,t.pageY);else{const o=this._getSecondPointerPosition(t),l=.5*(t.pageX+o.x),a=.5*(t.pageY+o.y);this._panStart.set(l,a)}}_handleTouchStartDolly(t){const o=this._getSecondPointerPosition(t),l=t.pageX-o.x,a=t.pageY-o.y,y=Math.sqrt(l*l+a*a);this._dollyStart.set(0,y)}_handleTouchStartDollyPan(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enablePan&&this._handleTouchStartPan(t)}_handleTouchStartDollyRotate(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enableRotate&&this._handleTouchStartRotate(t)}_handleTouchMoveRotate(t){if(this._pointers.length==1)this._rotateEnd.set(t.pageX,t.pageY);else{const l=this._getSecondPointerPosition(t),a=.5*(t.pageX+l.x),y=.5*(t.pageY+l.y);this._rotateEnd.set(a,y)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const o=this.domElement;this._rotateLeft(rs*this._rotateDelta.x/o.clientHeight),this._rotateUp(rs*this._rotateDelta.y/o.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(t){if(this._pointers.length===1)this._panEnd.set(t.pageX,t.pageY);else{const o=this._getSecondPointerPosition(t),l=.5*(t.pageX+o.x),a=.5*(t.pageY+o.y);this._panEnd.set(l,a)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(t){const o=this._getSecondPointerPosition(t),l=t.pageX-o.x,a=t.pageY-o.y,y=Math.sqrt(l*l+a*a);this._dollyEnd.set(0,y),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const i=(t.pageX+o.x)*.5,u=(t.pageY+o.y)*.5;this._updateZoomParameters(i,u)}_handleTouchMoveDollyPan(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enablePan&&this._handleTouchMovePan(t)}_handleTouchMoveDollyRotate(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enableRotate&&this._handleTouchMoveRotate(t)}_addPointer(t){this._pointers.push(t.pointerId)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let o=0;o<this._pointers.length;o++)if(this._pointers[o]==t.pointerId){this._pointers.splice(o,1);return}}_isTrackingPointer(t){for(let o=0;o<this._pointers.length;o++)if(this._pointers[o]==t.pointerId)return!0;return!1}_trackPointer(t){let o=this._pointerPositions[t.pointerId];o===void 0&&(o=new Vn,this._pointerPositions[t.pointerId]=o),o.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const o=t.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[o]}_customWheelEvent(t){const o=t.deltaMode,l={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(o){case 1:l.deltaY*=16;break;case 2:l.deltaY*=100;break}return t.ctrlKey&&!this._controlActive&&(l.deltaY*=10),l}}function Dc(e){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(e)&&(this._addPointer(e),e.pointerType==="touch"?this._onTouchStart(e):this._onMouseDown(e)))}function vc(e){this.enabled!==!1&&(e.pointerType==="touch"?this._onTouchMove(e):this._onMouseMove(e))}function xc(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(Vr),this.state=dn.NONE;break;case 1:const t=this._pointers[0],o=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:o.x,pageY:o.y});break}}function Mc(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case zo.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(e),this.state=dn.DOLLY;break;case zo.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(e),this.state=dn.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(e),this.state=dn.ROTATE}break;case zo.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(e),this.state=dn.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(e),this.state=dn.PAN}break;default:this.state=dn.NONE}this.state!==dn.NONE&&this.dispatchEvent(Da)}function _c(e){switch(this.state){case dn.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(e);break;case dn.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(e);break;case dn.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(e);break}}function Sc(e){this.enabled===!1||this.enableZoom===!1||this.state!==dn.NONE||(e.preventDefault(),this.dispatchEvent(Da),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(Vr))}function Ec(e){this.enabled!==!1&&this._handleKeyDown(e)}function Pc(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case Ro.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(e),this.state=dn.TOUCH_ROTATE;break;case Ro.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(e),this.state=dn.TOUCH_PAN;break;default:this.state=dn.NONE}break;case 2:switch(this.touches.TWO){case Ro.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(e),this.state=dn.TOUCH_DOLLY_PAN;break;case Ro.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(e),this.state=dn.TOUCH_DOLLY_ROTATE;break;default:this.state=dn.NONE}break;default:this.state=dn.NONE}this.state!==dn.NONE&&this.dispatchEvent(Da)}function Ac(e){switch(this._trackPointer(e),this.state){case dn.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(e),this.update();break;case dn.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(e),this.update();break;case dn.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(e),this.update();break;case dn.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=dn.NONE}}function Tc(e){this.enabled!==!1&&e.preventDefault()}function Rc(e){e.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Cc(e){e.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const go=new wa,Jn=new n,Js=new n,Sn=new Rt,fr={X:new n(1,0,0),Y:new n(0,1,0),Z:new n(0,0,1)},da={type:"change"},pr={type:"mouseDown",mode:null},hr={type:"mouseUp",mode:null},mr={type:"objectChange"};class zc extends Ir{constructor(t,o=null){super(void 0,o);const l=new Wc(this);this._root=l;const a=new Fc;this._gizmo=a,l.add(a);const y=new Hc;this._plane=y,l.add(y);const i=this;function u($,M){let ie=M;Object.defineProperty(i,$,{get:function(){return ie!==void 0?ie:M},set:function(P){ie!==P&&(ie=P,y[$]=P,a[$]=P,i.dispatchEvent({type:$+"-changed",value:P}),i.dispatchEvent(da))}}),i[$]=M,y[$]=M,a[$]=M}u("camera",t),u("object",void 0),u("enabled",!0),u("axis",null),u("mode","translate"),u("translationSnap",null),u("rotationSnap",null),u("scaleSnap",null),u("space","world"),u("size",1),u("dragging",!1),u("showX",!0),u("showY",!0),u("showZ",!0),u("minX",-1/0),u("maxX",1/0),u("minY",-1/0),u("maxY",1/0),u("minZ",-1/0),u("maxZ",1/0);const S=new n,w=new n,Z=new Rt,d=new Rt,E=new n,f=new Rt,D=new n,W=new n,L=new n,x=0,N=new n;u("worldPosition",S),u("worldPositionStart",w),u("worldQuaternion",Z),u("worldQuaternionStart",d),u("cameraPosition",E),u("cameraQuaternion",f),u("pointStart",D),u("pointEnd",W),u("rotationAxis",L),u("rotationAngle",x),u("eye",N),this._offset=new n,this._startNorm=new n,this._endNorm=new n,this._cameraScale=new n,this._parentPosition=new n,this._parentQuaternion=new Rt,this._parentQuaternionInv=new Rt,this._parentScale=new n,this._worldScaleStart=new n,this._worldQuaternionInv=new Rt,this._worldScale=new n,this._positionStart=new n,this._quaternionStart=new Rt,this._scaleStart=new n,this._getPointer=Lc.bind(this),this._onPointerDown=Ic.bind(this),this._onPointerHover=kc.bind(this),this._onPointerMove=Bc.bind(this),this._onPointerUp=Oc.bind(this),o!==null&&this.connect(o)}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(this.object===void 0||this.dragging===!0)return;t!==null&&go.setFromCamera(t,this.camera);const o=fa(this._gizmo.picker[this.mode],go);o?this.axis=o.object.name:this.axis=null}pointerDown(t){if(!(this.object===void 0||this.dragging===!0||t!=null&&t.button!==0)&&this.axis!==null){t!==null&&go.setFromCamera(t,this.camera);const o=fa(this._plane,go,!0);o&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(o.point).sub(this.worldPositionStart)),this.dragging=!0,pr.mode=this.mode,this.dispatchEvent(pr)}}pointerMove(t){const o=this.axis,l=this.mode,a=this.object;let y=this.space;if(l==="scale"?y="local":(o==="E"||o==="XYZE"||o==="XYZ")&&(y="world"),a===void 0||o===null||this.dragging===!1||t!==null&&t.button!==-1)return;t!==null&&go.setFromCamera(t,this.camera);const i=fa(this._plane,go,!0);if(i){if(this.pointEnd.copy(i.point).sub(this.worldPositionStart),l==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),y==="local"&&o!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),o.indexOf("X")===-1&&(this._offset.x=0),o.indexOf("Y")===-1&&(this._offset.y=0),o.indexOf("Z")===-1&&(this._offset.z=0),y==="local"&&o!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),a.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(y==="local"&&(a.position.applyQuaternion(Sn.copy(this._quaternionStart).invert()),o.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),o.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),o.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(this._quaternionStart)),y==="world"&&(a.parent&&a.position.add(Jn.setFromMatrixPosition(a.parent.matrixWorld)),o.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),o.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),o.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(Jn.setFromMatrixPosition(a.parent.matrixWorld)))),a.position.x=Math.max(this.minX,Math.min(this.maxX,a.position.x)),a.position.y=Math.max(this.minY,Math.min(this.maxY,a.position.y)),a.position.z=Math.max(this.minZ,Math.min(this.maxZ,a.position.z));else if(l==="scale"){if(o.search("XYZ")!==-1){let u=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(u*=-1),Js.set(u,u,u)}else Jn.copy(this.pointStart),Js.copy(this.pointEnd),Jn.applyQuaternion(this._worldQuaternionInv),Js.applyQuaternion(this._worldQuaternionInv),Js.divide(Jn),o.search("X")===-1&&(Js.x=1),o.search("Y")===-1&&(Js.y=1),o.search("Z")===-1&&(Js.z=1);a.scale.copy(this._scaleStart).multiply(Js),this.scaleSnap&&(o.search("X")!==-1&&(a.scale.x=Math.round(a.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),o.search("Y")!==-1&&(a.scale.y=Math.round(a.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),o.search("Z")!==-1&&(a.scale.z=Math.round(a.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(l==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const u=20/this.worldPosition.distanceTo(Jn.setFromMatrixPosition(this.camera.matrixWorld));let S=!1;o==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Jn.copy(this.rotationAxis).cross(this.eye))*u):(o==="X"||o==="Y"||o==="Z")&&(this.rotationAxis.copy(fr[o]),Jn.copy(fr[o]),y==="local"&&Jn.applyQuaternion(this.worldQuaternion),Jn.cross(this.eye),Jn.length()===0?S=!0:this.rotationAngle=this._offset.dot(Jn.normalize())*u),(o==="E"||S)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),y==="local"&&o!=="E"&&o!=="XYZE"?(a.quaternion.copy(this._quaternionStart),a.quaternion.multiply(Sn.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),a.quaternion.copy(Sn.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),a.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(da),this.dispatchEvent(mr)}}pointerUp(t){t!==null&&t.button!==0||(this.dragging&&this.axis!==null&&(hr.mode=this.mode,this.dispatchEvent(hr)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(da),this.dispatchEvent(mr),this.pointStart.copy(this.pointEnd))}getRaycaster(){return go}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function Lc(e){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:e.button};{const t=this.domElement.getBoundingClientRect();return{x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1,button:e.button}}}function kc(e){if(this.enabled)switch(e.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(e));break}}function Ic(e){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(e)),this.pointerDown(this._getPointer(e)))}function Bc(e){this.enabled&&this.pointerMove(this._getPointer(e))}function Oc(e){this.enabled&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(e)))}function fa(e,t,o){const l=t.intersectObject(e,!0);for(let a=0;a<l.length;a++)if(l[a].object.visible||o)return l[a];return!1}const bi=new vl,wn=new n(0,1,0),gr=new n(0,0,0),yr=new Vs,Di=new Rt,Ti=new Rt,zs=new n,wr=new Vs,Uo=new n(1,0,0),yo=new n(0,1,0),Zo=new n(0,0,1),vi=new n,Go=new n,Vo=new n;class Wc extends so{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const o=this.controls;o.object!==void 0&&(o.object.updateMatrixWorld(),o.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):o.object.parent.matrixWorld.decompose(o._parentPosition,o._parentQuaternion,o._parentScale),o.object.matrixWorld.decompose(o.worldPosition,o.worldQuaternion,o._worldScale),o._parentQuaternionInv.copy(o._parentQuaternion).invert(),o._worldQuaternionInv.copy(o.worldQuaternion).invert()),o.camera.updateMatrixWorld(),o.camera.matrixWorld.decompose(o.cameraPosition,o.cameraQuaternion,o._cameraScale),o.camera.isOrthographicCamera?o.camera.getWorldDirection(o.eye).negate():o.eye.copy(o.cameraPosition).sub(o.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}class Fc extends so{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new cn({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),o=new Br({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),l=t.clone();l.opacity=.15;const a=o.clone();a.opacity=.5;const y=t.clone();y.color.setHex(16711680);const i=t.clone();i.color.setHex(65280);const u=t.clone();u.color.setHex(255);const S=t.clone();S.color.setHex(16711680),S.opacity=.5;const w=t.clone();w.color.setHex(65280),w.opacity=.5;const Z=t.clone();Z.color.setHex(255),Z.opacity=.5;const d=t.clone();d.opacity=.25;const E=t.clone();E.color.setHex(16776960),E.opacity=.25,t.clone().color.setHex(16776960);const D=t.clone();D.color.setHex(7895160);const W=new Xn(0,.04,.1,12);W.translate(0,.05,0);const L=new tn(.08,.08,.08);L.translate(0,.04,0);const x=new Li;x.setAttribute("position",new er([0,0,0,1,0,0],3));const N=new Xn(.0075,.0075,.5,3);N.translate(0,.25,0);function $(C,c){const Y=new Po(C,.0075,3,64,c*Math.PI*2);return Y.rotateY(Math.PI/2),Y.rotateX(Math.PI/2),Y}function M(){const C=new Li;return C.setAttribute("position",new er([0,0,0,1,1,1],3)),C}const ie={X:[[new xe(W,y),[.5,0,0],[0,0,-Math.PI/2]],[new xe(W,y),[-.5,0,0],[0,0,Math.PI/2]],[new xe(N,y),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new xe(W,i),[0,.5,0]],[new xe(W,i),[0,-.5,0],[Math.PI,0,0]],[new xe(N,i)]],Z:[[new xe(W,u),[0,0,.5],[Math.PI/2,0,0]],[new xe(W,u),[0,0,-.5],[-Math.PI/2,0,0]],[new xe(N,u),null,[Math.PI/2,0,0]]],XYZ:[[new xe(new mi(.1,0),d.clone()),[0,0,0]]],XY:[[new xe(new tn(.15,.15,.01),Z.clone()),[.15,.15,0]]],YZ:[[new xe(new tn(.15,.15,.01),S.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new xe(new tn(.15,.15,.01),w.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},P={X:[[new xe(new Xn(.2,0,.6,4),l),[.3,0,0],[0,0,-Math.PI/2]],[new xe(new Xn(.2,0,.6,4),l),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new xe(new Xn(.2,0,.6,4),l),[0,.3,0]],[new xe(new Xn(.2,0,.6,4),l),[0,-.3,0],[0,0,Math.PI]]],Z:[[new xe(new Xn(.2,0,.6,4),l),[0,0,.3],[Math.PI/2,0,0]],[new xe(new Xn(.2,0,.6,4),l),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new xe(new mi(.2,0),l)]],XY:[[new xe(new tn(.2,.2,.01),l),[.15,.15,0]]],YZ:[[new xe(new tn(.2,.2,.01),l),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new xe(new tn(.2,.2,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]]},V={START:[[new xe(new mi(.01,2),a),null,null,null,"helper"]],END:[[new xe(new mi(.01,2),a),null,null,null,"helper"]],DELTA:[[new Ns(M(),a),null,null,null,"helper"]],X:[[new Ns(x,a.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Ns(x,a.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Ns(x,a.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},k={XYZE:[[new xe($(.5,1),D),null,[0,Math.PI/2,0]]],X:[[new xe($(.5,.5),y)]],Y:[[new xe($(.5,.5),i),null,[0,0,-Math.PI/2]]],Z:[[new xe($(.5,.5),u),null,[0,Math.PI/2,0]]],E:[[new xe($(.75,1),E),null,[0,Math.PI/2,0]]]},R={AXIS:[[new Ns(x,a.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},g={XYZE:[[new xe(new To(.25,10,8),l)]],X:[[new xe(new Po(.5,.1,4,24),l),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new xe(new Po(.5,.1,4,24),l),[0,0,0],[Math.PI/2,0,0]]],Z:[[new xe(new Po(.5,.1,4,24),l),[0,0,0],[0,0,-Math.PI/2]]],E:[[new xe(new Po(.75,.1,2,24),l)]]},B={X:[[new xe(L,y),[.5,0,0],[0,0,-Math.PI/2]],[new xe(N,y),[0,0,0],[0,0,-Math.PI/2]],[new xe(L,y),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new xe(L,i),[0,.5,0]],[new xe(N,i)],[new xe(L,i),[0,-.5,0],[0,0,Math.PI]]],Z:[[new xe(L,u),[0,0,.5],[Math.PI/2,0,0]],[new xe(N,u),[0,0,0],[Math.PI/2,0,0]],[new xe(L,u),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new xe(new tn(.15,.15,.01),Z),[.15,.15,0]]],YZ:[[new xe(new tn(.15,.15,.01),S),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new xe(new tn(.15,.15,.01),w),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new xe(new tn(.1,.1,.1),d.clone())]]},me={X:[[new xe(new Xn(.2,0,.6,4),l),[.3,0,0],[0,0,-Math.PI/2]],[new xe(new Xn(.2,0,.6,4),l),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new xe(new Xn(.2,0,.6,4),l),[0,.3,0]],[new xe(new Xn(.2,0,.6,4),l),[0,-.3,0],[0,0,Math.PI]]],Z:[[new xe(new Xn(.2,0,.6,4),l),[0,0,.3],[Math.PI/2,0,0]],[new xe(new Xn(.2,0,.6,4),l),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new xe(new tn(.2,.2,.01),l),[.15,.15,0]]],YZ:[[new xe(new tn(.2,.2,.01),l),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new xe(new tn(.2,.2,.01),l),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new xe(new tn(.2,.2,.2),l),[0,0,0]]]},U={X:[[new Ns(x,a.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Ns(x,a.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Ns(x,a.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function H(C){const c=new so;for(const Y in C)for(let q=C[Y].length;q--;){const se=C[Y][q][0].clone(),ne=C[Y][q][1],fe=C[Y][q][2],De=C[Y][q][3],Me=C[Y][q][4];se.name=Y,se.tag=Me,ne&&se.position.set(ne[0],ne[1],ne[2]),fe&&se.rotation.set(fe[0],fe[1],fe[2]),De&&se.scale.set(De[0],De[1],De[2]),se.updateMatrix();const ge=se.geometry.clone();ge.applyMatrix4(se.matrix),se.geometry=ge,se.renderOrder=1/0,se.position.set(0,0,0),se.rotation.set(0,0,0),se.scale.set(1,1,1),c.add(se)}return c}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=H(ie)),this.add(this.gizmo.rotate=H(k)),this.add(this.gizmo.scale=H(B)),this.add(this.picker.translate=H(P)),this.add(this.picker.rotate=H(g)),this.add(this.picker.scale=H(me)),this.add(this.helper.translate=H(V)),this.add(this.helper.rotate=H(R)),this.add(this.helper.scale=H(U)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const l=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:Ti;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let a=[];a=a.concat(this.picker[this.mode].children),a=a.concat(this.gizmo[this.mode].children),a=a.concat(this.helper[this.mode].children);for(let y=0;y<a.length;y++){const i=a[y];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);let u;if(this.camera.isOrthographicCamera?u=(this.camera.top-this.camera.bottom)/this.camera.zoom:u=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),i.scale.set(1,1,1).multiplyScalar(u*this.size/4),i.tag==="helper"){i.visible=!1,i.name==="AXIS"?(i.visible=!!this.axis,this.axis==="X"&&(Sn.setFromEuler(bi.set(0,0,0)),i.quaternion.copy(l).multiply(Sn),Math.abs(wn.copy(Uo).applyQuaternion(l).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="Y"&&(Sn.setFromEuler(bi.set(0,0,Math.PI/2)),i.quaternion.copy(l).multiply(Sn),Math.abs(wn.copy(yo).applyQuaternion(l).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="Z"&&(Sn.setFromEuler(bi.set(0,Math.PI/2,0)),i.quaternion.copy(l).multiply(Sn),Math.abs(wn.copy(Zo).applyQuaternion(l).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="XYZE"&&(Sn.setFromEuler(bi.set(0,Math.PI/2,0)),wn.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(yr.lookAt(gr,wn,yo)),i.quaternion.multiply(Sn),i.visible=this.dragging),this.axis==="E"&&(i.visible=!1)):i.name==="START"?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):i.name==="END"?(i.position.copy(this.worldPosition),i.visible=this.dragging):i.name==="DELTA"?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),Jn.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Jn.applyQuaternion(this.worldQuaternionStart.clone().invert()),i.scale.copy(Jn),i.visible=this.dragging):(i.quaternion.copy(l),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=this.axis.search(i.name)!==-1));continue}i.quaternion.copy(l),this.mode==="translate"||this.mode==="scale"?(i.name==="X"&&Math.abs(wn.copy(Uo).applyQuaternion(l).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="Y"&&Math.abs(wn.copy(yo).applyQuaternion(l).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="Z"&&Math.abs(wn.copy(Zo).applyQuaternion(l).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="XY"&&Math.abs(wn.copy(Zo).applyQuaternion(l).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="YZ"&&Math.abs(wn.copy(Uo).applyQuaternion(l).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="XZ"&&Math.abs(wn.copy(yo).applyQuaternion(l).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1)):this.mode==="rotate"&&(Di.copy(l),wn.copy(this.eye).applyQuaternion(Sn.copy(l).invert()),i.name.search("E")!==-1&&i.quaternion.setFromRotationMatrix(yr.lookAt(this.eye,gr,yo)),i.name==="X"&&(Sn.setFromAxisAngle(Uo,Math.atan2(-wn.y,wn.z)),Sn.multiplyQuaternions(Di,Sn),i.quaternion.copy(Sn)),i.name==="Y"&&(Sn.setFromAxisAngle(yo,Math.atan2(wn.x,wn.z)),Sn.multiplyQuaternions(Di,Sn),i.quaternion.copy(Sn)),i.name==="Z"&&(Sn.setFromAxisAngle(Zo,Math.atan2(wn.y,wn.x)),Sn.multiplyQuaternions(Di,Sn),i.quaternion.copy(Sn))),i.visible=i.visible&&(i.name.indexOf("X")===-1||this.showX),i.visible=i.visible&&(i.name.indexOf("Y")===-1||this.showY),i.visible=i.visible&&(i.name.indexOf("Z")===-1||this.showZ),i.visible=i.visible&&(i.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),i.material._color=i.material._color||i.material.color.clone(),i.material._opacity=i.material._opacity||i.material.opacity,i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled&&this.axis&&(i.name===this.axis||this.axis.split("").some(function(S){return i.name===S}))&&(i.material.color.setHex(16776960),i.material.opacity=1)}super.updateMatrixWorld(t)}}class Hc extends xe{constructor(){super(new Cr(1e5,1e5,2,2),new cn({visible:!1,wireframe:!0,side:ms,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let o=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(o="local"),vi.copy(Uo).applyQuaternion(o==="local"?this.worldQuaternion:Ti),Go.copy(yo).applyQuaternion(o==="local"?this.worldQuaternion:Ti),Vo.copy(Zo).applyQuaternion(o==="local"?this.worldQuaternion:Ti),wn.copy(Go),this.mode){case"translate":case"scale":switch(this.axis){case"X":wn.copy(this.eye).cross(vi),zs.copy(vi).cross(wn);break;case"Y":wn.copy(this.eye).cross(Go),zs.copy(Go).cross(wn);break;case"Z":wn.copy(this.eye).cross(Vo),zs.copy(Vo).cross(wn);break;case"XY":zs.copy(Vo);break;case"YZ":zs.copy(vi);break;case"XZ":wn.copy(Vo),zs.copy(Go);break;case"XYZ":case"E":zs.set(0,0,0);break}break;case"rotate":default:zs.set(0,0,0)}zs.length()===0?this.quaternion.copy(this.cameraQuaternion):(wr.lookAt(Jn.set(0,0,0),zs,wn),this.quaternion.setFromRotationMatrix(wr)),super.updateMatrixWorld(t)}}Rl.enabled=!0;var Ar,Tr;const Nc=!!(typeof window<"u"&&((Tr=(Ar=window==null?void 0:window.process)==null?void 0:Ar.versions)!=null&&Tr.electron)),Ut=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope||!!globalThis.__IS_RENDER_WORKER,In=!Ut&&typeof window<"u"&&(window.__EDITOR__||new URLSearchParams(window.location.search).has("editor")),qc=!0,Gc=!Ut&&!Nc&&qc&&!In,Ko=5e3,Yr="Mission 1: Orbital Assault",Ur="Objective: Breach Oblivion Airspace",wo=3600,Ri=1350,Vc=wo*2+Ri,br=750,Yc=14e3,Dr=5e3,Wi=4200,Fi="KeyP",Zr="KeyB",Gn="lambert",Qo=new Set(["KeyA","KeyD","KeyW","KeyS","KeyQ","KeyE",Fi,Zr,"ShiftLeft","ShiftRight","KeyJ","KeyN","Space"]);let Uc=null,Ci=!1,Hi=null,vr=!1,xr=!0,xi=0,Mi=0,_i=null,Si=null;const bo=new Set,Lo=()=>typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now(),es={startMs:null,endMs:null,shotsFired:0,shotsHit:0,enemiesDestroyed:0,ringsCollected:0},Qr=4096,Zc=Qr-1,Mr=new Uint32Array(Qr),Qc=()=>{es.shotsFired+=1},_r=e=>{const t=e>>>0;if(!t)return;const o=t&Zc;Mr[o]!==t&&(Mr[o]=t,es.shotsHit+=1)},Yo=()=>{es.enemiesDestroyed+=1},jc=(e=1)=>{e>0&&(es.ringsCollected+=e)},Sr=(e=null)=>{const t=Number.isFinite(e)?e:Lo(),o=Number.isFinite(es.startMs)?es.startMs:t;return{timeMs:Math.max(0,t-o),shotsFired:es.shotsFired,shotsHit:es.shotsHit,enemiesDestroyed:es.enemiesDestroyed,ringsCollected:es.ringsCollected}},Xc=e=>{const t=Math.max(0,Math.floor(e/1e3)),o=Math.floor(t/60),l=t%60;return`${o}:${String(l).padStart(2,"0")}`},Ni=e=>{if(!e)return[];const t=e.shotsFired??0,o=e.shotsHit??0,l=t>0?Math.round(o/t*100):0;return[`TIME: ${Xc(e.timeMs??0)}`,`ENEMIES DESTROYED: ${e.enemiesDestroyed??0}`,`ACCURACY: ${l}% (${o}/${t})`,`RINGS COLLECTED: ${e.ringsCollected??0}`]};let jr=0;const Xr=e=>{const t=typeof e=="number"?e:0;jr=Lo()+Math.max(0,t)},Kr=()=>Lo()<jr,qs=e=>Mn.degToRad(e??0),Ei=(e={})=>{const t=e.rotationDeg??e.rotationDegrees??null;if(t)return{x:qs(t.x),y:qs(t.y),z:qs(t.z)};const o=e.rotation??null;return o&&(o.unit==="deg"||o.units==="deg"||o.deg===!0)?{x:qs(o.x),y:qs(o.y),z:qs(o.z)}:o??{x:0,y:0,z:0}},ma=[],Ms=(e,{group:t,index:o,ref:l}={})=>{!In||!e||(e.traverse(a=>{a.matrixAutoUpdate=!0,a.matrixWorldNeedsUpdate=!0}),e.userData.editorRef=l??null,e.userData.editorGroup=t??null,e.userData.editorIndex=Number.isFinite(o)?o:null,e.userData.editorSelectable=!0,e.traverse(a=>{a.isMesh&&(a.userData.__editorRoot=e)}),ma.push(e))};function Kc(){if(Ut||typeof document>"u")return null;const e=document.createElement("div");Object.assign(e.style,{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.6)",color:"#0f0",font:"14px/1.5 monospace",letterSpacing:"0.05em",textTransform:"uppercase",textAlign:"center",opacity:"0",pointerEvents:"none",zIndex:9999,transition:"opacity 0.2s ease"});const t=document.createElement("div");Object.assign(t.style,{padding:"14px 20px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",boxShadow:"0 0 12px rgba(0,255,0,0.15)",minWidth:"260px"});const o=document.createElement("div");o.textContent="PAUSED",o.style.fontSize="16px",o.style.marginBottom="8px";const l=document.createElement("div");Object.assign(l.style,{display:"grid",rowGap:"4px"}),["Move: W/A/S/D","Shoot: Space","Charge: Hold Space","Roll: Q/E","Bank: Hold Shift","Bomb: B","Boost: J","Brake: N","Pause/Menu: P"].forEach(g=>{const B=document.createElement("div");B.textContent=g,l.appendChild(B)}),t.appendChild(o),t.appendChild(l);const a=document.createElement("div");Object.assign(a.style,{marginTop:"12px",display:"none",flexDirection:"column",alignItems:"center",rowGap:"8px"});const y=document.createElement("button");y.type="button",y.textContent="Start Over?",Object.assign(y.style,{padding:"6px 14px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",color:"#0f0",font:"13px monospace",letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer"});const i=document.createElement("div");i.textContent="[Enter]",Object.assign(i.style,{fontSize:"11px",opacity:"0.7",letterSpacing:"0.06em"});const u=document.createElement("div");Object.assign(u.style,{display:"none",flexDirection:"column",alignItems:"center",rowGap:"8px"});const S=document.createElement("div");S.textContent="Are you sure?";const w=document.createElement("div");Object.assign(w.style,{display:"flex",gap:"12px",justifyContent:"center"});const Z=document.createElement("button");Z.type="button",Z.textContent="Yes",Object.assign(Z.style,{padding:"5px 12px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",color:"#0f0",font:"12px monospace",letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer"});const d=document.createElement("button");d.type="button",d.textContent="No",Object.assign(d.style,{padding:"5px 12px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",color:"#0f0",font:"12px monospace",letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer"});const E=document.createElement("div");Object.assign(E.style,{display:"grid",rowGap:"2px",fontSize:"11px",opacity:"0.7",letterSpacing:"0.06em",justifyItems:"center"});const f=document.createElement("div");f.textContent="[Enter]";const D=document.createElement("div");D.textContent="A: Yes / D: No",E.appendChild(f),E.appendChild(D);const W=(g,B)=>{g.style.boxShadow=B?"0 0 10px rgba(0,255,0,0.5)":"none",g.style.background=B?"rgba(0,0,0,0.85)":"rgba(0,0,0,0.7)"};w.appendChild(Z),w.appendChild(d),u.appendChild(S),u.appendChild(w),u.appendChild(E),a.appendChild(y),a.appendChild(i),a.appendChild(u),t.appendChild(a),e.appendChild(t),document.body.appendChild(e);let L=!1,x=!1,N="main",$="no",M=null;const ie=g=>{$=g==="yes"?"yes":"no";const B=$==="yes";W(Z,B),W(d,!B);try{(B?Z:d).focus({preventScroll:!0})}catch{(B?Z:d).focus()}},P=g=>{if(N=g==="confirm"?"confirm":"main",N==="main")if(u.style.display="none",y.style.display=x?"inline-block":"none",i.style.display=x?"block":"none",x){W(y,!0);try{y.focus({preventScroll:!0})}catch{y.focus()}}else W(y,!1);else y.style.display="none",i.style.display="none",u.style.display="flex",ie("no")},V=()=>{M||(M=g=>{if(!(!L||!x)){if(g.key==="Enter"){g.preventDefault(),g.stopPropagation(),N==="main"?y.click():$==="yes"?Z.click():d.click();return}N==="confirm"&&!g.repeat&&(g.code==="KeyA"||g.code==="KeyD")&&(g.preventDefault(),g.stopPropagation(),ie($==="yes"?"no":"yes"))}},document.addEventListener("keydown",M))},k=()=>{M&&(document.removeEventListener("keydown",M),M=null)};y.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),P("confirm")}),Z.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),window.location.reload()}),d.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),P("main")});const R=(g,B)=>{if(L=!!g,B&&(o.textContent=B),e.style.opacity=L?"1":"0",e.style.pointerEvents=L?"auto":"none",!L){k(),P("main");return}x?V():k()};return{show:(g,B={})=>{x=!!B.showRestart,a.style.display=x?"flex":"none",P("main"),R(!0,g)},hide:()=>R(!1),setVisible:R}}function $c(){if(Ut||typeof document>"u")return null;const e=document.createElement("div");Object.assign(e.style,{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.75)",color:"#0f0",font:"16px/1.5 monospace",letterSpacing:"0.08em",textTransform:"uppercase",textAlign:"center",opacity:"0",pointerEvents:"none",zIndex:10002,transition:"opacity 0.3s ease"});const t=document.createElement("div");Object.assign(t.style,{padding:"18px 28px",border:"1px solid #0f0",background:"rgba(0,0,0,0.8)",boxShadow:"0 0 16px rgba(0,255,0,0.18)",minWidth:"280px",pointerEvents:"auto"});const o=document.createElement("div");o.style.fontSize="18px",o.style.marginBottom="8px";const l=document.createElement("div");l.style.fontSize="14px",l.style.letterSpacing="0.06em";const a=document.createElement("div");Object.assign(a.style,{marginTop:"8px",display:"none",fontSize:"12px",letterSpacing:"0.05em",lineHeight:"1.5"});const y=document.createElement("div");Object.assign(y.style,{marginTop:"10px",display:"none",justifyContent:"center",gap:"8px"});const i=document.createElement("button");i.type="button",i.textContent="Play Again?",Object.assign(i.style,{marginTop:"12px",padding:"6px 14px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",color:"#0f0",font:"13px monospace",letterSpacing:"0.08em",textTransform:"uppercase",cursor:"pointer",display:"none"}),i.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation(),window.location.reload()}),i.style.boxShadow="none";const u=document.createElement("div");u.textContent="[Enter]",Object.assign(u.style,{marginTop:"6px",fontSize:"11px",opacity:"0.7",letterSpacing:"0.06em",display:"none"});let S=null,w=null;const Z=()=>{S||(S=D=>{D.key==="Enter"&&(D.preventDefault(),D.stopPropagation(),i.click())},document.addEventListener("keydown",S))},d=()=>{S&&(document.removeEventListener("keydown",S),S=null)};return t.appendChild(o),t.appendChild(l),t.appendChild(a),t.appendChild(y),t.appendChild(i),t.appendChild(u),e.appendChild(t),document.body.appendChild(e),{show:({titleText:D="",scoreText:W="",statsLines:L=[],showRestart:x=!1,badgeSources:N=[]}={})=>{if(o.textContent=D,W?(l.textContent=W,l.style.display="block"):(l.textContent="",l.style.display="none"),Array.isArray(L)&&L.length?(a.innerHTML="",L.forEach(M=>{const ie=document.createElement("div");ie.textContent=M,a.appendChild(ie)}),a.style.display="block"):(a.innerHTML="",a.style.display="none"),Array.isArray(N)&&N.length?(y.innerHTML="",N.forEach(M=>{const ie=document.createElement("img");ie.src=M,Object.assign(ie.style,{width:"3em",height:"3em",objectFit:"contain",imageRendering:"auto",filter:"drop-shadow(0 0 4px rgba(0,255,0,0.25))"}),y.appendChild(ie)}),y.style.display="flex"):(y.innerHTML="",y.style.display="none"),i.style.display=x?"inline-block":"none",i.style.boxShadow=x?"0 0 12px rgba(0,255,0,0.45)":"none",i.style.background=x?"rgba(0,0,0,0.85)":"rgba(0,0,0,0.7)",u.style.display=x?"block":"none",e.style.pointerEvents=x?"auto":"none",w&&(w.cancel(),w=null),x&&(D==="GAME OVER"||D==="MISSION COMPLETE"||D==="MISSION ACCOMPLISHED")&&(w=u.animate([{opacity:.2},{opacity:1},{opacity:.2}],{duration:1600,iterations:1/0})),x){Z();try{i.focus({preventScroll:!0})}catch{i.focus()}}else d();e.style.opacity="1"},hide:()=>{e.style.pointerEvents="none",e.style.opacity="0",w&&(w.cancel(),w=null),d()}}}function Jc({onPreviewDone:e=()=>{},onFinish:t=()=>{}}={}){if(Ut||typeof document>"u")return null;const o=document.createElement("div");Object.assign(o.style,{position:"fixed",inset:0,pointerEvents:"none",zIndex:9998,opacity:"1",transition:`opacity ${br}ms ease`});const l=document.createElement("div");Object.assign(l.style,{position:"absolute",inset:0,background:"#000",opacity:"1",transition:`opacity ${wo}ms ease`});const a=document.createElement("div");Object.assign(a.style,{position:"absolute",left:"50%",bottom:"10vh",transform:"translateX(-50%)",display:"flex",flexDirection:"column",alignItems:"center",gap:"8px",zIndex:2,opacity:"1",transition:"opacity 0.25s ease"});const y=document.createElement("div");Object.assign(y.style,{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",opacity:"0",pointerEvents:"none",zIndex:1,transition:"opacity 0.4s ease"});const i=document.createElement("div");Object.assign(i.style,{position:"absolute",left:0,top:0,width:"100%",height:"0px",display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none"});const u=document.createElement("img");u.src="./textures/title.png",u.alt="Game Title",Object.assign(u.style,{width:"32vw",maxWidth:"360px",minWidth:"200px",height:"auto",imageRendering:"auto",objectFit:"contain",opacity:"0.95"}),i.appendChild(u);const S=document.createElement("div");Object.assign(S.style,{padding:"14px 20px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",boxShadow:"0 0 12px rgba(0,255,0,0.15)",minWidth:"260px",color:"#0f0",font:"14px/1.5 monospace",letterSpacing:"0.05em",textTransform:"uppercase",textAlign:"center"});const w=document.createElement("div");w.textContent="Controls",w.style.fontSize="16px",w.style.marginBottom="8px";const Z=document.createElement("div");Object.assign(Z.style,{display:"grid",rowGap:"4px"}),(In?["Camera: LMB rotate / RMB pan / Wheel zoom","Select: Click mesh","Move: G","Rotate: R","Scale: S","Save: Ctrl+S","Escape: Deselect"]:["Move: W/A/S/D","Shoot: Space","Charge: Hold Space","Roll: Q/E","Bank: Hold Shift","Bomb: B","Boost: J","Brake: N","Pause/Menu: P"]).forEach(ge=>{const Ae=document.createElement("div");Ae.textContent=ge,Z.appendChild(Ae)}),S.appendChild(w),S.appendChild(Z),y.appendChild(i),y.appendChild(S);const E=document.createElement("div");E.textContent="Plotting Course... 0%",Object.assign(E.style,{font:"14px monospace",color:"#0f0",letterSpacing:"0.04em",textTransform:"uppercase"});const f=document.createElement("div");Object.assign(f.style,{width:"60vw",maxWidth:"460px",minWidth:"220px",height:"8px",border:"1px solid #0f0",background:"rgba(0,0,0,0.55)",boxShadow:"0 0 10px rgba(0,255,0,0.2)"});const D=document.createElement("div");Object.assign(D.style,{width:"0%",height:"100%",background:"#0f0",transition:"width 0.2s linear"}),f.appendChild(D),a.appendChild(E),a.appendChild(f),o.appendChild(l),o.appendChild(y),o.appendChild(a),document.body.appendChild(o);const W=()=>{const ge=S.getBoundingClientRect(),Ae=Math.max(0,ge.top);i.style.height=`${Ae}px`},L=()=>W();window.addEventListener("resize",L),requestAnimationFrame(W);let x=0,N=0,$=0;const M=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now(),ie=Yc/99;let P=M,V=!1,k=null,R=null,g=null,B=!1,me=!1,U=null,H=!1,C=!1,c=!1;const Y=()=>{H||me||typeof e=="function"&&e()},q=(ge,Ae=!1)=>{const pe=Math.max(0,Math.min(Ae?100:99,Math.floor(ge)));pe!==x&&(x=pe,E.textContent=`Plotting Course... ${x}%`,D.style.width=`${x}%`,!c&&!C&&x>=33&&(C=!0,y.style.opacity="1"))},se=(ge,Ae)=>{if(!Ae||Ae<=0){N=Math.max(N,0);return}const ye=Math.max(0,Math.min(99,Math.floor(ge/Ae*99)));N=Math.max(N,ye)},ne=()=>{const ge=typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now(),Ae=Math.max(0,ge-M),ye=Math.min(99,Math.floor(Ae/ie));Math.min(99,Math.max(N,ye))>x&&ge-P>=ie&&(P=ge,q(x+1)),$=requestAnimationFrame(ne)};$=requestAnimationFrame(ne);const fe=(ge=!1)=>{if(!H){if(H=!0,$&&cancelAnimationFrame($),q(100,!0),k&&clearTimeout(k),R&&clearTimeout(R),window.removeEventListener("resize",L),ge){typeof o.remove=="function"?o.remove():o.parentNode&&o.parentNode.removeChild(o),typeof U=="function"&&U(),U=null;return}l.style.opacity="0",o.style.opacity="0",setTimeout(()=>{typeof o.remove=="function"?o.remove():o.parentNode&&o.parentNode.removeChild(o),typeof U=="function"&&U(),U=null},br+50)}};return{setProgressFromCounts:se,previewFlash:()=>{if(V)return;C&&!c&&(c=!0,y.style.opacity="0"),V=!0,B=!0,k&&clearTimeout(k),R&&clearTimeout(R),g&&(g.cancel(),g=null),l.style.opacity="1";const ge=wo*2+Ri;if(typeof l.animate=="function"){const Ae=wo/ge,ye=(wo+Ri)/ge;g=l.animate([{opacity:1,offset:0},{opacity:0,offset:Ae},{opacity:0,offset:ye},{opacity:1,offset:1}],{duration:ge,easing:"ease",fill:"forwards"}),g.onfinish=()=>{V=!1,g=null,Y(),me&&fe(!0)},g.oncancel=()=>{V=!1,g=null};return}l.style.opacity="0",k=setTimeout(()=>{l.style.opacity="1",R=setTimeout(()=>{V=!1,Y(),me&&fe(!0)},wo)},wo+Ri)},finish:ge=>{typeof ge=="function"&&(U=ge),!me&&(me=!0,typeof t=="function"&&t(),a.style.opacity="0",!V&&fe(B))}}}function eu({portraitSrc:e="",textLines:t=[],durationMs:o=4200}={}){if(Ut||typeof document>"u")return()=>{};const l=86,a=Math.max(48,Math.round(window.innerHeight*.15)),y=a/l,i=Array.isArray(t)?t:[String(t??"")],u=document.createElement("div");Object.assign(u.style,{position:"fixed",left:`${Math.round(24*y)}px`,bottom:`${Math.round(24*y)}px`,display:"flex",alignItems:"center",gap:`${Math.round(12*y)}px`,zIndex:10020,pointerEvents:"none",opacity:"0",transition:"opacity 0.2s ease"});const S=document.createElement("div");Object.assign(S.style,{width:`${a}px`,height:`${a}px`,border:"1px solid #0f0",background:"rgba(0,0,0,0.6)",boxShadow:"0 0 10px rgba(0,255,0,0.2)",overflow:"hidden",transform:"scaleY(0.04)",transformOrigin:"center",transition:"transform 0.25s ease-out"});const w=document.createElement("img");w.src=e,Object.assign(w.style,{width:"100%",height:"100%",objectFit:"cover",opacity:"0",transition:"opacity 0.2s ease"}),S.appendChild(w);const Z=document.createElement("div");Object.assign(Z.style,{minHeight:`${a}px`,padding:`${Math.round(10*y)}px ${Math.round(14*y)}px`,border:"1px solid rgba(0,255,0,0.6)",background:"rgba(30,120,200,0.35)",color:"#fff",font:`${Math.max(12,Math.round(14*y))}px/1.4 monospace`,letterSpacing:"0.03em",maxWidth:`${Math.round(360*y)}px`,transform:"scaleX(0)",transformOrigin:"left center",transition:"transform 0.3s ease-out"});const d=document.createElement("div");d.textContent=i.join(`
`),d.style.whiteSpace="pre-line",Z.appendChild(d),u.appendChild(S),u.appendChild(Z),document.body.appendChild(u);const E=setTimeout(()=>{w.style.opacity="1"},180),f=setTimeout(()=>{Z.style.transform="scaleX(1)"},260);requestAnimationFrame(()=>{u.style.opacity="1",S.style.transform="scaleY(1)"});const D=setTimeout(()=>{u.style.opacity="0"},Math.max(800,o)),W=setTimeout(()=>{typeof u.remove=="function"?u.remove():u.parentNode&&u.parentNode.removeChild(u)},Math.max(900,o+350));return()=>{clearTimeout(E),clearTimeout(f),clearTimeout(D),clearTimeout(W),typeof u.remove=="function"?u.remove():u.parentNode&&u.parentNode.removeChild(u)}}const eo=(e={})=>{if(Ut)return;const t=e.id;if(t&&bo.has(t))return;t&&bo.add(t);const o=Number.isFinite(e.durationMs)?e.durationMs:Wi,l=e.portraitSrc??"./textures/protag.png",a=e.textLines??[];Si&&(Si(),Si=null),Si=eu({portraitSrc:l,textLines:a,durationMs:o})},ko=!Ut&&typeof document<"u"?Kc():null,pa=!Ut&&typeof document<"u"?$c():null;let va=!1,qi=!1,$r=!1;const Jr=(e="PAUSED",{lock:t=!1}={})=>{va=!0,t&&(qi=!0),ko==null||ko.show(e,{showRestart:!t&&e==="PAUSED"})},Ui=({force:e=!1}={})=>{qi&&!e||(va=!1,qi=!1,ko==null||ko.hide())},Gi=({titleText:e="",scoreText:t="",statsLines:o=[],showRestart:l=!1,badgeSources:a=[]}={})=>{$r=!0,Ui({force:!0}),pa==null||pa.show({titleText:e,scoreText:t,statsLines:o,showRestart:l,badgeSources:a})},tu=()=>{$r||qi||(va?Ui():Jr("PAUSED"))},Yn=!Ut&&typeof document<"u"?Jc({onPreviewDone:()=>{},onFinish:()=>Ui({force:!0})}):null;function Er(e,t){if(Ut&&typeof(self==null?void 0:self.postMessage)=="function"){self.postMessage({type:"loadingProgress",loaded:e,total:t});return}Yn==null||Yn.setProgressFromCounts(e,t)}function nu(){if(Ut&&typeof(self==null?void 0:self.postMessage)=="function"){self.postMessage({type:"loadingPreview"});return}Yn==null||Yn.previewFlash()}function Vi(e={}){const t=typeof e.durationMs=="number"?e.durationMs:Ko,o=typeof e.title=="string"?e.title:Yr,l=typeof e.objective=="string"?e.objective:Ur,a=!!e.instantBackdrop;if(Ut||typeof document>"u"||t<=0)return()=>{};Xr(t);const y=1.7,i=document.createElement("div");Object.assign(i.style,{position:"fixed",inset:0,display:"flex",alignItems:"flex-start",justifyContent:"center",background:"rgba(0,0,0,0.35)",opacity:"0",pointerEvents:"none",zIndex:1e4,transition:"opacity 0.35s ease"}),a&&(i.style.opacity="1",i.style.transition="none");const u=document.createElement("div");Object.assign(u.style,{marginTop:"10vh",padding:"16px 26px",border:"1px solid #0f0",background:"rgba(0,0,0,0.75)",color:"#0f0",font:"16px/1.4 monospace",letterSpacing:"0.06em",textTransform:"uppercase",textAlign:"center",opacity:"0",transform:`translateY(-24px) scale(${y})`,transformOrigin:"top center",transition:"transform 0.45s ease, opacity 0.45s ease"});const S=document.createElement("div");S.textContent=o,S.style.fontSize="18px",S.style.marginBottom="6px";const w=document.createElement("div");w.textContent=l,w.style.fontSize="13px",u.appendChild(S),u.appendChild(w),i.appendChild(u),document.body.appendChild(i),requestAnimationFrame(()=>{a||(i.style.opacity="1"),u.style.opacity="1",u.style.transform=`translateY(0) scale(${y})`});const Z=Math.max(0,t-700),d=setTimeout(()=>{u.style.opacity="0",u.style.transform=`translateY(-24px) scale(${y})`,i.style.opacity="0"},Z),E=setTimeout(()=>{typeof i.remove=="function"?i.remove():i.parentNode&&i.parentNode.removeChild(i)},t+300);return()=>{clearTimeout(d),clearTimeout(E),typeof i.remove=="function"?i.remove():i.parentNode&&i.parentNode.removeChild(i)}}const Pr=(()=>{let e=!1;const t=[],o=l=>{for(e=!1;t.length&&!(l&&typeof l.timeRemaining=="function"&&l.timeRemaining()<=1);){const a=t.shift();try{a()}catch(y){console.warn("idle task error",y)}}t.length&&(e=!0,(typeof requestIdleCallback=="function"?requestIdleCallback:y=>setTimeout(()=>y({timeRemaining:()=>5}),0))(o))};return l=>{t.push(l),e||(e=!0,(typeof requestIdleCallback=="function"?requestIdleCallback:y=>setTimeout(()=>y({timeRemaining:()=>5}),0))(o))}})();if(!Un.prototype._uncullPatchApplied){const e=Un.prototype.loadAsync;Un.prototype.loadAsync=function(t,...o){return e.call(this,t,...o).then(l=>(l!=null&&l.scene&&l.scene.traverse(a=>{a.isMesh&&(a.frustumCulled=!1)}),l))},Un.prototype._uncullPatchApplied=!0}function su(){if(Ut||typeof globalThis>"u")return;const e=globalThis;e.dumpEnemyPaths=async()=>(console.warn("Enemy path capture is off. Set window.__CAPTURE_ENEMY_PATHS__ = true before loading to enable."),0),console.info("[dev] Enemy path capture OFF; set window.__CAPTURE_ENEMY_PATHS__ = true before load to record paths.")}su();if(Gc){const e=typeof document<"u"?document.getElementById("c"):null;e&&(e.width=innerWidth,e.height=innerHeight,e.style.width="100vw",e.style.height="100vh");let t=!1;const o=()=>{t||(t=!0,Ci=!1,console.warn("Render worker failed; falling back to main-thread render."),Hi&&Hi())};if(e!=null&&e.transferControlToOffscreen&&typeof Worker<"u")try{const l=e.transferControlToOffscreen(),a=new Worker("./render-worker.js",{type:"module"}),y=typeof devicePixelRatio=="number"?devicePixelRatio:1;a.postMessage({type:"init",canvas:l,size:{w:innerWidth,h:innerHeight},dpr:y},[l]),e.dataset.offscreen="1",Ci=!0,Uc=a;const i=[];let u=!1;const S=P=>{typeof queueMicrotask=="function"?queueMicrotask(P):Promise.resolve().then(P)},w=()=>{u=!1,i.length&&(a.postMessage({type:"inputBatch",events:i}),i.length=0)},Z=(P,V,k)=>{i.push({event:P,code:V,repeat:!!k}),u||(u=!0,S(w))},d=new Set,E=P=>{const V=P==null?void 0:P.code;if(!(!V||!Qo.has(V))){if(typeof P.preventDefault=="function"&&P.preventDefault(),V===Fi&&P.type==="keydown"&&!P.repeat){if(Kr())return;tu()}if(P.type==="keydown"){if(P.repeat||d.has(V))return;d.add(V)}else if(P.type==="keyup"){if(!d.has(V))return;d.delete(V)}else return;Z(P.type,V,P.repeat)}};window.addEventListener("keydown",E),window.addEventListener("keyup",E),window.addEventListener("blur",()=>{d.size&&(d.forEach(P=>{Z("keyup",P,!1)}),d.clear(),w())});let f={w:innerWidth,h:innerHeight,dpr:typeof devicePixelRatio=="number"?devicePixelRatio:1};const D=()=>{const P=typeof(e==null?void 0:e.getBoundingClientRect)=="function"?e.getBoundingClientRect():null,V=(P==null?void 0:P.width)||(e==null?void 0:e.clientWidth)||innerWidth,k=(P==null?void 0:P.height)||(e==null?void 0:e.clientHeight)||innerHeight;return{w:V,h:k}},W=(P=!1)=>{const{w:V,h:k}=D(),R=typeof devicePixelRatio=="number"?devicePixelRatio:1;!P&&V===f.w&&k===f.h&&R===f.dpr||(f={w:V,h:k,dpr:R},a.postMessage({type:"resize",size:{w:V,h:k},dpr:R}))};window.addEventListener("resize",W),typeof ResizeObserver<"u"&&e&&new ResizeObserver(W).observe(e),requestAnimationFrame(W),requestAnimationFrame(()=>W(!0)),setTimeout(()=>W(!0),250),setTimeout(()=>W(!0),1e3);let L=null,x=!1,N=null,$=!1;const M=()=>{x=!1,L&&(Ol(L),L=null)},ie=()=>{$=!1,N&&(Zl(N),N=null)};a.addEventListener("message",P=>{var k,R,g,B,me,U,H,C,c,Y;const V=P.data;if(V)if(V.type==="loadingProgress")Yn==null||Yn.setProgressFromCounts(V.loaded,V.total);else if(V.type==="loadingPreview")Yn==null||Yn.previewFlash();else if(V.type==="introStart")Xr(((k=V.payload)==null?void 0:k.durationMs)??Ko),Yn?Yn.finish(()=>Vi({...V.payload??{},instantBackdrop:!0})):Vi({...V.payload??{},instantBackdrop:!0});else if(V.type==="dialogue"){const q=V.payload??{},se=Number.isFinite(q.delayMs)?q.delayMs:0,ne=Number.isFinite(q.durationMs)?q.durationMs:Wi,fe=q.portraitSrc??"./textures/protag.png",De=q.textLines??["Everybody, stay alert!"];setTimeout(()=>{eo({id:q.id,portraitSrc:fe,textLines:De,durationMs:ne})},Math.max(0,se))}else if(V.type==="hud")L=V.state,x||(x=!0,requestAnimationFrame(M));else if(V.type==="gameOver"){const q=typeof((R=V.payload)==null?void 0:R.score)=="number"?V.payload.score:jo(),se=Ni((g=V.payload)==null?void 0:g.stats);Gi({titleText:"GAME OVER",scoreText:`SCORE ${q}`,statsLines:se,showRestart:!0})}else if(V.type==="missionComplete"){const q=typeof((B=V.payload)==null?void 0:B.score)=="number"?V.payload.score:jo(),se=!!((me=V.payload)!=null&&me.escortSurvived),ne=(U=V.payload)!=null&&U.stationBossDestroyed&&se?"MISSION COMPLETE":"MISSION ACCOMPLISHED",fe=Ni((H=V.payload)==null?void 0:H.stats),De=["./textures/red.png",se?"./textures/green.png":"./textures/green-gray.png","./textures/yellow.png"];Gi({titleText:ne,scoreText:`SCORE ${q}`,statsLines:fe,showRestart:!0,badgeSources:De})}else V.type==="diag"?(N=((C=V.payload)==null?void 0:C.lines)??[],$||($=!0,requestAnimationFrame(ie))):V.type==="log"?console.log("[render-worker]",...V.args??[]):V.type==="error"||V.type==="fatal"?(console.error("[render-worker error]",((c=V.error)==null?void 0:c.message)??V,((Y=V.error)==null?void 0:Y.stack)??""),o()):V.type==="pathsDump"||V.type==="ready"&&console.log("[render-worker] ready")}),a.addEventListener("error",P=>{console.error("[render-worker] uncaught error",(P==null?void 0:P.message)||P),o()})}catch(l){console.warn("Render worker init failed, using main thread",l),Ci=!1}else console.warn("OffscreenCanvas not supported; staying on main thread renderer.")}async function el(){var Ea,Pa,Aa,Ta,Ra,ri,Ca,li,za,ci,La,ui,ka,Ia,Ba,di,Oa,Wa,Fa;let e=!1,t=0,o=!1,l=!1,a=!1,y=!1,i=!0,u=0,S=!1,w=!1,d=3;const E=350,f=()=>i&&!a&&!y&&!e&&!o;let D=null,W=null,L=null;const x={allowFire:!0},N=new n,$=(s,v)=>{var F;(F=s==null?void 0:s.userData)!=null&&F.dropHealRing&&(s.userData.dropHealRing=!1,L!=null&&L.spawnHealRingAt&&(v?(N.copy(v),L.spawnHealRingAt(N)):s.getWorldPosition&&(s.getWorldPosition(N),L.spawnHealRingAt(N))))};function M(){return{update:(s,v)=>{Er(s,v)},remove:()=>{Er(1,1)}}}function ie(s,v,F){const Q=new Set;v.traverse(Ge=>{!Ge.isMesh||!Ge.material||(Array.isArray(Ge.material)?Ge.material.forEach(It=>Q.add(It)):Q.add(Ge.material))});const re=new tn(1,1,1),He=new nr;Q.forEach(Ge=>{const It=new xe(re,Ge);It.visible=!0,He.add(It)}),s.compile(He,F)}async function P(){const s=M(),v=new zl;v.onProgress=(re,He,Ge)=>s.update(He,Ge);const F=new Un(v),Q=Array.from(new Set(["./models/player_starfighter_body_only.glb","./models/player_starfighter_v2.glb","./models/blue1.glb","./models/dark1.glb","./models/dark2.glb","./models/dark3.glb","./models/dark4_jet.glb","./models/dark_frigate.glb","./models/player_starfighter_l_wing_only.glb","./models/player_starfighter_r_wing_only.glb","./models/asteroid.glb","./models/asteroid_passage.glb","./models/asteroid_flat.glb","./models/drill_tunnel.glb","./models/bldg_step_up.glb","./models/bldg_bridge_dome.glb","./models/bldg_industry_stacks.glb","./models/bldg_tower_plat.glb","./models/bldg_asteroid_mine.glb","./models/bldg_mine_tower_front.glb","./models/bldg_mine_tower_back.glb","./models/bldg_mine_tunnel.glb","./models/bldg_triple_tower_basic_new.glb","./models/bldg_mine_plat.glb","./models/asteroid_big_bulb.glb","./models/asteroid_miner.glb","./models/bldg_walk.glb","./models/bldg_energy_hub_basic_new.glb","./models/prop_door.glb","./models/station.glb","./models/turret.glb","./models/plat.glb","./models/boss_head.glb","./models/boss_eyes.glb","./models/boss_left_hand.glb","./models/boss_left_palm.glb","./models/boss_right_hand.glb","./models/boss_right_palm.glb","./models/pickup_bomb.glb"]));await Promise.all(Q.map(re=>F.loadAsync(re).catch(He=>{console.warn("Preload failed",re,He)}))),s.remove()}const[V,k,R]=await Promise.all([fetch("./scene/curve.json").then(s=>s.json()),fetch("./scene/spawns.json").then(s=>s.json()),fetch("./scene/enemy-paths-captured.json").then(s=>s.json()).catch(()=>({paths:[]}))]),g=(R==null?void 0:R.paths)??[],B=250,me=B*B;function U(s,v){const F=new Map;if(!Array.isArray(s)||!s.length||!g.length)return F;const Q=g.filter(He=>!v||He.model===v),re=new Set;return s.forEach((He,Ge)=>{let It=-1,Yt=1/0;for(let Pt=0;Pt<Q.length;Pt++){if(re.has(Pt))continue;const yn=Q[Pt];if(!yn.spawn)continue;const en=(yn.spawn.x??0)-He.x,an=(yn.spawn.y??0)-He.y,vn=(yn.spawn.z??0)-He.z,Ln=en*en+an*an+vn*vn;Ln<Yt&&(Yt=Ln,It=Pt)}if(It>=0&&Yt<=me){re.add(It);const yn=Q[It].samples??[],en=yn.length?yn[yn.length-1].t:0;F.set(Ge,{samples:yn,duration:en})}else console.warn("No baked path for spawn",He,"model",v)}),F}function H(){if(Ut){let v=globalThis.__OFFSCREEN_CANVAS??null;return!v&&typeof OffscreenCanvas<"u"&&(v=new OffscreenCanvas(innerWidth||800,innerHeight||600),globalThis.__OFFSCREEN_CANVAS=v),v&&typeof v.width>"u"&&(v.width=innerWidth||800,v.height=innerHeight||600),v}let s=document.getElementById("c");return(!s||s.dataset.offscreen==="1")&&(s=document.createElement("canvas"),s.id="c",s.style.display="block",document.body.prepend(s)),s}const C=H();if(!C){const s="No canvas available for renderer (worker)";throw Ut&&typeof(self==null?void 0:self.postMessage)=="function"&&self.postMessage({type:"fatal",error:{message:s}}),new Error(s)}Ut&&(typeof C.width!="number"&&(C.width=typeof innerWidth=="number"?innerWidth:800,C.height=typeof innerHeight=="number"?innerHeight:600),typeof C.style>"u"&&(C.style={width:"",height:""}));const c=new xl({canvas:C,antialias:!1,powerPreference:"high-performance"}),Y=1;let q=Math.min(typeof globalThis.devicePixelRatio=="number"?globalThis.devicePixelRatio:1,Y);c.setPixelRatio(q);let se=1;const ne=(s,v)=>{const F=Math.max(1,Math.floor(s*se)),Q=Math.max(1,Math.floor(v*se));c.setSize(F,Q,!Ut)};ne(innerWidth,innerHeight);const fe={w:0,h:0},De=()=>{if(!C)return null;if(Ut)return{w:C.width||innerWidth||800,h:C.height||innerHeight||600};const s=typeof C.getBoundingClientRect=="function"?C.getBoundingClientRect():null;return{w:(s==null?void 0:s.width)||C.clientWidth||innerWidth||800,h:(s==null?void 0:s.height)||C.clientHeight||innerHeight||600}},Me=(s=!1,v=null)=>{if(Ut&&!v)return;const F=v??De();if(!F)return;const Q=F.w,re=F.h;if(!Number.isFinite(Q)||!Number.isFinite(re)||Q<2||re<2)return;const He=Math.max(1,Math.round(Q)),Ge=Math.max(1,Math.round(re));if(!(!s&&He===fe.w&&Ge===fe.h)&&(fe.w=He,fe.h=Ge,ne(He,Ge),A)){const It=He/Ge;Math.abs(A.aspect-It)>1e-4&&(A.aspect=It,A.updateProjectionMatrix())}};let ge=null,Ae={w:typeof innerWidth=="number"&&innerWidth?innerWidth:800,h:typeof innerHeight=="number"&&innerHeight?innerHeight:600};const ye=()=>{var s,v;return Ut?(s=ge==null?void 0:ge.size)!=null&&s.w&&((v=ge==null?void 0:ge.size)!=null&&v.h)?ge.size:Ae!=null&&Ae.w&&(Ae!=null&&Ae.h)?Ae:{w:typeof innerWidth=="number"&&innerWidth?innerWidth:800,h:typeof innerHeight=="number"&&innerHeight?innerHeight:600}:De()},pe=()=>{const s=ye();s&&(Ae={w:s.w,h:s.h},Me(!0,s))};{const s=c.getContext(),v=s.getExtension("WEBGL_debug_renderer_info"),F=v&&s.getParameter(v.UNMASKED_RENDERER_WEBGL)||"";/intel/i.test(F)&&(vr=!0,se=.65,xr=!1,K=!0,q=Math.min(q,.55),c.setPixelRatio(q),ne(innerWidth,innerHeight),console.warn("[preset] laptop preset applied (Intel GPU detected)"))}"outputColorSpace"in c&&(c.outputColorSpace=tr);function Ee(){C&&Me(!0)}Ut||(window.addEventListener("resize",Ee),typeof ResizeObserver<"u"&&new ResizeObserver(Ee).observe(C),requestAnimationFrame(Ee));const X=new nr;X.fog=new Ml(0,2e-4);{const s=Mn.degToRad(180),v=new _l(c);v.compileEquirectangularShader();const F=re=>{if(!re)return;console.log("[sky] applying sky texture"),"colorSpace"in re&&(re.colorSpace=tr),re.mapping=Cl,X.background=re;const He=v.fromEquirectangular(re);X.environment=He.texture,X.backgroundRotation&&X.backgroundRotation.set(0,s,0),X.environmentRotation&&X.environmentRotation.set(0,s,0),v.dispose()},Q="./textures/sky/space_4k.jpg";Ut&&typeof fetch=="function"&&typeof createImageBitmap=="function"?(console.log("[sky] worker fetch+bitmap path",Q),fetch(Q).then(re=>re.blob()).then(re=>createImageBitmap(re,{imageOrientation:"flipY"})).then(re=>{const He=new Sl(re);He.needsUpdate=!0,F(He)}).catch(re=>{console.warn("Sky fetch->bitmap failed, falling back to TextureLoader",re),new sr().load(Q,F,void 0,He=>console.warn("Sky load failed",He))})):(console.log("[sky] TextureLoader path",Q),new sr().load(Q,F,void 0,re=>console.warn("Sky load failed",re)))}X.add(new El(8956671,526368,.6));const et=new Pl(16777215,1);et.position.set(60,80,40),X.add(et),Yl(X);const A=new Al(60,innerWidth/innerHeight,.1,4e3);pe();const ke=new so,Qe=new so;ke.add(Qe),Qe.add(A),A.position.set(0,2,-10),X.add(ke);const Oe=new Tl(V.points.map(s=>new n(s.x,s.y,s.z)),V.closed??!1,"catmullrom",V.tension??.5);X.add(new Ns(new Li().setFromPoints(Oe.getPoints(400)),new Br({color:16777215}))),await P(),pe(),c.render(X,A);const{group:Fe,update:qt}=await Nl(X,k.asteroid??[],"./models/asteroid.glb",{materialMode:"standard"});if(In&&Fe){const s=Array.isArray(k.asteroid)?k.asteroid:[];Fe.children.forEach((v,F)=>{v&&Ms(v,{group:"asteroid",index:F,ref:s[F]})})}const Gt=Array.isArray(k.asteroidPassage)?k.asteroidPassage:[k.asteroidPassage??{x:0,y:0,z:-320,scale:60}],vt=await Promise.all(Gt.map(s=>yi(X,{position:{x:s.x??0,y:s.y??0,z:s.z??0},rotation:Ei(s),scale:s.scale??30,materialMode:"lambert",cellSize:s.cellSize??"auto"}))),_t=vt[0]??null;In&&vt.forEach((s,v)=>{var Q;const F=(Q=s==null?void 0:s.getMesh)==null?void 0:Q.call(s);F&&Ms(F,{group:"asteroidPassage",index:v,ref:Gt[v]})});const Ct=Array.isArray(k.drillTunnel)?k.drillTunnel:[k.drillTunnel??{x:0,y:12,z:-180,scale:30}],bt=await Promise.all(Ct.map(s=>yi(X,{path:"./models/drill_tunnel.glb",position:{x:s.x??0,y:s.y??0,z:s.z??0},rotation:Ei(s),scale:s.scale??30,materialMode:"lambert",cellSize:s.cellSize??"auto"})));In&&bt.forEach((s,v)=>{var Q;const F=(Q=s==null?void 0:s.getMesh)==null?void 0:Q.call(s);F&&Ms(F,{group:"drillTunnel",index:v,ref:Ct[v]})});const Kt=Array.isArray(k.asteroidFlat)?k.asteroidFlat:[k.asteroidFlat??{x:0,y:-18,z:-180,scale:26}],Bt=await Promise.all(Kt.map(s=>(async()=>{var Q;const v=await yi(X,{path:"./models/asteroid_flat.glb",position:{x:s.x??0,y:s.y??0,z:s.z??0},rotation:Ei(s),scale:s.scale??26,materialMode:"lambert",cellSize:s.cellSize??"auto"}),F=(Q=v==null?void 0:v.getMesh)==null?void 0:Q.call(v);return F!=null&&F.userData&&typeof s.scale=="number"&&s.scale>=150&&(F.userData.laserCollisionEnabled=!1,F.userData.cullBehindZFactor=.5),F!=null&&F.userData&&Math.abs((s.x??0)-0)<.001&&Math.abs((s.y??0)- -139)<.001&&Math.abs((s.z??0)- -5990)<.001&&(F.userData.activateDist=800),v})()));In&&Bt.forEach((s,v)=>{var Q;const F=(Q=s==null?void 0:s.getMesh)==null?void 0:Q.call(s);F&&Ms(F,{group:"asteroidFlat",index:v,ref:Kt[v]})});const $t=new bn,Zt=new n,Ft=new n;function Ue(s){if(!s||(s.updateWorldMatrix(!0,!0),$t.setFromObject(s),$t.isEmpty()))return;$t.getCenter(Zt),$t.getSize(Ft);const v=Math.max(Ft.x,Ft.z)*.5;s.userData.gateCylinder={x:Zt.x,z:Zt.z,radius:v,minY:$t.min.y,maxY:$t.max.y}}const wt={step_up:"./models/bldg_step_up.glb",bridge_dome:"./models/bldg_bridge_dome.glb",industry_stacks:"./models/bldg_industry_stacks.glb",tower_plat:"./models/bldg_tower_plat.glb",asteroid_mine:"./models/bldg_asteroid_mine.glb",mine_tower_front:"./models/bldg_mine_tower_front.glb",mine_tower_back:"./models/bldg_mine_tower_back.glb",mine_tunnel:"./models/bldg_mine_tunnel.glb",triple_tower:"./models/bldg_triple_tower_basic_new.glb",mine_plat:"./models/bldg_mine_plat.glb",asteroid_big_bulb:"./models/asteroid_big_bulb.glb",asteroid_miner:"./models/asteroid_miner.glb",bldg_walk:"./models/bldg_walk.glb",energy_hub:"./models/bldg_energy_hub_basic_new.glb",prop_door:"./models/prop_door.glb"},tt=Array.isArray(k.buildings)?k.buildings:[],J=await Promise.all(tt.map(async s=>{var re;const v=s.path??wt[s.type]??wt[s.name]??wt[s.id]??"./models/bldg_step_up.glb",F=await yi(X,{path:v,position:{x:s.x??0,y:s.y??0,z:s.z??0},rotation:Ei(s),scale:s.scale??30,visible:s.visible??!0,materialMode:"lambert",cellSize:s.cellSize??"auto"}),Q=(re=F==null?void 0:F.getMesh)==null?void 0:re.call(F);if(Q!=null&&Q.userData&&(Q.userData.modelPath=v,Number.isFinite(s.activateDist)?Q.userData.activateDist=s.activateDist:Number.isFinite(s.renderDist)&&(Q.userData.activateDist=s.renderDist),v.endsWith("bldg_asteroid_mine.glb")&&(Q.userData.cullBehindZFactor=4),v.endsWith("asteroid_big_bulb.glb")&&(Q.userData.cullBehindZFactor=4),v.endsWith("bldg_walk.glb")&&(Q.userData.cullBehindZFactor=4),v.endsWith("bldg_energy_hub_basic_new.glb")&&(Q.userData.cullBehindZFactor=3,Q.userData.activateDist=800),v.endsWith("bldg_mine_tunnel.glb")&&(Q.userData.cullBehindZFactor=3,Q.userData.skipInsideCheck=!0),v.endsWith("bldg_mine_plat.glb")&&(Q.userData.cullBehindZFactor=1.25),v.endsWith("bldg_mine_tower_front.glb")&&(Q.userData.cullBehindZFactor=.5),v.endsWith("bldg_mine_tower_back.glb")&&(Q.userData.cullBehindZFactor=2.25),v.endsWith("bldg_triple_tower_basic_new.glb")&&(Q.userData.cullBehindZFactor=1.25),v.endsWith("prop_door.glb"))){const He=Number.isFinite(s.hp)?s.hp:5;Q.userData.destructible={hp:He},Q.userData.blink=()=>{if(!Q.userData._blinkMats){const Yt=[];Q.traverse(Pt=>{if(!Pt.isMesh||!Pt.material)return;(Array.isArray(Pt.material)?Pt.material:[Pt.material]).forEach(en=>{!en||!en.emissive||(en.userData||(en.userData={}),en.userData._origEmissive||(en.userData._origEmissive=en.emissive.clone()),Yt.push(en))})}),Q.userData._blinkMats=Yt}const It=Q.userData._blinkMats;It.forEach(Yt=>Yt.emissive.setRGB(1,0,0)),Q.userData._blinkTimer&&clearTimeout(Q.userData._blinkTimer),Q.userData._blinkTimer=setTimeout(()=>{It.forEach(Yt=>{var Pt;(Pt=Yt.userData)!=null&&Pt._origEmissive&&Yt.emissive.copy(Yt.userData._origEmissive)}),Q.userData._blinkTimer=null},150)},Q.userData.onDestroyed=Ge=>{Ge&&T.spawn(Ge)}}return Q!=null&&Q.userData&&Ue(Q),F}));In&&J.forEach((s,v)=>{var Q;const F=(Q=s==null?void 0:s.getMesh)==null?void 0:Q.call(s);F&&Ms(F,{group:"buildings",index:v,ref:tt[v]})}),[...vt,...bt,...Bt].forEach(s=>{var F;const v=(F=s==null?void 0:s.getMesh)==null?void 0:F.call(s);v!=null&&v.userData&&Ue(v)});const Ce=!0,ve=!0,_e=!1,Ie=!0,gt=[...bt,...Bt,...vt.slice(1),...J].filter(Boolean),ct=[_t,...gt].map(s=>s==null?void 0:s.collider).filter(Boolean),yt=[_t,...gt],Ke=yt,r=60,T=Co(X,{poolSize:30,baseSize:6}),I=Co(X,{poolSize:16,baseSize:18}),he=Co(X,{poolSize:8,baseSize:4}),de=Co(X,{poolSize:20,baseSize:6,colors:[5982780]}),oe=new n,at=[new n(12,6,-4),new n(-10,-6,8),new n(6,-4,-10)],nt=s=>{var v,F;return!!((v=s==null?void 0:s.userData)!=null&&v.largeExplosion||(F=s==null?void 0:s.userData)!=null&&F.androssPart)},dt=(s,v)=>{if(!s&&!v)return;const F=v!=null&&v.getWorldPosition?v.getWorldPosition(oe):s;F&&(nt(v)?I.spawn(F):T.spawn(F))},{mesh:ue,update:Vt,radius:St,startRoll:Et,isRolling:Lt,getRollDir:te,updateTrail:we,setEngineGlowScale:p}=await ql(Qe,{scene:X,explosionPool:he,materialMode:Gn}),h=await Promise.all((k.platform??[]).map(s=>tc(X,{playerObj:ue,camera:A,canFire:f,railCurve:Oe,spawn:s,materialMode:Gn})));let m=[],ae;const st=240,ot=()=>{var F;const s=(F=ae==null?void 0:ae.getMesh)==null?void 0:F.call(ae);if(!s)return;const v=s.getWorldPosition(new n);at.forEach((Q,re)=>{const He=v.clone().add(Q),Ge=()=>I.spawn(He);re===0?Ge():setTimeout(Ge,st*re)})};ae=await dc(X,{playerObj:ue,camera:A,onDestroyed:()=>{S=!0,Yo(),Ao(1e3),ot(),m.forEach(s=>{var F;((F=s.destroy)==null?void 0:F.call(s))&&(Ao(100),Yo())})}});const Ne=600,Be=[];function Ht(s){return s?(s.traverse(v=>{v.isMesh&&v.material&&(v.material.transparent=!1,v.material.opacity!==void 0&&(v.material.opacity=1))}),s.visible=!1,{mesh:s,active:!1}):null}Be.push(...vt.map(s=>Ht(s!=null&&s.getMesh?s.getMesh():null)).filter(Boolean),...bt.map(s=>Ht(s!=null&&s.getMesh?s.getMesh():null)).filter(Boolean),...Bt.map(s=>Ht(s!=null&&s.getMesh?s.getMesh():null)).filter(Boolean),Ht(ae.getMesh?ae.getMesh():null),...J.map(s=>Ht(s!=null&&s.getMesh?s.getMesh():null)).filter(Boolean));const je=new n;function be(){ue.getWorldPosition(je),Be.forEach(s=>{var He,Ge;if(!s)return;const v=s.mesh;if((He=v.userData)!=null&&He.dead){v.visible=!1,s.active=!1;return}const F=Math.abs(v.position.z-je.z),Q=((Ge=v.userData)==null?void 0:Ge.activateDist)??Ne,re=F<Q;re!==s.active&&(s.active=re,v.visible=re)})}const $e=ic(X,{smallCount:300,bigCount:60});X.userData.boltPool=$e,$e.prewarm&&$e.prewarm(c,A),m=await Promise.all((k.stationTurret??[]).map(s=>oc(X,{playerObj:ue,stationMesh:ae.getMesh(),camera:A,spawn:s,boltPool:$e,canFire:f,materialMode:Gn})));let G;G=await Jl(X,{spawn:k.boss,playerObj:ue,railCurve:Oe,playerSpeed:35,onDestroyed:(s={})=>{var F;s!=null&&s.noScore||(Yo(),Ao(500));const v=(F=G==null?void 0:G.getMesh)==null?void 0:F.call(G);v&&(v.getWorldPosition(oe),I.spawn(oe))},autoDespawnZ:-3205,canFire:f,materialMode:Gn}),G.prewarm&&G.prewarm(c,A);const Se=new n;function rt(){var F;if(y)return;y=!0,l=!1,o=!1,ts(),(F=D==null?void 0:D.clearInput)==null||F.call(D);const s=S&&w?"MISSION COMPLETE":"MISSION ACCOMPLISHED";setTimeout(()=>{es.endMs=Lo();const Q=Sr(es.endMs),re=Ni(Q),He=jo();if(Ut&&typeof(self==null?void 0:self.postMessage)=="function")self.postMessage({type:"missionComplete",payload:{score:He,stationBossDestroyed:S,escortSurvived:w,stats:Q}});else{const Ge=["./textures/red.png",w?"./textures/green.png":"./textures/green-gray.png","./textures/yellow.png"];Gi({titleText:s,scoreText:`SCORE ${He}`,statsLines:re,showRestart:!0,badgeSources:Ge})}},E)}const ce=await Hl(X,{playerObj:ue,boltPool:$e,railSpeed:35,canFire:f,onHeadDestroyed:rt,handCleanupDelay:350,materialMode:Gn,onDialogue:s=>{Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"dialogue",payload:s}):eo(s)},summonWave:()=>{},explosionPool:T});{const s=new n,v=new n,F=[],Q=[],re=[],He=[],Ge=[],It=3,Yt=(Ea=ce==null?void 0:ce.getRig)==null?void 0:Ea.call(ce);if(Yt&&c&&A){const Pt=Yt.visible,yn=Yt.position.clone(),en=Yt.quaternion.clone();Yt.visible=!0;const an=(Pa=ce.getHead)==null?void 0:Pa.call(ce),vn=((Aa=ce.getHands)==null?void 0:Aa.call(ce))??[];[(Ta=an==null?void 0:an.getMesh)==null?void 0:Ta.call(an),(Ra=an==null?void 0:an.getEyes)==null?void 0:Ra.call(an),(Ca=(ri=vn[0])==null?void 0:ri.getMesh)==null?void 0:Ca.call(ri),(za=(li=vn[0])==null?void 0:li.getPalm)==null?void 0:za.call(li),(La=(ci=vn[1])==null?void 0:ci.getMesh)==null?void 0:La.call(ci),(ka=(ui=vn[1])==null?void 0:ui.getPalm)==null?void 0:ka.call(ui)].filter(Boolean).forEach(ft=>{F.push([ft,ft.visible]),ft.visible=!0}),Yt.traverse(ft=>{Q.push([ft,ft.layers.mask]),ft.layers.set(It),ft.isMesh&&(re.push([ft,ft.frustumCulled]),ft.frustumCulled=!1)});const Hn=((Ia=an==null?void 0:an.getActiveBeams)==null?void 0:Ia.call(an))??[];Hn.length&&(A.getWorldPosition(s),A.getWorldDirection(v),Hn.forEach(ft=>{ft&&(He.push([ft,ft.visible,ft.position.clone(),ft.quaternion.clone(),ft.frustumCulled,ft.layers.mask]),ft.visible=!0,ft.frustumCulled=!1,ft.layers.set(It),ft.position.copy(s).addScaledVector(v,30),ft.quaternion.copy(A.quaternion))})),X.traverse(ft=>{ft.isLight&&(Ge.push([ft,ft.layers.mask]),ft.layers.enable(It))}),A.getWorldPosition(s),A.getWorldDirection(v),Yt.position.copy(s).addScaledVector(v,120),Yt.quaternion.copy(A.quaternion);const Qn=c.getRenderTarget(),Kn=A.layers.mask,$n=new ya(16,16);"outputColorSpace"in c&&c.outputColorSpace&&($n.texture.colorSpace=c.outputColorSpace),A.layers.set(It),c.setRenderTarget($n),c.render(X,A),(Oa=(di=(Ba=ce.getMissiles)==null?void 0:Ba.call(ce))==null?void 0:di.prewarm)==null||Oa.call(di,c,A,{layer:It}),c.setRenderTarget(Qn),$n.dispose(),A.layers.mask=Kn,Yt.visible=Pt,Yt.position.copy(yn),Yt.quaternion.copy(en),F.forEach(([ft,xn])=>{ft.visible=xn}),re.forEach(([ft,xn])=>{ft.frustumCulled=xn}),Q.forEach(([ft,xn])=>{ft.layers.mask=xn}),Ge.forEach(([ft,xn])=>{ft.layers.mask=xn}),He.forEach(([ft,xn,jn,ns,Ve,Ws])=>{ft.visible=xn,ft.position.copy(jn),ft.quaternion.copy(ns),ft.frustumCulled=Ve,ft.layers.mask=Ws})}}let ht=!1;const lt=((Wa=k.andross)==null?void 0:Wa.z)??-8500;function Dt(){var F,Q;if(a)return;a=!0,i=!1,l=!1,o=!1,u=typeof performance<"u"&&performance.now?performance.now():Date.now(),ts(),(F=D==null?void 0:D.clearInput)==null||F.call(D),ue!=null&&ue.visible&&(ue.getWorldPosition(Se),(Q=T==null?void 0:T.spawn)==null||Q.call(T,Se)),ue&&(ue.visible=!1,ue.userData.dead=!0),es.endMs=Lo();const s=Sr(es.endMs),v=Ni(s);Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"gameOver",payload:{score:jo(),stats:s}}):Gi({titleText:"GAME OVER",scoreText:`SCORE ${jo()}`,statsLines:v,showRestart:!0})}D=Vl(X,{bossMesh:G.getMesh(),damageBoss:G.damageBoss,stationMesh:ae.getMesh(),damageStation:ae.damageStation,bossHitR2:G.getRadiusSq(),androssParts:ce==null?void 0:ce.getEnemyParts,getEnemies:ni,camera:A,passageColliders:ct,onEnemyKilled:(s,v)=>{Yo(),dt(s,v),$(v,s)},onShotFired:()=>Qc(),onShotHit:_r,onAsteroidDestroyed:s=>{s&&de.spawn(s)}}),D.prewarm&&D.prewarm(c,A),D.prewarmDual&&D.prewarmDual(ue),ra(d),ue!=null&&ue.userData&&(ue.userData.onWingLost=()=>{D.resetUpgrades?D.resetUpgrades():(D.enableDual(!1),D.enableBlue&&D.enableBlue(!1))});const kt=(s=null)=>{var Q,re,He;if(!i||a||y)return;let v=null;if(s&&((Q=ue==null?void 0:ue.userData)!=null&&Q.applyWingDamage)&&(v=ue.userData.applyWingDamage(s)),ue!=null&&ue.userData){const Ge=Lo();ue.userData.lastHitAt=Ge,s&&(ue.userData.lastHitPoint||(ue.userData.lastHitPoint=new n),ue.userData.lastHitPoint.copy(s)),v&&(ue.userData.lastWingHit=v,ue.userData.lastWingHitAt=Ge)}const F=kl();(He=(re=ue.userData)==null?void 0:re.blink)==null||He.call(re),F<=0&&Dt()};ue!=null&&ue.userData&&(ue.userData.onHit=kt,ue.userData.dead=!1),L=await ec(X,{spawnArray:k.pickupDual??[],blueSpawnArray:k.pickupDualBlue??[],ringSpawnArray:k.pickupHealRing??[],wingRepairSpawnArray:k.pickupWingRepair??[],bombSpawnArray:k.pickupBomb??[],playerObj:ue,lasers:D,onBombPickup:(s=1)=>{Number.isFinite(s)&&(d=Math.max(0,d+s),ra(d))},onRingCollected:(s=1)=>{jc(s)}});const nn=Ul({asteroidGroup:Fe,laserSystem:D,stationMesh:ae.getMesh(),damageStation:ae.damageStation,enemyShips:ni,enemyLasers:Zi,androssBeams:()=>{var s,v,F;return((F=(s=ce==null?void 0:ce.getHead)==null?void 0:(v=s.call(ce)).getActiveBeams)==null?void 0:F.call(v))??[]},bossMesh:G.getMesh(),damageBoss:G.damageBoss,playerMesh:ue,playerRadius:St,asteroidPassage:_t,staticHazards:gt,hazardPlayerCollisionEnabled:Ce,hazardLaserCollisionEnabled:ve,hazardEnemyCollisionEnabled:_e,asteroidHazardCollisionEnabled:!1,isRolling:Lt,onLaserHit:()=>Ao(10),onPlayerHit:kt,onEnemyDestroyed:(s,v)=>{var Q;Yo();const F=((Q=v==null?void 0:v.userData)==null?void 0:Q.scoreValue)??100;Ao(F),dt(s,v),$(v,s)},onEnemyNeutralized:(s,v)=>{dt(s,v)},onShotHit:_r,onAsteroidDestroyed:s=>{s&&de.spawn(s)}}),pt=Object.create(null);let fn=!1,pn=0,Nt=0;const hn=12,En=-1;let ln=En;const mn="KeyA",Ss="KeyD",io="KeyW",ao="KeyS",Ys="KeyQ",ro="KeyE",ts=()=>{Object.keys(pt).forEach(s=>{pt[s]=!1}),fn=!1,ln=En},Us=s=>{const v=!!s;o!==v&&(o=v,o?Jr("PAUSED"):Ui(),ts())},os=60,Te=.1,ut=5,z=Te;let K=!0,Le=os,Re=performance.now();const it=()=>1e3/Le,At=.5,gn=Math.min(1,q);let j=gn;const mt=[],Ot=30;let Pn=null,Zn=null,is=0;function gs(s){if(((s==null?void 0:s.code)==="ShiftLeft"||(s==null?void 0:s.code)==="ShiftRight")&&(fn=!0),(s==null?void 0:s.code)===Fi&&!s.repeat){l&&!a&&!y&&!e&&!Kr()&&Us(!o),typeof s.preventDefault=="function"&&s.preventDefault();return}if((e||o||a||y)&&(s!=null&&s.code)&&Qo.has(s.code)){typeof s.preventDefault=="function"&&s.preventDefault();return}s!=null&&s.code&&Qo.has(s.code)&&typeof s.preventDefault=="function"&&s.preventDefault(),s.code===Zr&&!s.repeat&&d>0&&i&&D!=null&&D.fireBomb&&D.fireBomb(ue)&&(d=Math.max(0,d-1),ra(d)),!s.repeat&&(s.code===Ys||s.code===ro)&&Et(s.code===Ys?1:-1),!s.repeat&&(s.code===mn||s.code===Ss)&&(ln=s.code===mn?-1:1),pt[s.code]=!0}function ys(s){if(((s==null?void 0:s.code)==="ShiftLeft"||(s==null?void 0:s.code)==="ShiftRight")&&(fn=!1),(s==null?void 0:s.code)===Fi){typeof s.preventDefault=="function"&&s.preventDefault();return}if((e||o||a||y)&&(s!=null&&s.code)&&Qo.has(s.code)){typeof s.preventDefault=="function"&&s.preventDefault();return}s!=null&&s.code&&Qo.has(s.code)&&typeof s.preventDefault=="function"&&s.preventDefault(),pt[s.code]=!1}!Ut&&!In&&(addEventListener("keydown",gs),addEventListener("keyup",ys)),Ut&&(globalThis.__INPUT_HANDLER_READY__=!0,addEventListener("message",s=>{var F,Q;const v=s.data;v&&(v.type==="input"||v.type==="inputBatch"?(v.type==="input"?[v]:Array.isArray(v.events)?v.events:[]).forEach(He=>{if(!(He!=null&&He.event))return;const Ge={code:He.code,repeat:He.repeat};if(He.event==="keydown"?gs(Ge):He.event==="keyup"&&ys(Ge),!e&&!o&&!a&&!y&&He.code==="Space"){const It=new Event(He.event);Object.defineProperty(It,"code",{value:He.code}),Object.defineProperty(It,"repeat",{value:!!He.repeat}),self.dispatchEvent(It)}}):v.type==="resize"?(ge=v,(F=v==null?void 0:v.size)!=null&&F.w&&((Q=v==null?void 0:v.size)!=null&&Q.h)&&(Ae={w:v.size.w,h:v.size.h})):v.type==="dumpPaths"&&self.postMessage({type:"pathsDump",payload:{paths:jl}}))}));const ks=U(k.enemy??[],"./models/dark1.glb"),Bn=U(k.enemyBlue??[],"./models/blue1.glb"),Zs=U(k.enemyDiag??[],"./models/dark1.glb"),Es=U(k.enemyDiagRL??[],"./models/dark1.glb"),Ps=U(k.enemyZigzagWide??[],"./models/dark1.glb"),Qs=U(k.enemyZigzagTight??[],"./models/blue1.glb"),ei=U(k.enemyHoverBob??[],"./models/blue1.glb"),lo=U(k.enemySpiral??[],"./models/dark1.glb"),ds=U(k.enemySpider??[],"./models/dark3.glb"),js=U(k.enemyJet??[],"./models/dark4_jet.glb"),As=new Map,Dn=Ie,ws=Array.isArray(k.enemyFrigate)?k.enemyFrigate.length:0,on=ws?ws*6:0,Tn=await vs(X,{spawnArray:k.enemy??[],playerObj:ue,railCurve:Oe,playerSpeed:35,manualPoolSize:6,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark1.glb",behaviour:xs.straight,camera:A,materialMode:Gn,bakedPaths:ks,useBakedPaths:Dn,editorGroup:"enemy"}),sn=await vs(X,{spawnArray:k.enemyBlue??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/blue1.glb",behaviour:xs.corkscrew,camera:A,materialMode:Gn,bakedPaths:Bn,useBakedPaths:Dn,editorGroup:"enemyBlue"}),Qt=await vs(X,{spawnArray:k.enemyBlueStraight??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/blue1.glb",behaviour:xs.blueStraight,camera:A,materialMode:Gn,bakedPaths:As,useBakedPaths:!1,manualPoolSize:on,editorGroup:"enemyBlueStraight"}),zn=await vs(X,{spawnArray:k.enemyDiag??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark1.glb",behaviour:xs.diagLR,camera:A,materialMode:Gn,bakedPaths:Zs,useBakedPaths:Dn,editorGroup:"enemyDiag"}),_n=await vs(X,{spawnArray:k.enemyDiagRL??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark1.glb",behaviour:xs.diagRL,camera:A,materialMode:Gn,bakedPaths:Es,useBakedPaths:Dn,editorGroup:"enemyDiagRL"}),Rn=await vs(X,{spawnArray:k.enemyZigzagWide??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark1.glb",behaviour:xs.zigzagWide,camera:A,materialMode:Gn,bakedPaths:Ps,useBakedPaths:Dn,editorGroup:"enemyZigzagWide"}),Fn=await vs(X,{spawnArray:k.enemyZigzagTight??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/blue1.glb",behaviour:xs.zigzagTight,camera:A,materialMode:Gn,bakedPaths:Qs,useBakedPaths:Dn,editorGroup:"enemyZigzagTight"}),bs=await vs(X,{spawnArray:k.enemyHoverBob??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/blue1.glb",behaviour:xs.hoverBob,camera:A,materialMode:Gn,bakedPaths:ei,useBakedPaths:Dn,editorGroup:"enemyHoverBob"}),Is=await vs(X,{spawnArray:k.enemySpiral??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark1.glb",behaviour:xs.spiralIn,camera:A,materialMode:Gn,bakedPaths:lo,useBakedPaths:Dn,editorGroup:"enemySpiral"}),Ts=await vs(X,{spawnArray:k.enemySpider??[],playerObj:ue,railCurve:Oe,playerSpeed:35,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark3.glb",behaviour:xs.spiderTurret,camera:A,materialMode:Gn,bakedPaths:ds,useBakedPaths:Dn,editorGroup:"enemySpider"}),Rs=await vs(X,{spawnArray:k.enemyJet??[],playerObj:ue,railCurve:Oe,playerSpeed:60,boltPool:$e,canFire:f,hazardColliders:ct,hazardEntries:Ke,modelPath:"./models/dark4_jet.glb",behaviour:xs.jetArc,camera:A,materialMode:Gn,bakedPaths:js,useBakedPaths:Dn,editorGroup:"enemyJet"}),fs=await $l(X,{spawnArray:k.enemyFrigate??[],playerObj:ue,boltPool:$e,canFire:f,hazardEntries:Ke,spawnBlue:Qt.spawnManual,modelPath:"./models/dark_frigate.glb",materialMode:Gn,editorGroup:"enemyFrigate"});W=await Gl(X,{railCurve:Oe,playerObj:ue,laserSystem:D,enemySystem:Tn,enemyLasers:()=>$e.getActive(),enemyBoltPool:$e,explosionPool:T,playerSpeed:35,materialMode:Gn,onDialogue:s=>{Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"dialogue",payload:s}):eo(s)},onEscortOutcome:({survived:s}={})=>{w=!!s},spawn:{x:80,y:12,z:-3500},spawnTriggerZ:-3520});const ti=[Tn,sn,Qt,zn,_n,Rn,Fn,bs,Is,Ts,Rs,fs,...h,...m],co=[];function ni(){var F,Q;co.length=0,ti.forEach(re=>{var Ge;const He=(Ge=re.getActiveShips)==null?void 0:Ge.call(re);He&&He.length&&co.push(...He)});const s=(F=ae.getActiveShips)==null?void 0:F.call(ae);s!=null&&s.length&&co.push(...s);const v=(Q=ce==null?void 0:ce.getEnemyParts)==null?void 0:Q.call(ce);return v!=null&&v.length&&co.push(...v),co}function Zi(){return $e.getActive()}function Qi(s,v){Pn={dt:s,lines:v},Pr(()=>{if(!Pn)return;const{dt:F,lines:Q}=Pn;Pn=null,Ql(F,Q)})}function uo(s){Zn=s,Pr(()=>{if(Zn===null)return;const v=Zn;Zn=null,yt.forEach(F=>{var He;const Q=F!=null&&F.getMesh?F.getMesh():F==null?void 0:F.mesh;if(!Q)return;const re=r*(((He=Q.userData)==null?void 0:He.cullBehindZFactor)??1);Q.visible&&Q.position.z>v+re&&(Q.visible=!1)}),Be.forEach(F=>{var re;if(!(F!=null&&F.mesh))return;const Q=r*(((re=F.mesh.userData)==null?void 0:re.cullBehindZFactor)??1);F.mesh.visible&&F.mesh.position.z>v+Q&&(F.mesh.visible=!1,F.active=!1)}),L.idleCull&&L.idleCull(v)})}Tn.prewarm&&Tn.prewarm(c,A),Tn.prewarmRender&&Tn.prewarmRender(c,A),Tn.prewarmSpawn&&Tn.prewarmSpawn(c,A),[Tn,sn,Qt,zn,_n,Rn,Fn,bs,Is,Ts,Rs,fs,...h,...m,ae,L,W,G,ce].forEach(s=>s.prewarm&&s.prewarm(c,A)),[Tn,sn,Qt,zn,_n,Rn,Fn,bs,Is,Ts,Rs,fs].forEach(s=>s.prewarmRender&&s.prewarmRender(c,A)),[Tn,sn,Qt,zn,_n,Rn,Fn,bs,Is,Ts,Rs,fs].forEach(s=>s.prewarmSpawn&&s.prewarmSpawn(c,A));{const s=c.getSize(new Vn);c.setSize(256,256,!1),c.render(X,A),c.setSize(s.x,s.y,!1),pe()}{const s=[],v=[];Be.forEach(F=>{F!=null&&F.mesh&&(s.push([F.mesh,F.mesh.visible]),F.mesh.visible=!0,F.mesh.traverse(Q=>{Q.isMesh&&(v.push([Q,Q.frustumCulled]),Q.frustumCulled=!1)}))}),c.render(X,A),s.forEach(([F,Q])=>{F.visible=Q}),v.forEach(([F,Q])=>{F.frustumCulled=Q})}if((Fa=_t==null?void 0:_t.collider)!=null&&Fa.linecast){const s=new n(0,0,0),v=new n(0,0,-1);try{_t.collider.linecast(s,v,1)}catch{}}{const s=new n(0,-500,-500);T.spawn(s),T.update(.01,A),T.update(1,A),I.spawn(s),I.update(.01,A),I.update(1,A),he.spawn(s),he.update(.01,A),he.update(1,A),de.spawn(s),de.update(.01,A),de.update(1,A)}ie(c,X,A),T.prewarm&&T.prewarm(c,A),I.prewarm&&I.prewarm(c,A),he.prewarm&&he.prewarm(c,A),de.prewarm&&de.prewarm(c,A),[_t,...vt.slice(1),...bt,...Bt,...J].forEach(s=>(s==null?void 0:s.prewarm)&&s.prewarm(c,A));{const s=c.getSize(new Vn);c.setSize(128,128,!1),c.render(X,A),c.setSize(s.x,s.y,!1),pe()}const Bs=new n,xo=new n,Os=new n,Xs=new n,Mo=new n,Wo=new n,si=[Tn,sn,Qt,zn,_n,Rn,Fn,bs,Is,Ts,Rs,fs].filter(Boolean);let fo=!1,_o=null,Ks=null;function oi(){var an,vn,Ln,Hn,Qn,Kn,$n,ft,xn,jn,ns,Ve,Ws;const s=[],v=[];Be.forEach(Ye=>{Ye!=null&&Ye.mesh&&(s.push([Ye,Ye.mesh.visible,Ye.active]),Ye.active=!0,Ye.mesh.visible=!0,Ye.mesh.traverse(Tt=>{Tt.isMesh&&(v.push([Tt,Tt.frustumCulled]),Tt.frustumCulled=!1)}))}),A.getWorldPosition(Bs),A.getWorldDirection(xo),Os.copy(xo).cross(Xs.set(0,1,0)).normalize(),Xs.crossVectors(Os,xo).normalize(),Mo.copy(Bs).addScaledVector(xo,120);const F=18,Q=[],re=[];if(G!=null&&G.getMesh){const Ye=G.getMesh();Ye&&(Q.push([Ye,Ye.visible,Ye.position.clone(),Ye.quaternion.clone()]),Ye.visible=!0,Ye.position.copy(Mo),Ye.lookAt(Bs),Ye.traverse(Tt=>{Tt.isMesh&&(re.push([Tt,Tt.frustumCulled]),Tt.frustumCulled=!1)}))}const He=[],Ge=[],It=[],Yt=new Map,Pt=(an=ce==null?void 0:ce.getRig)==null?void 0:an.call(ce);if(Pt){He.push([Pt,Pt.visible,Pt.position.clone(),Pt.quaternion.clone()]),Pt.visible=!0,Pt.position.copy(Mo).addScaledVector(Os,F*.6),Pt.lookAt(Bs);const Ye=(vn=ce==null?void 0:ce.getHead)==null?void 0:vn.call(ce),Tt=((Ln=ce==null?void 0:ce.getHands)==null?void 0:Ln.call(ce))??[];[(Hn=Ye==null?void 0:Ye.getMesh)==null?void 0:Hn.call(Ye),(Qn=Ye==null?void 0:Ye.getEyes)==null?void 0:Qn.call(Ye),($n=(Kn=Tt[0])==null?void 0:Kn.getMesh)==null?void 0:$n.call(Kn),(xn=(ft=Tt[0])==null?void 0:ft.getPalm)==null?void 0:xn.call(ft),(ns=(jn=Tt[1])==null?void 0:jn.getMesh)==null?void 0:ns.call(jn),(Ws=(Ve=Tt[1])==null?void 0:Ve.getPalm)==null?void 0:Ws.call(Ve)].filter(Boolean).forEach(Nn=>{Ge.push([Nn,Nn.visible]),Nn.visible=!0}),Pt.traverse(Nn=>{if(!Nn.isMesh||!Nn.material)return;It.push([Nn,Nn.frustumCulled]),Nn.frustumCulled=!1,(Array.isArray(Nn.material)?Nn.material:[Nn.material]).forEach(On=>{On&&(Yt.has(On)||Yt.set(On,{opacity:On.opacity,transparent:On.transparent,depthWrite:On.depthWrite,color:On.color?On.color.clone():null,emissive:On.emissive?On.emissive.clone():null}),On.transparent=!0,On.opacity=.01,On.depthWrite=!1,On.needsUpdate=!0)})})}const yn=[],en=-((si.length-1)*F)*.5;return si.forEach((Ye,Tt)=>{if(!(Ye!=null&&Ye.previewSetup))return;Wo.copy(Mo).addScaledVector(Os,en+Tt*F);const us=Ye.previewSetup({origin:Wo,right:Os,up:Xs,count:1,spacing:0,faceTarget:Bs});yn.push(us)}),()=>{yn.forEach(Ye=>Ye&&Ye()),s.forEach(([Ye,Tt,us])=>{Ye.mesh.visible=Tt,Ye.active=us}),v.forEach(([Ye,Tt])=>{Ye.frustumCulled=Tt}),Q.forEach(([Ye,Tt,us,Nn])=>{Ye.visible=Tt,Ye.position.copy(us),Ye.quaternion.copy(Nn)}),re.forEach(([Ye,Tt])=>{Ye.frustumCulled=Tt}),He.forEach(([Ye,Tt,us,Nn])=>{Ye.visible=Tt,Ye.position.copy(us),Ye.quaternion.copy(Nn)}),Ge.forEach(([Ye,Tt])=>{Ye.visible=Tt}),It.forEach(([Ye,Tt])=>{Ye.frustumCulled=Tt}),Yt.forEach((Ye,Tt)=>{Tt.opacity=Ye.opacity,Tt.transparent=Ye.transparent,Tt.depthWrite=Ye.depthWrite,Ye.color&&Tt.color&&Tt.color.copy(Ye.color),Ye.emissive&&Tt.emissive&&Tt.emissive.copy(Ye.emissive),Tt.needsUpdate=!0})}}function ji(){fo&&(fo=!1,_o&&(_o(),_o=null),In&&Array.isArray(Be)&&Be.forEach(s=>{s!=null&&s.mesh&&(s.mesh.visible=!0,s.active=!0)}),Ks&&(clearTimeout(Ks),Ks=null),pe(),Re=performance.now())}function Xi(){fo||(fo=!0,_o=oi(),pe(),c.render(X,A),nu(),Ks&&clearTimeout(Ks),Ks=setTimeout(ji,Vc+50))}Xi();function ii(s){const v=re=>re&&typeof re=="object"&&!Array.isArray(re)?`{ ${Object.keys(re).map(Ge=>`${JSON.stringify(Ge)}: ${v(re[Ge])}`).join(", ")} }`:Array.isArray(re)?re.length?`[ ${re.map(Ge=>v(Ge)).join(", ")} ]`:"[]":JSON.stringify(re),F=Object.keys(s),Q=["{"];return F.forEach((re,He)=>{const Ge=s[re],It=He<F.length-1?",":"";if(Array.isArray(Ge)){if(!Ge.length){Q.push(`  ${JSON.stringify(re)}: []${It}`);return}Q.push(`  ${JSON.stringify(re)}: [`),Ge.forEach((Yt,Pt)=>{const yn=Pt<Ge.length-1?",":"";Q.push(`    ${v(Yt)}${yn}`)}),Q.push(`  ]${It}`)}else Q.push(`  ${JSON.stringify(re)}: ${v(Ge)}${It}`)}),Q.push("}"),Q.join(`
`)+`
`}function _(){if(!In||Ut||typeof document>"u")return!1;Array.isArray(Be)&&Be.forEach(O=>{O!=null&&O.mesh&&(O.mesh.visible=!0,O.active=!0)}),A.parent&&A.parent.remove(A),X.add(A),A.position.set(0,45,140),A.lookAt(0,0,-600);const s=new bc(A,c.domElement);s.enableDamping=!0,s.dampingFactor=.08,s.screenSpacePanning=!0;const v=new zc(A,c.domElement);v.setMode("translate"),v.setSpace("world"),X.add(v),v.addEventListener("dragging-changed",O=>{s.enabled=!O.value});const F=document.createElement("div");Object.assign(F.style,{position:"fixed",right:"12px",top:"12px",padding:"10px 12px",border:"1px solid #0f0",background:"rgba(0,0,0,0.7)",color:"#0f0",font:"12px/1.4 monospace",letterSpacing:"0.04em",textTransform:"uppercase",zIndex:1e4,minWidth:"220px"});const Q=document.createElement("div");Q.textContent="Level Editor",Q.style.fontSize="13px",Q.style.marginBottom="6px";const re=document.createElement("div"),He=document.createElement("div"),Ge=(O,Pe=.1)=>{const Mt=document.createElement("input");return Mt.type="number",Mt.step=String(Pe),Mt.placeholder=O,Object.assign(Mt.style,{width:"62px",background:"rgba(0,0,0,0.55)",color:"#0f0",border:"1px solid rgba(0,255,0,0.4)",font:"11px monospace",padding:"2px 4px"}),Mt},It=O=>{const Pe=document.createElement("div");Object.assign(Pe.style,{display:"flex",alignItems:"center",gap:"4px",marginTop:"4px"});const Mt=document.createElement("span");return Mt.textContent=O,Mt.style.minWidth="42px",Pe.appendChild(Mt),Pe},Yt=It("Pos"),Pt=[Ge("X",.1),Ge("Y",.1),Ge("Z",.1)];Pt.forEach(O=>Yt.appendChild(O));const yn=It("Rot"),en=[Ge("XÂ°",1),Ge("YÂ°",1),Ge("ZÂ°",1)];en.forEach(O=>yn.appendChild(O));const an=It("Scale"),vn=Ge("S",.01);an.appendChild(vn);const Ln=document.createElement("div");Ln.style.opacity="0.7",Ln.style.marginTop="6px";const Hn=document.createElement("div");Object.assign(Hn.style,{display:"flex",gap:"6px",marginTop:"6px"});const Qn=O=>{const Pe=document.createElement("button");return Pe.type="button",Pe.textContent=O,Object.assign(Pe.style,{padding:"2px 6px",border:"1px solid #0f0",background:"rgba(0,0,0,0.55)",color:"#0f0",font:"11px monospace",cursor:"pointer"}),Pe},Kn=Qn("Move [G]"),$n=Qn("Rotate [R]"),ft=Qn("Scale [S]");Hn.appendChild(Kn),Hn.appendChild($n),Hn.appendChild(ft);const xn=document.createElement("button");xn.type="button",xn.textContent="Save spawns.json",Object.assign(xn.style,{marginTop:"8px",padding:"4px 8px",border:"1px solid #0f0",background:"rgba(0,0,0,0.6)",color:"#0f0",font:"12px monospace",cursor:"pointer"});const jn=document.createElement("a");jn.href="#",jn.download="spawns.json",jn.style.display="none";const ns=document.createElement("button");ns.type="button",ns.textContent="Download spawns.json",Object.assign(ns.style,{marginTop:"6px",display:"none",border:"1px solid rgba(0,255,0,0.4)",background:"rgba(0,0,0,0.55)",color:"#0f0",font:"11px monospace",letterSpacing:"0.04em",padding:"4px 6px",textAlign:"center",cursor:"pointer"}),F.appendChild(Q),F.appendChild(re),F.appendChild(He),F.appendChild(Hn),F.appendChild(Yt),F.appendChild(yn),F.appendChild(an),F.appendChild(xn),F.appendChild(ns),F.appendChild(Ln),document.body.appendChild(F),document.body.appendChild(jn);let Ve=null,Ws="translate",Ye=!1,Tt=!1;const us=[],Nn=10;let Fo=null,On=null,$s=null;const fi=[],Ho=new wa,So=new Vn,$i=new kr,pi=new n,Ha=new n,Na=new n,qa=new Set(["asteroidPassage","drillTunnel","asteroidFlat","buildings","boss"]),qn=(O,Pe=3)=>{const Mt=Math.pow(10,Pe);return Math.round(O*Mt)/Mt},ps=O=>Mn.radToDeg(O??0),Eo=()=>{if(!Ve){re.textContent="Selected: none",He.textContent=`Mode: ${Ws==="translate"?"Move":Ws==="rotate"?"Rotate":"Scale"}`,Pt.forEach(rn=>{rn.value="",rn.disabled=!0}),en.forEach(rn=>{rn.value="",rn.disabled=!0}),vn.value="",vn.disabled=!0;return}const O=Ve.userData.editorRef,Pe=Ve.userData.editorGroup??"unknown",Mt=Ve.userData.editorIndex??"?";re.textContent=`Selected: ${Pe} #${Mt}`,Pt[0].value=String(qn(Ve.position.x)),Pt[1].value=String(qn(Ve.position.y)),Pt[2].value=String(qn(Ve.position.z)),en[0].value=String(qn(ps(Ve.rotation.x),2)),en[1].value=String(qn(ps(Ve.rotation.y),2)),en[2].value=String(qn(ps(Ve.rotation.z),2)),vn.value=String(qn(Ve.scale.x,3)),Pt.forEach(rn=>{rn.disabled=!1}),en.forEach(rn=>{rn.disabled=!1}),vn.disabled=!1,O&&typeof O=="object"&&(Ln.textContent="")},ho=O=>{Ws=O,v.setMode(O),He.textContent=`Mode: ${O==="translate"?"Move":O==="rotate"?"Rotate":"Scale"}`},Ji=O=>({obj:O,pos:O.position.clone(),rot:O.rotation.clone(),scale:O.scale.clone()}),al=(O,Pe)=>!O||!Pe?!1:O.position.distanceToSquared(Pe.pos)>1e-6||Math.abs(O.rotation.x-Pe.rot.x)>1e-5||Math.abs(O.rotation.y-Pe.rot.y)>1e-5||Math.abs(O.rotation.z-Pe.rot.z)>1e-5||Math.abs(O.scale.x-Pe.scale.x)>1e-5,ea=O=>{O!=null&&O.obj&&al(O.obj,O)&&(us.push(O),us.length>Nn&&us.shift())},rl=()=>{const O=us.pop();O!=null&&O.obj&&(O.obj.position.copy(O.pos),O.obj.rotation.copy(O.rot),O.obj.scale.copy(O.scale),O.obj.updateMatrixWorld(!0),v.updateMatrixWorld(!0),O.obj.userData.editorDirty=!0,hi(O.obj),Ve===O.obj&&Eo())},hi=O=>{if(!O)return;const Pe=O.userData.editorRef;if(!Pe||typeof Pe!="object")return;if(Pe.x=qn(O.position.x),Pe.y=qn(O.position.y),Pe.z=qn(O.position.z),typeof Pe.yaw=="number"){Pe.yaw=qn(O.rotation.y,4);return}(qa.has(O.userData.editorGroup)||Pe.rotation||Pe.rotationDeg)&&(Pe.rotationDeg?Pe.rotationDeg={x:qn(ps(O.rotation.x),2),y:qn(ps(O.rotation.y),2),z:qn(ps(O.rotation.z),2)}:Pe.rotation={x:qn(O.rotation.x,4),y:qn(O.rotation.y,4),z:qn(O.rotation.z,4)}),(qa.has(O.userData.editorGroup)||typeof Pe.scale=="number")&&(Pe.scale=qn(O.scale.x,3))},Ga=()=>{var Pe;new Set(ma).forEach(Mt=>{var rn;(rn=Mt==null?void 0:Mt.userData)!=null&&rn.editorDirty&&hi(Mt)}),(Pe=Ve==null?void 0:Ve.userData)!=null&&Pe.editorDirty&&hi(Ve)},ta=O=>{O!=null&&O.userData&&(O.userData.editorDirty=!0)},Va=()=>{if(!Ve)return;const O=(ml,gl)=>{const Xa=parseFloat(ml.value);return Number.isFinite(Xa)?Xa:gl},Pe=O(Pt[0],Ve.position.x),Mt=O(Pt[1],Ve.position.y),rn=O(Pt[2],Ve.position.z),No=O(en[0],ps(Ve.rotation.x)),Za=O(en[1],ps(Ve.rotation.y)),Qa=O(en[2],ps(Ve.rotation.z)),ja=Math.max(.001,O(vn,Ve.scale.x)),hl=Ji(Ve);Math.abs(Pe-Ve.position.x)<1e-6&&Math.abs(Mt-Ve.position.y)<1e-6&&Math.abs(rn-Ve.position.z)<1e-6&&Math.abs(No-ps(Ve.rotation.x))<.001&&Math.abs(Za-ps(Ve.rotation.y))<.001&&Math.abs(Qa-ps(Ve.rotation.z))<.001&&Math.abs(ja-Ve.scale.x)<1e-6||(Ve.position.set(Pe,Mt,rn),Ve.rotation.set(qs(No),qs(Za),qs(Qa)),Ve.scale.setScalar(ja),Ve.updateMatrixWorld(!0),v.updateMatrixWorld(!0),ta(Ve),ea(hl),na(),Eo())},na=()=>{Ve&&hi(Ve)},sa=O=>{Ve=O,Ve?(v.attach(Ve),v.visible=!0,v.enabled=!0):(v.detach(),v.visible=!1),Eo()},ll=()=>{fi.length=0,Array.from(new Set(ma)).forEach(Pe=>{Pe.traverse(Mt=>{Mt.isMesh&&fi.push(Mt)})})},cl=O=>{$s&&(URL.revokeObjectURL($s),$s=null),$s=URL.createObjectURL(O),jn.href=$s},Ya=()=>{Ga();const O=new Blob([ii(k)],{type:"application/json"});cl(O);const Pe=document.createElement("a");Pe.href=jn.href,Pe.download=jn.download||"spawns.json",Pe.style.display="none",document.body.appendChild(Pe),Pe.click(),Pe.remove()},Ua=async()=>{Ga();const O=JSON.stringify({spawns:k});Ln.textContent="Saving...";try{const Pe=await fetch("/__save_spawns",{method:"POST",headers:{"Content-Type":"application/json"},body:O});if(!Pe.ok)throw new Error(await Pe.text());Ln.textContent="Saved.",ns.style.display="none",$s&&(URL.revokeObjectURL($s),$s=null)}catch{Ln.textContent="Save failed. Click download.",ns.style.display="inline-block";try{Ya()}catch{}}};xn.addEventListener("click",Ua),ns.addEventListener("click",()=>{Ya()}),Kn.addEventListener("click",()=>ho("translate")),$n.addEventListener("click",()=>ho("rotate")),ft.addEventListener("click",()=>ho("scale"));const ul=O=>{if(O.button!==0||!fi.length)return;const Pe=c.domElement.getBoundingClientRect();So.x=(O.clientX-Pe.left)/Pe.width*2-1,So.y=-((O.clientY-Pe.top)/Pe.height)*2+1,Ho.setFromCamera(So,A);const Mt=Ho.intersectObjects(fi,!1);if(!Mt.length){sa(null);return}const rn=Mt[0].object.userData.__editorRoot??Mt[0].object;sa(rn),!(!Ve||Ws!=="translate"||Tt)&&(A.getWorldDirection(Na).normalize(),$i.setFromNormalAndCoplanarPoint(Na,Ve.position),Ho.ray.intersectPlane($i,pi)&&(Ha.copy(Ve.position).sub(pi),Fo=Ji(Ve),Ye=!0,s.enabled=!1))};c.domElement.addEventListener("pointerdown",ul);const dl=O=>{if(!Ye||!Ve)return;const Pe=c.domElement.getBoundingClientRect();So.x=(O.clientX-Pe.left)/Pe.width*2-1,So.y=-((O.clientY-Pe.top)/Pe.height)*2+1,Ho.setFromCamera(So,A),Ho.ray.intersectPlane($i,pi)&&(Ve.position.copy(pi).add(Ha),Ve.updateMatrixWorld(!0),v.updateMatrixWorld(!0),ta(Ve),na(),Eo())},fl=()=>{Ye&&(Ye=!1,s.enabled=!Tt,Fo&&(ea(Fo),Fo=null))};window.addEventListener("pointermove",dl),window.addEventListener("pointerup",fl);const pl=O=>{O.code==="KeyG"&&(O.preventDefault(),ho("translate")),O.code==="KeyR"&&(O.preventDefault(),ho("rotate")),O.code==="KeyS"&&!O.ctrlKey&&(O.preventDefault(),ho("scale")),O.code==="Escape"&&sa(null),O.code==="KeyZ"&&O.ctrlKey&&(O.preventDefault(),rl()),O.code==="KeyS"&&O.ctrlKey&&(O.preventDefault(),Ua())};if(window.addEventListener("keydown",pl),v.addEventListener("objectChange",()=>{ta(Ve),na(),Eo()}),v.addEventListener("dragging-changed",O=>{Tt=!!O.value,s.enabled=!O.value,O.value&&Ve?On=Ji(Ve):!O.value&&On&&(ea(On),On=null)}),[Tn,sn,Qt,zn,_n,Rn,Fn,bs,Is,Ts,Rs].forEach(O=>{var Mt;const Pe=(Mt=O==null?void 0:O.materializeSpawns)==null?void 0:Mt.call(O);Pe!=null&&Pe.length&&Pe.forEach(rn=>{var No;(No=rn==null?void 0:rn.userData)!=null&&No.editorRef&&Ms(rn,{group:rn.userData.editorGroup,index:rn.userData.editorIndex,ref:rn.userData.editorRef})})}),fs!=null&&fs.materializeSpawns){const O=fs.materializeSpawns();O==null||O.forEach(Pe=>{var Mt;(Mt=Pe==null?void 0:Pe.userData)!=null&&Mt.editorRef&&Ms(Pe,{group:Pe.userData.editorGroup,index:Pe.userData.editorIndex,ref:Pe.userData.editorRef})})}if(L!=null&&L.materializeAll){const O=L.materializeAll();O==null||O.forEach(Pe=>{var Mt;(Mt=Pe==null?void 0:Pe.userData)!=null&&Mt.editorRef&&Ms(Pe,{group:Pe.userData.editorGroup,ref:Pe.userData.editorRef})})}if(G!=null&&G.getMesh&&(k!=null&&k.boss)){const O=G.getMesh();O&&(O.visible=!0,Ms(O,{group:"boss",ref:k.boss}))}return m!=null&&m.length&&Array.isArray(k.stationTurret)&&m.forEach((O,Pe)=>{var rn;const Mt=(rn=O==null?void 0:O.getMesh)==null?void 0:rn.call(O);Mt&&(Mt.visible=!0,Ms(Mt,{group:"stationTurret",index:Pe,ref:k.stationTurret[Pe]}))}),h!=null&&h.length&&Array.isArray(k.platform)&&h.forEach((O,Pe)=>{var rn;const Mt=(rn=O==null?void 0:O.getMesh)==null?void 0:rn.call(O);Mt&&(Mt.visible=!0,Ms(Mt,{group:"platform",index:Pe,ref:k.platform[Pe]}))}),ll(),ho("translate"),Eo(),[...Pt,...en,vn].forEach(O=>{O.addEventListener("keydown",Pe=>{Pe.stopPropagation(),Pe.key==="Enter"&&(Pe.preventDefault(),Va())}),O.addEventListener("change",()=>Va())}),c.setAnimationLoop(()=>{ge!=null&&ge.size?(typeof ge.dpr=="number"&&(globalThis.devicePixelRatio=ge.dpr),Me(!0,ge.size),ge=null):Me(),s.update(),c.render(X,A)}),!0}const le=35/Oe.getLength(),b=1.25,ze=3,We=1.5,Xe=.55,zt=6,jt="KeyJ",Wt="KeyN",qe=220;let Je=1,Xt=1,An=!1,as=null,Ds=!1,xt=0;const Jt=120,ai=800,xa=s=>Math.max(0,Math.min(1,s)),po=s=>s*s*(3-2*s),Ki=s=>{if(!a)return 1;const v=s-u;if(v<=Jt)return 1;const F=xa((v-Jt)/ai);return 1-po(F)};Re=performance.now(),t=Re,e=!In&&Ko>0,e?Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"introStart",payload:{durationMs:Ko,title:Yr,objective:Ur}}):Yn?Yn.finish(()=>Vi({instantBackdrop:!0})):Vi({instantBackdrop:!0}):In&&Yn&&Yn.finish(()=>{}),l=!0;const un={hasPrev:!1,railPrevPos:new n,railPrevQuat:new Rt,railCurrPos:new n,railCurrQuat:new Rt,steerPrevPos:new n,steerPrevQuat:new Rt,steerCurrPos:new n,steerCurrQuat:new Rt,shipPrevQuat:new Rt,shipCurrQuat:new Rt},Ma=new n,_a=new n,Sa=new n;function tl(){un.railPrevPos.copy(ke.position),un.railPrevQuat.copy(ke.quaternion),un.steerPrevPos.copy(Qe.position),un.steerPrevQuat.copy(Qe.quaternion),ue&&un.shipPrevQuat.copy(ue.quaternion),un.hasPrev=!0}function nl(){un.railCurrPos.copy(ke.position),un.railCurrQuat.copy(ke.quaternion),un.steerCurrPos.copy(Qe.position),un.steerCurrQuat.copy(Qe.quaternion),ue&&un.shipCurrQuat.copy(ue.quaternion)}function sl(s){if(!un.hasPrev)return;const v=Mn.clamp(s,0,1);ke.position.lerpVectors(un.railPrevPos,un.railCurrPos,v),ke.quaternion.slerpQuaternions(un.railPrevQuat,un.railCurrQuat,v),Qe.position.lerpVectors(un.steerPrevPos,un.steerCurrPos,v),Qe.quaternion.slerpQuaternions(un.steerPrevQuat,un.steerCurrQuat,v),ue&&ue.quaternion.slerpQuaternions(un.shipPrevQuat,un.shipCurrQuat,v)}function ol(){un.hasPrev&&(ke.position.copy(un.railCurrPos),ke.quaternion.copy(un.railCurrQuat),Qe.position.copy(un.steerCurrPos),Qe.quaternion.copy(un.steerCurrQuat),ue&&ue.quaternion.copy(un.shipCurrQuat))}function il(s,v){var jn,ns;tl();const F=e;e=v-t<Ko,F&&!e&&(ts(),!In&&!_i&&!bo.has("intro-alert")&&(Ut&&typeof(self==null?void 0:self.postMessage)=="function"?(_i=-1,self.postMessage({type:"dialogue",payload:{id:"intro-alert",delayMs:Dr,durationMs:Wi,portraitSrc:"./textures/protag.png",textLines:["Everybody, stay alert!"]}})):_i=setTimeout(()=>{_i=null,!(a||y)&&eo({id:"intro-alert",portraitSrc:"./textures/protag.png",textLines:["Everybody, stay alert!"],durationMs:Wi})},Dr))),!In&&es.startMs===null&&!e&&(es.startMs=v);const Q=e||o||a||y,re=e||o||y?0:s,He=re*Ki(v),Ge=Q?null:pt[jt]?"boost":pt[Wt]?"brake":null,It=!Ds&&Xt>0;if(An=!!(Ge&&It),An?(as=Ge,Je=Ge==="boost"?We:Xe,Xt=Math.max(0,Xt-re/b),Xt===0&&(Ds=!0,An=!1,Je=1)):Je=1,!An&&Xt<1){const Ve=Ds?1:.66;Xt=Math.min(1,Xt+re/ze*Ve),Xt===1&&(Ds=!1,as=null)}p&&p(An?as==="boost"?2:.5:1),Bl(Xt,{active:An||Xt<.999||Ds,recharging:!An&&Xt<1,mode:as??"boost"}),xt=Math.min(1,xt+le*Je*He);const Pt=Oe.getPointAt(xt),yn=Oe.getPointAt(Math.min(1,xt+1e-4));ke.position.copy(Pt),ke.lookAt(yn);const en=Q?0:(pt[mn]?1:0)-(pt[Ss]?1:0),an=Q?0:(pt[io]?1:0)-(pt[ao]?1:0);if(Q||re===0)pn=0,Nt=0;else{const Ve=Math.min(1,hn*re);pn+=(en-pn)*Ve,Nt+=(an-Nt)*Ve}const vn=(pt[mn]?-1:0)+(pt[Ss]?1:0),Ln=!Q&&fn?vn!==0?Math.sign(vn):ln:0,Hn=(jn=ue==null?void 0:ue.userData)==null?void 0:jn.wingHpLeft,Qn=(ns=ue==null?void 0:ue.userData)==null?void 0:ns.wingHpRight,Kn=(typeof Hn=="number"&&Hn<=0?1:0)+(typeof Qn=="number"&&Qn<=0?1:0),$n=Kn>0?zt*Kn:0;Qe.position.y=Mn.clamp(Qe.position.y+Nt*30*re-$n*re,-35,35);let ft=45;if(Lt()){const Ve=te();ft*=en===Ve?1.3:.7}Qe.position.x=Mn.clamp(Qe.position.x+pn*ft*re,-35,35),Vt(pn,Nt,re,Ln),we&&we(re),ue.getWorldPosition(Ma);const xn=Ma.z;!In&&xn<=-5335&&!bo.has("heavy-fire")&&(Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"dialogue",payload:{id:"heavy-fire",portraitSrc:"./textures/yellow.png",textLines:["Heavy enemy fire ahead! Do a barrel roll! (Press Q/E)"]}}):eo({id:"heavy-fire",portraitSrc:"./textures/yellow.png",textLines:["Heavy enemy fire ahead! Do a barrel roll! (Press Q/E)"]})),!In&&xn<=-8400&&!bo.has("boss-8400")&&(Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"dialogue",payload:{id:"boss-8400",portraitSrc:"./textures/boss.png",textLines:["I will deal with these pestilent welps myself."]}}):eo({id:"boss-8400",portraitSrc:"./textures/boss.png",textLines:["I will deal with these pestilent welps myself."]})),!In&&xn<=-8600&&!bo.has("boss-8600")&&(Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"dialogue",payload:{id:"boss-8600",portraitSrc:"./textures/boss.png",textLines:["You will be destroyed."]}}):eo({id:"boss-8600",portraitSrc:"./textures/boss.png",textLines:["You will be destroyed."]})),!In&&xn<=-8200&&!bo.has("protag-ahead")&&(Ut&&typeof(self==null?void 0:self.postMessage)=="function"?self.postMessage({type:"dialogue",payload:{id:"protag-ahead",portraitSrc:"./textures/protag.png",textLines:["Something's up ahead. Looks different."]}}):eo({id:"protag-ahead",portraitSrc:"./textures/protag.png",textLines:["Something's up ahead. Looks different."]})),!ht&&xn<=lt&&(ce.activate(xt),ht=!0),uo(xn),be(),W==null||W.update(re,xt),x.allowFire=!Q&&i,D.update(re,ue,x),qt(re,A),nn.update(re),Tn.update(re,xt),sn.update(re,xt),Qt.update(re,xt),zn.update(re,xt),_n.update(re,xt),Rn.update(re,xt),Fn.update(re,xt),bs.update(re,xt),Is.update(re,xt),L.update(re,e?t:v),Ts.update(re,xt),Rs.update(re,xt),fs.update(re,xt),h.forEach(Ve=>Ve.update(re)),G.update(re,xt),ae.update(re,xt),m.forEach(Ve=>Ve.update(re)),$e.update(re),T.update(re,A),I.update(re,A),he.update(re,A),de.update(re,A),ce==null||ce.update(re,xt,xn,o)}if(In){_();return}c.setAnimationLoop(()=>{var en;if(ge!=null&&ge.size?(typeof ge.dpr=="number"&&(globalThis.devicePixelRatio=ge.dpr),Me(!0,ge.size),ge=null):Me(),fo){c.render(X,A);return}const s=performance.now(),v=s-Re,F=it();if(K&&v<F)return;v>qe&&(ts(),(en=D==null?void 0:D.clearInput)==null||en.call(D));const Q=v/1e3,re=K?Math.min(Q,F/1e3):Q,He=Math.min(Te,re);if(Re=K?s-v%F:s,mt.push(v),mt.length>Ot&&mt.shift(),mt.length===Ot){const an=mt.reduce((Kn,$n)=>Kn+$n,0)/mt.length,vn=1e3/Le,Ln=an>vn*1.05,Hn=an<vn*.9;xi=Ln?xi+1:0,Mi=Hn?Mi+1:0;const Qn=vr?.1:.05;xi>=3&&j>At?(j=Math.max(At,j-Qn),c.setPixelRatio(j),xi=0):Mi>=5&&j<gn&&(j=Math.min(gn,j+Qn),c.setPixelRatio(j),Mi=0)}is=Math.min(is+He,z);const Ge=1/Le;let It=s-is*1e3,Yt=0;for(;is>=Ge&&Yt<ut;)It+=Ge*1e3,il(Ge,It),is-=Ge,Yt++;nl();const Pt=is/Ge;sl(Pt),ke.getWorldDirection(Sa),A.getWorldPosition(_a),A.lookAt(_a.add(Sa)),c.render(X,A),ol();const yn=[K?`FPS cap: ${Math.round(Le)}`:"FPS cap: off",xr?"Toggle cap: unbound":"FPS cap locked (laptop preset)",`DRS: ${j.toFixed(2)}x`];if(globalThis.__DEBUG_WINGS__&&(ue!=null&&ue.userData)){const an=ue.userData.wingHpLeft??"?",vn=ue.userData.wingHpRight??"?",Ln=ue.userData.wingVariant??"?",Hn=ue.userData.lastWingHit??"none",Qn=ue.userData.lastWingHitAt??0,Kn=Qn?`${Math.max(0,s-Qn).toFixed(0)}ms`:"-",$n=ue.userData.lastHitAt??0,ft=$n?`${Math.max(0,s-$n).toFixed(0)}ms`:"-";yn.push(`Wing HP L/R: ${an}/${vn}  Variant: ${Ln}`),yn.push(`Last wing hit: ${Hn} (${Kn})`),yn.push(`Last hit age: ${ft}`)}Qi(Q,yn)})}Hi=()=>{try{el()}catch(e){console.error("Fallback main-thread run failed",e)}};Ut?el().then(()=>{self.postMessage&&self.postMessage({type:"ready"})}).catch(e=>{self.postMessage&&self.postMessage({type:"fatal",error:{message:e==null?void 0:e.message,stack:e==null?void 0:e.stack}})}):Ci||Hi();
//# sourceMappingURL=main-f158bbe7.js.map
